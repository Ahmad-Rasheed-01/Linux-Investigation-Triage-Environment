{% extends "base.html" %}

{% block title %}Analysis - {{ case.case_name }} - LITE{% endblock %}

{% block content %}
<div class="d-flex" id="wrapper">
    <!-- Sidebar -->
    <div class="bg-light border-end" id="sidebar-wrapper" style="min-height: 100vh; width: 280px;">
        <div class="sidebar-heading border-bottom bg-primary text-white p-3">
            <h6 class="mb-0">
                <i class="fas fa-search me-2"></i>Analysis Navigation
            </h6>
        </div>
        <div class="list-group list-group-flush">
            <!-- Overview Section -->
            <div class="list-group-item list-group-item-action bg-light p-0">
                <div class="nav-section-header p-3" data-bs-toggle="collapse" data-bs-target="#overviewSection" aria-expanded="true">
                    <i class="fas fa-chart-pie me-2"></i>
                    <strong>Overview</strong>
                    <i class="fas fa-chevron-down float-end mt-1"></i>
                </div>
                <div class="collapse show" id="overviewSection">
                    <a href="#" class="list-group-item list-group-item-action ps-4 nav-link active" data-section="overview-summary">
                        <i class="fas fa-chart-pie me-2"></i>Case Summary
                    </a>
                    <a href="#" class="list-group-item list-group-item-action ps-4 nav-link" data-section="artifacts">
                        <i class="fas fa-file-alt me-2"></i>Artifacts Overview
                    </a>
                    <a href="#" class="list-group-item list-group-item-action ps-4 nav-link" data-section="collection-logs">
                        <i class="fas fa-file-alt me-2"></i>Collection Logs
                    </a>
                </div>
            </div>
            
            <!-- System Information Section -->
            <div class="list-group-item list-group-item-action bg-light p-0">
                <div class="nav-section-header p-3" data-bs-toggle="collapse" data-bs-target="#systemSection" aria-expanded="false">
                    <i class="fas fa-server me-2"></i>
                    <strong>System Information</strong>
                    <i class="fas fa-chevron-down float-end mt-1"></i>
                </div>
                <div class="collapse" id="systemSection">
                    <a href="#" class="list-group-item list-group-item-action ps-4 nav-link" data-section="hardware">
                        <i class="fas fa-microchip me-2"></i>Hardware Info
                    </a>
                    <a href="#" class="list-group-item list-group-item-action ps-4 nav-link" data-section="environment">
                        <i class="fas fa-cog me-2"></i>Environment Variables
                    </a>
                </div>
            </div>
            
            <!-- Users Section -->
            <div class="list-group-item list-group-item-action bg-light p-0">
                <div class="nav-section-header p-3" data-bs-toggle="collapse" data-bs-target="#usersSection" aria-expanded="false">
                    <i class="fas fa-users me-2"></i>
                    <strong>Users</strong>
                    <i class="fas fa-chevron-down float-end mt-1"></i>
                </div>
                <div class="collapse" id="usersSection">
                    <a href="#" class="list-group-item list-group-item-action ps-4 nav-link" data-section="user-accounts">
                        <i class="fas fa-user me-2"></i>User Accounts
                    </a>
                    <a href="#" class="list-group-item list-group-item-action ps-4 nav-link" data-section="login-history">
                        <i class="fas fa-sign-in-alt me-2"></i>Login History
                    </a>
                    <a href="#" class="list-group-item list-group-item-action ps-4 nav-link" data-section="user-activity">
                        <i class="fas fa-user-clock me-2"></i>User Activity
                    </a>
                </div>
            </div>
            
            <!-- Processes Section -->
            <div class="list-group-item list-group-item-action bg-light p-0">
                <div class="nav-section-header p-3" data-bs-toggle="collapse" data-bs-target="#processesSection" aria-expanded="false">
                    <i class="fas fa-tasks me-2"></i>
                    <strong>Process & Service</strong>
                    <i class="fas fa-chevron-down float-end mt-1"></i>
                </div>
                <div class="collapse" id="processesSection">
                    <a href="#" class="list-group-item list-group-item-action ps-4 nav-link" data-section="processes-running">
                        <i class="fas fa-play me-2"></i>Running Processes
                    </a>
                    <a href="#" class="list-group-item list-group-item-action ps-4 nav-link" data-section="process-hunting">
                                <i class="fas fa-search me-2"></i>Process Hunting
                            </a>

                    <!-- <a href="#" class="list-group-item list-group-item-action ps-4 nav-link" data-section="process-tree">
                        <i class="fas fa-sitemap me-2"></i>Process Tree
                    </a> -->
                    <a href="#" class="list-group-item list-group-item-action ps-4 nav-link" data-section="services">
                        <i class="fas fa-cogs me-2"></i>Services
                    </a>
                    <a href="#" class="list-group-item list-group-item-action ps-4 nav-link" data-section="triggered-tasks">
                        <i class="fas fa-clock me-2"></i>Triggered Tasks
                    </a>
                </div>
            </div>
            
            <!-- Network Section -->
            <div class="list-group-item list-group-item-action bg-light p-0">
                <div class="nav-section-header p-3" data-bs-toggle="collapse" data-bs-target="#networkSection" aria-expanded="false">
                    <i class="fas fa-network-wired me-2"></i>
                    <strong>Network</strong>
                    <i class="fas fa-chevron-down float-end mt-1"></i>
                </div>
                <div class="collapse" id="networkSection">
                    <a href="#" class="list-group-item list-group-item-action ps-4 nav-link" data-section="network-connections">
                        <i class="fas fa-plug me-2"></i>Connections
                    </a>
                    <a href="#" class="list-group-item list-group-item-action ps-4 nav-link" data-section="network-interfaces">
                        <i class="fas fa-ethernet me-2"></i>Interfaces
                    </a>
                    <a href="#" class="list-group-item list-group-item-action ps-4 nav-link" data-section="network-ports">
                        <i class="fas fa-door-open me-2"></i>Open Ports
                    </a>
                    <a href="#" class="list-group-item list-group-item-action ps-4 nav-link" data-section="network-sockets">
                        <i class="fas fa-plug me-2"></i>Sockets
                    </a>
                    <a href="#" class="list-group-item list-group-item-action ps-4 nav-link" data-section="network-routing">
                        <i class="fas fa-route me-2"></i>Routing Table
                    </a>
                    <a href="#" class="list-group-item list-group-item-action ps-4 nav-link" data-section="network-config">
                        <i class="fas fa-network-wired me-2"></i>Configuration
                    </a>
                </div>
            </div>
            
            <!-- Logs Section -->
            <div class="list-group-item list-group-item-action bg-light p-0">
                <div class="nav-section-header p-3" data-bs-toggle="collapse" data-bs-target="#logsSection" aria-expanded="false">
                    <i class="fas fa-file-alt me-2"></i>
                    <strong>Logs</strong>
                    <i class="fas fa-chevron-down float-end mt-1"></i>
                </div>
                <div class="collapse" id="logsSection">
                    <a href="#" class="list-group-item list-group-item-action ps-4 nav-link" data-section="logs-system">
                        <i class="fas fa-clipboard-list me-2"></i>System Logs
                    </a>
                    <a href="#" class="list-group-item list-group-item-action ps-4 nav-link" data-section="auth-logs">
                        <i class="fas fa-shield-alt me-2"></i>Authentication
                    </a>
                    <a href="#" class="list-group-item list-group-item-action ps-4 nav-link" data-section="logs-kernel">
                        <i class="fas fa-microchip me-2"></i>Kernel
                    </a>
                    <a href="#" class="list-group-item list-group-item-action ps-4 nav-link" data-section="application-logs">
                        <i class="fas fa-code me-2"></i>Applications
                    </a>
                </div>
            </div>
            
            <!-- File System Section -->
            <div class="list-group-item list-group-item-action bg-light p-0">
                <div class="nav-section-header p-3" data-bs-toggle="collapse" data-bs-target="#filesystemSection" aria-expanded="false">
                    <i class="fas fa-folder me-2"></i>
                    <strong>File System</strong>
                    <i class="fas fa-chevron-down float-end mt-1"></i>
                </div>
                <div class="collapse" id="filesystemSection">
                    <a href="#" class="list-group-item list-group-item-action ps-4 nav-link" data-section="file-listing">
                        <i class="fas fa-list me-2"></i>File Listing
                    </a>
                    <a href="#" class="list-group-item list-group-item-action ps-4 nav-link" data-section="file-permissions">
                        <i class="fas fa-lock me-2"></i>Permissions
                    </a>
                    <a href="#" class="list-group-item list-group-item-action ps-4 nav-link" data-section="mount-points">
                        <i class="fas fa-hdd me-2"></i>Mount Points
                    </a>
                </div>
            </div>
            
            <!-- Software Section -->
            <div class="list-group-item list-group-item-action bg-light p-0">
                <div class="nav-section-header p-3" data-bs-toggle="collapse" data-bs-target="#softwareSection" aria-expanded="false">
                    <i class="fas fa-cube me-2"></i>
                    <strong>Software</strong>
                    <i class="fas fa-chevron-down float-end mt-1"></i>
                </div>
                <div class="collapse" id="softwareSection">
                    <a href="#" class="list-group-item list-group-item-action ps-4 nav-link" data-section="software-installed">
                        <i class="fas fa-download me-2"></i>Installed Packages
                    </a>
                    <a href="#" class="list-group-item list-group-item-action ps-4 nav-link" data-section="software-installations">
                        <i class="fas fa-history me-2"></i>Installations
                    </a>
                    <a href="#" class="list-group-item list-group-item-action ps-4 nav-link" data-section="software-upgradations">
                        <i class="fas fa-arrow-up me-2"></i>Upgradations
                    </a>
                    <a href="#" class="list-group-item list-group-item-action ps-4 nav-link" data-section="software-removal">
                        <i class="fas fa-trash me-2"></i>Removals
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Page Content -->
    <div id="page-content-wrapper" class="flex-grow-1">
        <!-- Top Bar -->
        <div class="bg-white border-bottom p-3">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <button class="btn btn-outline-secondary btn-sm me-3" id="menu-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h4 class="mb-0">
                        <i class="fas fa-search me-2"></i>{{ case.case_name }} Analysis
                    </h4>
                    <span class="badge bg-secondary ms-2">{{ case.case_id }}</span>
                </div>
                <div>
                    <!-- Search Bar -->
                    <div class="input-group" style="width: 300px;">
                        <input type="text" class="form-control" id="searchInput" placeholder="Search artifacts...">
                        <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <a href="{{ url_for('cases.view_case', case_id=case.case_id) }}" class="btn btn-outline-primary btn-sm me-2">
                        <i class="fas fa-folder me-1"></i>Case Details
                    </a>
                    <a href="{{ url_for('cases.list_cases') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left me-1"></i>Back to Cases
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="container-fluid p-4">
            <div id="content-area">
                <!-- Content will be loaded here dynamically -->
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Loading analysis data...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search Results Modal -->
<div class="modal fade" id="searchModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-search me-2"></i>Search Results
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="searchResults">
                    <!-- Search results will be displayed here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentSection = 'overview';
let sidebarCollapsed = false;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Check for saved section in localStorage
    const savedSection = localStorage.getItem('analysis-current-section');
    const defaultSection = 'overview-summary';
    const sectionToLoad = savedSection || defaultSection;
    
    // Load the saved or default section
    loadSection(sectionToLoad);
    
    // Set active nav link for the loaded section
    const activeNavLink = document.querySelector(`[data-section="${sectionToLoad}"]`);
    if (activeNavLink) {
        setActiveNavLink(activeNavLink);
        
        // Expand the parent section if needed
        const parentCollapse = activeNavLink.closest('.collapse');
        if (parentCollapse && !parentCollapse.classList.contains('show')) {
            const bsCollapse = new bootstrap.Collapse(parentCollapse, { show: true });
        }
    }
    
    // Setup navigation click handlers
    document.querySelectorAll('.nav-link[data-section]').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const section = this.getAttribute('data-section');
            if (section) {
                loadSection(section);
                setActiveNavLink(this);
            }
        });
    });
    
    // Setup sidebar toggle
    document.getElementById('menu-toggle').addEventListener('click', function() {
        toggleSidebar();
    });
    
    // Setup search
    document.getElementById('searchBtn').addEventListener('click', function() {
        performSearch();
    });
    
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });
    
    // Setup section header click handlers for collapse
    document.querySelectorAll('.nav-section-header').forEach(header => {
        header.addEventListener('click', function() {
            const icon = this.querySelector('.fa-chevron-down');
            setTimeout(() => {
                const isExpanded = this.getAttribute('aria-expanded') === 'true';
                icon.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(-90deg)';
            }, 10);
        });
    });
});

function loadSection(section) {
    currentSection = section;
    
    // Save current section to localStorage
    localStorage.setItem('analysis-current-section', section);
    
    const contentArea = document.getElementById('content-area');
    
    // Show loading spinner
    contentArea.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading ${section.replace('-', ' ')} data...</p>
        </div>
    `;
    
    // Fetch section data
    fetch(`/analysis/{{ case.case_id }}/data/${section}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderSectionContent(section, data.data);
            } else {
                showError(data.message || 'Failed to load section data');
            }
        })
        .catch(error => {
            console.error('Error loading section:', error);
            showError('Network error while loading data');
        });
}

function renderSectionContent(section, data) {
    const contentArea = document.getElementById('content-area');
    
    switch (section) {
        case 'overview-summary':
            renderOverview(data);
            break;
        case 'artifacts':
            renderArtifacts(data);
            break;
        case 'collection-logs':
            renderCollectionLogs(data);
            break;
        case 'hardware':
            renderHardware(data);
            break;
        case 'environment':
            renderEnvironment(data);
            break;
        case 'user-accounts':
            renderUserAccounts(data);
            break;
        case 'login-history':
            renderLoginHistory(data);
            break;
        case 'processes-running':
            renderProcesses(data);
            break;
        case 'process-hunting':
            renderProcessHunting(data);
            break;

        case 'services':
        case 'processes-services':
            renderServices(data);
            break;
        case 'triggered-tasks':
            renderTriggeredTasks(data);
            break;
        case 'network-interfaces':
            renderNetworkInterfaces(data);
            break;
        case 'network-connections':
            renderNetworkConnections(data);
            break;
        case 'network-routing':
            renderNetworkRouting(data);
            break;
        case 'network-ports':
            renderNetworkPorts(data);
            break;
        case 'network-sockets':
            renderNetworkSockets(data);
            break;
        case 'logs-system':
            renderSystemLogs(data);
            break;
        case 'auth-logs':
            renderAuthentication(data);
            break;
        case 'logs-kernel':
            renderKernelLogs(data);
            break;
        case 'software-installed':
            renderSoftwareInstalled(data);
            break;
        case 'software-installations':
            renderSoftwareInstallations(data);
            break;
        case 'software-upgradations':
            renderSoftwareUpgradations(data);
            break;
        case 'software-removal':
            renderSoftwareRemoval(data);
            break;
        default:
            renderGenericData(section, data);
    }
}

function renderOverview(data) {
    const contentArea = document.getElementById('content-area');
    const stats = data.statistics || {};
    const insights = data.key_insights || {};
    const security = data.security_findings || {};
    const system = data.system_overview || {};
    const timeline = data.timeline || [];
    
    contentArea.innerHTML = `
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="h4 mb-3">
                    <i class="fas fa-chart-pie me-2"></i>Case Summary
                </h2>
            </div>
        </div>
        
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-primary shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Artifacts</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">${stats.total_artifacts || 0}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-file-alt fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-success shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Total Size</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">${stats.total_size_gb || 0} GB</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-database fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-info shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Processed</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">${stats.processed_count || 0}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-warning shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Processing</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">${stats.processing_count || 0}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-spinner fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content Row -->
        <div class="row">
            <!-- Left Column -->
            <div class="col-lg-8">
                <!-- Case Information -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Case Information</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Case ID:</strong> {{ case.case_id }}</p>
                                <p><strong>Examiner:</strong> {{ case.examiner }}</p>
                                <p><strong>Status:</strong> 
                                    <span class="badge bg-{{ 'success' if case.status == 'active' else 'warning' }}">{{ case.status.title() }}</span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Created:</strong> {{ case.creation_date.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                                <p><strong>Incident Date:</strong> {{ case.incident_date.strftime('%Y-%m-%d') if case.incident_date else 'Not specified' }}</p>
                                <p><strong>OS:</strong> {{ case.operating_system or 'Not specified' }}</p>
                            </div>
                        </div>
                        {% if case.description %}
                        <div class="mt-3">
                            <strong>Description:</strong>
                            <p class="mt-2">{{ case.description }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- System Overview -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">System Overview</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Hostname:</strong> ${system.hostname || 'Unknown'}</p>
                                <p><strong>OS Version:</strong> ${system.os_version || 'Unknown'}</p>
                                <p><strong>Kernel:</strong> ${system.kernel_version || 'Unknown'}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Architecture:</strong> ${system.architecture || 'Unknown'}</p>
                                <p><strong>Uptime:</strong> ${system.uptime || 'Unknown'}</p>
                                <p><strong>Last Boot:</strong> ${system.last_boot || 'Unknown'}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Key Insights -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Key Investigation Insights</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="text-center">
                                    <i class="fas fa-users fa-2x text-info mb-2"></i>
                                    <h6>User Activity</h6>
                                    <p class="text-muted">Total Users: ${insights.user_activity?.total_users || 0}</p>
                                    <p class="text-muted">Privileged: ${insights.user_activity?.privileged_users || 0}</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center">
                                    <i class="fas fa-network-wired fa-2x text-success mb-2"></i>
                                    <h6>Network Activity</h6>
                                    <p class="text-muted">Connections: ${insights.network_activity?.active_connections || 0}</p>
                                    <p class="text-muted">Suspicious Ports: ${insights.network_activity?.suspicious_ports?.length || 0}</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center">
                                    <i class="fas fa-tasks fa-2x text-warning mb-2"></i>
                                    <h6>Process Analysis</h6>
                                    <p class="text-muted">Running: ${insights.process_analysis?.running_processes || 0}</p>
                                    <p class="text-muted">Suspicious: ${insights.process_analysis?.suspicious_processes?.length || 0}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column -->
            <div class="col-lg-4">
                <!-- Security Findings -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Security Assessment</h6>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-3">
                            <span class="badge bg-${security.threat_level === 'high' ? 'danger' : security.threat_level === 'medium' ? 'warning' : 'success'} fs-6">
                                ${(security.threat_level || 'low').toUpperCase()} THREAT LEVEL
                            </span>
                        </div>
                        
                        ${security.indicators && security.indicators.length > 0 ? `
                            <h6 class="text-muted mb-2">Security Indicators:</h6>
                            <ul class="list-unstyled">
                                ${security.indicators.map(indicator => `
                                    <li class="mb-2">
                                        <i class="fas fa-${indicator.severity === 'high' ? 'exclamation-triangle text-danger' : 
                                                            indicator.severity === 'medium' ? 'exclamation-circle text-warning' : 
                                                            'info-circle text-info'} me-2"></i>
                                        <small>${indicator.description}</small>
                                    </li>
                                `).join('')}
                            </ul>
                        ` : '<p class="text-muted">No specific security indicators detected.</p>'}
                    </div>
                </div>
                
                <!-- Artifact Categories -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Artifact Categories</h6>
                    </div>
                    <div class="card-body">
                        ${stats.categories && Object.keys(stats.categories).length > 0 ? 
                            Object.entries(stats.categories).map(([category, count]) => `
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="badge bg-secondary">${category}</span>
                                    <span class="fw-bold">${count}</span>
                                </div>
                            `).join('') : 
                            '<p class="text-muted">No categorized artifacts found.</p>'
                        }
                    </div>
                </div>
                
                <!-- Investigation Timeline -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Recent Timeline</h6>
                    </div>
                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                        ${timeline && timeline.length > 0 ? 
                            timeline.slice(-5).map(event => `
                                <div class="d-flex mb-3">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-${event.type === 'case_event' ? 'folder' : 'file'} text-primary"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-1">${event.event}</h6>
                                        <p class="text-muted mb-1">${event.description}</p>
                                        <small class="text-muted">${new Date(event.timestamp).toLocaleString()}</small>
                                    </div>
                                </div>
                            `).join('') : 
                            '<p class="text-muted">No timeline events available.</p>'
                        }
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recommendations -->
        ${security.recommendations && security.recommendations.length > 0 ? `
            <div class="row">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Investigation Recommendations</h6>
                        </div>
                        <div class="card-body">
                            <ul class="mb-0">
                                ${security.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        ` : ''}
    `;
}

function formatReleaseDate(versionString) {
    if (!versionString) return null;
    
    // Extract date from parentheses like (2025-06-25)
    const dateMatch = versionString.match(/\((\d{4}-\d{2}-\d{2})\)/);
    if (!dateMatch) return versionString;
    
    const dateStr = dateMatch[1];
    const date = new Date(dateStr);
    
    // Format as "January 20, 2025"
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    return date.toLocaleDateString('en-US', options);
}

function formatTimestamp(timestampString) {
    if (!timestampString) return null;
    
    // Parse timestamp format like 20250814_035525 (YYYYMMDD_HHMMSS)
    const match = timestampString.match(/^(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})(\d{2})$/);
    if (!match) return timestampString;
    
    const [, year, month, day, hour, minute, second] = match;
    const date = new Date(year, month - 1, day, hour, minute, second);
    
    // Format as "August 14, 2025 at 3:55:25 AM"
    const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
    const timeOptions = { hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true };
    return date.toLocaleDateString('en-US', dateOptions) + ' at ' + date.toLocaleTimeString('en-US', timeOptions);
}

function renderArtifacts(data) {
    const contentArea = document.getElementById('content-area');
    const systemInfo = data.system_info || {};
    const artifactInfo = data.artifact_info || {};
    const collectionInfo = systemInfo.collection_info || {};
    const platformInfo = systemInfo.platform_info || {};
    const timezoneInfo = systemInfo.timezone_info || {};
    const localeInfo = systemInfo.locale_info || {};
    
    let html = `
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="h4 mb-3">
                    <i class="fas fa-server me-2"></i>System Information Overview
                </h2>
                ${data.metadata_file ? `<p class="text-muted">Source: ${data.metadata_file}</p>` : ''}
            </div>
        </div>
    `;
    
    if (data.error) {
        html += `
            <div class="alert alert-warning" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${data.error}
            </div>
        `;
    } else {
        // Collection Information Card
        html += `
            <div class="row mb-4">
                <div class="col-lg-6 mb-4">
                    <div class="card shadow h-100">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-info-circle me-2"></i>Collection Information
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-sm-6 mb-3">
                                     <strong>Collected at:</strong><br>
                                     <span class="text-muted">${formatTimestamp(collectionInfo.timestamp) || 'Unknown'}</span>
                                 </div>
                                <div class="col-sm-6 mb-3">
                                    <strong>Hostname:</strong><br>
                                    <span class="text-primary fw-bold">${collectionInfo.hostname || 'Unknown'}</span>
                                </div>
                                <div class="col-sm-6 mb-3">
                                    <strong>SEA Version:</strong><br>
                                    <span class="text-muted">${collectionInfo.versionSEA || 'Unknown'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Platform Information Card -->
                <div class="col-lg-6 mb-4">
                    <div class="card shadow h-100">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-success">
                                <i class="fas fa-desktop me-2"></i>Platform Information
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-sm-6 mb-3">
                                    <strong>System:</strong><br>
                                    <span class="text-success fw-bold">${platformInfo.system || 'Unknown'}</span>
                                </div>
                                <div class="col-sm-6 mb-3">
                                    <strong>Architecture:</strong><br>
                                    <span class="text-muted">${platformInfo.machine || 'Unknown'}</span>
                                </div>
                                <div class="col-sm-6 mb-3">
                                    <strong>Release:</strong><br>
                                    <span class="text-muted small">${platformInfo.release || 'Unknown'}</span>
                                </div>
                                <div class="col-sm-6 mb-3">
                                     <strong>Release Date:</strong><br>
                                     <span class="text-muted small">${formatReleaseDate(platformInfo.version) || 'Unknown'}</span>
                                 </div>
                                <div class="col-12">
                                    <strong>Processor:</strong><br>
                                    <span class="text-muted small">${platformInfo.processor || 'Unknown'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mb-4">
                <!-- Timezone Information Card -->
                <div class="col-lg-6 mb-4">
                    <div class="card shadow h-100">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-warning">
                                <i class="fas fa-clock me-2"></i>Timezone Information
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-sm-6 mb-3">
                                    <strong>Timezone:</strong><br>
                                    <span class="text-warning fw-bold">${timezoneInfo.name || 'Unknown'}</span>
                                </div>
                                <div class="col-sm-6 mb-3">
                                    <strong>Offset:</strong><br>
                                    <span class="text-muted">${timezoneInfo.offset || 'Unknown'}</span>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Locale Information Card -->
                <div class="col-lg-6 mb-4">
                    <div class="card shadow h-100">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-info">
                                <i class="fas fa-globe me-2"></i>Locale Information
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-sm-6 mb-3">
                                    <strong>Language:</strong><br>
                                    <span class="text-info fw-bold">${localeInfo.language || 'Unknown'}</span>
                                </div>
                                <div class="col-sm-6 mb-3">
                                    <strong>Encoding:</strong><br>
                                    <span class="text-muted">${localeInfo.encoding || 'Unknown'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Uploaded Artifact Files -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-header py-3 d-flex justify-content-between align-items-center">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-file-upload me-2"></i>Uploaded Artifact Files (${artifactInfo.total_count || 0})
                            </h6>
                            <div class="text-muted small">
                                Total Size: ${(artifactInfo.total_size_mb || 0).toFixed(2)} MB
                            </div>
                        </div>
                        <div class="card-body">
                            ${artifactInfo.files && artifactInfo.files.length > 0 ? `
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Filename</th>
                                                <th>Category</th>
                                                <th>Size</th>
                                                <th>Records</th>
                                                <th>Status</th>
                                                <th>Upload Date</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${artifactInfo.files.map(file => `
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <i class="fas fa-file-alt text-muted me-2"></i>
                                                            <div>
                                                                <div class="fw-bold">${file.original_filename}</div>
                                                                <small class="text-muted">${file.filename}</small>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-secondary">${file.artifact_category || 'Other'}</span>
                                                    </td>
                                                    <td>
                                                        <span class="text-muted">${formatFileSize(file.file_size_bytes)}</span>
                                                    </td>
                                                    <td>
                                                        <span class="text-info">${file.record_count || 0}</span>
                                                    </td>
                                                    <td>
                                                        <span class="badge ${
                                                            file.processing_status === 'completed' ? 'bg-success' :
                                                            file.processing_status === 'processing' ? 'bg-warning' :
                                                            file.processing_status === 'error' ? 'bg-danger' : 'bg-secondary'
                                                        }">${file.processing_status}</span>
                                                        ${file.processing_error ? `<br><small class="text-danger">${file.processing_error}</small>` : ''}
                                                    </td>
                                                    <td>
                                                        <small class="text-muted">${file.upload_timestamp ? formatTimestamp(file.upload_timestamp) : 'Unknown'}</small>
                                                    </td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm" role="group">
                                                            <button type="button" class="btn btn-outline-primary" onclick="viewArtifact('${file.id}')" title="View Content">
                                                                <i class="fas fa-eye"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-outline-secondary" onclick="downloadArtifact('${file.id}')" title="Download">
                                                                <i class="fas fa-download"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : `
                                <div class="text-center py-4">
                                    <i class="fas fa-file-upload fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">No Artifact Files Uploaded</h5>
                                    <p class="text-muted">Upload artifact files to begin analysis</p>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
                </div>
            </div>
            
        `;
    }
    
    // Add Routing Table section if data is available
    if (routingTableData && routingTableData.length > 0) {
        html += `
            <div class="row mt-5 mb-4">
                <div class="col-12">
                    <h3 class="h5 mb-3">
                        <i class="fas fa-route me-2"></i>Routing Table
                    </h3>
                </div>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${routingTableData.length}</h5>
                            <p class="card-text">Total Routes</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${routingTableData.filter(r => r.flags.includes('G')).length}</h5>
                            <p class="card-text">Gateway Routes</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${routingTableData.filter(r => !r.flags.includes('G')).length}</h5>
                            <p class="card-text">Direct Routes</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${routingTableData.filter(r => r.destination === '0.0.0.0').length}</h5>
                            <p class="card-text">Default Routes</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Routing Table Filters -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">Search Routes</label>
                                    <input type="text" class="form-control" id="routeSearch" placeholder="Search by destination, gateway..." oninput="filterRoutes()">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Interface</label>
                                    <select class="form-select" id="interfaceFilter" onchange="filterRoutes()">
                                        <option value="">All Interfaces</option>
                                        ${[...new Set(routingTableData.map(r => r.interface))].map(iface => 
                                            `<option value="${iface}">${iface}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Route Type</label>
                                    <select class="form-select" id="routeTypeFilter" onchange="filterRoutes()">
                                        <option value="">All Types</option>
                                        <option value="default">Default Routes</option>
                                        <option value="gateway">Gateway Routes</option>
                                        <option value="direct">Direct Routes</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Flags</label>
                                    <select class="form-select" id="flagsFilter" onchange="filterRoutes()">
                                        <option value="">All Flags</option>
                                        <option value="U">Up (U)</option>
                                        <option value="G">Gateway (G)</option>
                                        <option value="H">Host (H)</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-secondary" onclick="clearRouteFilters()">
                                            <i class="fas fa-times me-1"></i>Clear
                                        </button>
                                        <button class="btn btn-outline-info" onclick="exportRoutes()">
                                            <i class="fas fa-download me-1"></i>Export
                                        </button>
                                        <span class="badge bg-primary align-self-center ms-2" id="routeCount">${routingTableData.length}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0" id="routingTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th onclick="sortRoutes('destination')" style="cursor: pointer;">
                                                Destination <i class="fas fa-sort ms-1"></i>
                                            </th>
                                            <th onclick="sortRoutes('gateway')" style="cursor: pointer;">
                                                Gateway <i class="fas fa-sort ms-1"></i>
                                            </th>
                                            <th onclick="sortRoutes('netmask')" style="cursor: pointer;">
                                                Netmask <i class="fas fa-sort ms-1"></i>
                                            </th>
                                            <th onclick="sortRoutes('flags')" style="cursor: pointer;">
                                                Flags <i class="fas fa-sort ms-1"></i>
                                            </th>
                                            <th onclick="sortRoutes('metric')" style="cursor: pointer;">
                                                Metric <i class="fas fa-sort ms-1"></i>
                                            </th>
                                            <th onclick="sortRoutes('interface')" style="cursor: pointer;">
                                                Interface <i class="fas fa-sort ms-1"></i>
                                            </th>
                                            <th>Type</th>
                                        </tr>
                                    </thead>
                                    <tbody>
        `;
        
        routingTableData.forEach(route => {
            const isDefaultRoute = route.destination === '0.0.0.0';
            const isGatewayRoute = route.flags.includes('G');
            const routeType = isDefaultRoute ? 'default' : isGatewayRoute ? 'gateway' : 'direct';
            const routeTypeBadge = isDefaultRoute ? 'bg-warning' : isGatewayRoute ? 'bg-success' : 'bg-info';
            const routeTypeText = isDefaultRoute ? 'Default' : isGatewayRoute ? 'Gateway' : 'Direct';
            
            html += `
                <tr class="route-row" 
                    data-destination="${route.destination}" 
                    data-gateway="${route.gateway}" 
                    data-netmask="${route.netmask}" 
                    data-flags="${route.flags}" 
                    data-metric="${route.metric}" 
                    data-interface="${route.interface}"
                    data-type="${routeType}">
                    <td>
                        <code>${route.destination}</code>
                    </td>
                    <td>
                        <code>${route.gateway}</code>
                    </td>
                    <td>
                        <code>${route.netmask}</code>
                    </td>
                    <td>
                        <span class="badge bg-secondary">${route.flags}</span>
                    </td>
                    <td>
                        ${route.metric}
                    </td>
                    <td>
                        <span class="badge bg-primary">${route.interface}</span>
                    </td>
                    <td>
                        <span class="badge ${routeTypeBadge}">${routeTypeText}</span>
                    </td>
                </tr>
            `;
        });
        
        html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Routing Table -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="fas fa-route me-2"></i>Routing Table
                                <span class="badge bg-primary ms-2" id="routeCount">${routingTableData ? routingTableData.length : 0}</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Filters -->
                            <div class="row g-3 mb-3">
                                <div class="col-md-3">
                                    <label for="routeSearch" class="form-label">Search</label>
                                    <input type="text" class="form-control" id="routeSearch" placeholder="Search routes..." oninput="filterRoutes()">
                                </div>
                                <div class="col-md-2">
                                    <label for="interfaceFilter" class="form-label">Interface</label>
                                    <select class="form-select" id="interfaceFilter" onchange="filterRoutes()">
                                        <option value="">All Interfaces</option>
                                        ${[...new Set(routingTableData ? routingTableData.map(route => route.interface || 'unknown') : [])]
                                            .filter(Boolean)
                                            .map(iface => `<option value="${iface}">${iface}</option>`)
                                            .join('')}
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="routeTypeFilter" class="form-label">Type</label>
                                    <select class="form-select" id="routeTypeFilter" onchange="filterRoutes()">
                                        <option value="">All Types</option>
                                        <option value="network">Network</option>
                                        <option value="host">Host</option>
                                        <option value="default">Default</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="flagsFilter" class="form-label">Flags</label>
                                    <select class="form-select" id="flagsFilter" onchange="filterRoutes()">
                                        <option value="">All Flags</option>
                                        <option value="u">Up (U)</option>
                                        <option value="g">Gateway (G)</option>
                                        <option value="h">Host (H)</option>
                                        <option value="d">Dynamic (D)</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-secondary" onclick="clearRouteFilters()">
                                            <i class="fas fa-times me-1"></i>Clear
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="exportRoutes()">
                                            <i class="fas fa-download me-1"></i>Export
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Table -->
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="routingTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th onclick="sortRoutes('destination')">Destination <i class="fas fa-sort ms-1"></i></th>
                                            <th onclick="sortRoutes('gateway')">Gateway <i class="fas fa-sort ms-1"></i></th>
                                            <th onclick="sortRoutes('netmask')">Netmask <i class="fas fa-sort ms-1"></i></th>
                                            <th onclick="sortRoutes('flags')">Flags <i class="fas fa-sort ms-1"></i></th>
                                            <th onclick="sortRoutes('metric')">Metric <i class="fas fa-sort ms-1"></i></th>
                                            <th onclick="sortRoutes('interface')">Interface <i class="fas fa-sort ms-1"></i></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${routingTableData && routingTableData.length > 0 ? routingTableData.map(route => {
                                            const destination = route.destination || '0.0.0.0';
                                            const gateway = route.gateway || '*';
                                            const netmask = route.netmask || '0.0.0.0';
                                            const flags = route.flags || '';
                                            const metric = route.metric || '0';
                                            const interface = route.interface || 'unknown';
                                            const type = destination === '0.0.0.0' ? 'default' : 
                                                      (flags.toLowerCase().includes('h') ? 'host' : 'network');
                                            
                                            return `
                                                <tr class="route-row" 
                                                    data-destination="${destination}" 
                                                    data-gateway="${gateway}" 
                                                    data-netmask="${netmask}" 
                                                    data-flags="${flags}" 
                                                    data-metric="${metric}" 
                                                    data-interface="${interface}" 
                                                    data-type="${type}">
                                                    <td><code>${destination}</code></td>
                                                    <td><code>${gateway}</code></td>
                                                    <td><code>${netmask}</code></td>
                                                    <td><span class="badge bg-secondary">${flags}</span></td>
                                                    <td>${metric}</td>
                                                    <td><span class="badge bg-info">${interface}</span></td>
                                                </tr>
                                            `;
                                        }).join('') : `
                                            <tr>
                                                <td colspan="6" class="text-center py-3">
                                                    <i class="fas fa-route fa-2x text-muted mb-2"></i>
                                                    <p class="text-muted mb-0">No routing table data available</p>
                                                </td>
                                            </tr>
                                        `}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Add Routing Table section if data is available
    if (routingTableData && routingTableData.length > 0) {
        html += `
            <div class="row mt-5 mb-4">
                <div class="col-12">
                    <h3 class="h5 mb-3">
                        <i class="fas fa-route me-2"></i>Routing Table (${routingTableData.length})
                    </h3>
                </div>
            </div>
            
            <!-- Routing Table Filters -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">Search Routes</label>
                                    <input type="text" class="form-control" id="routeSearch" placeholder="Search by IP, gateway, or interface..." oninput="filterRoutes()">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Interface</label>
                                    <select class="form-select" id="interfaceFilter" onchange="filterRoutes()">
                                        <option value="">All Interfaces</option>
                                        ${[...new Set(routingTableData.map(route => route.interface))]
                                            .map(iface => `<option value="${iface}">${iface}</option>`)
                                            .join('')}
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Route Type</label>
                                    <select class="form-select" id="routeTypeFilter" onchange="filterRoutes()">
                                        <option value="">All Types</option>
                                        <option value="default">Default</option>
                                        <option value="network">Network</option>
                                        <option value="host">Host</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Flags</label>
                                    <select class="form-select" id="flagsFilter" onchange="filterRoutes()">
                                        <option value="">All Flags</option>
                                        <option value="U">Up (U)</option>
                                        <option value="G">Gateway (G)</option>
                                        <option value="H">Host (H)</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-secondary" onclick="clearRouteFilters()">
                                            <i class="fas fa-times me-1"></i>Clear
                                        </button>
                                        <button class="btn btn-outline-info" onclick="exportRoutes()">
                                            <i class="fas fa-download me-1"></i>Export
                                        </button>
                                        <span class="badge bg-primary align-self-center ms-2" id="routeCount">${routingTableData.length}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0" id="routingTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th onclick="sortRoutes('destination')" style="cursor: pointer;">
                                                Destination <i class="fas fa-sort ms-1"></i>
                                            </th>
                                            <th onclick="sortRoutes('gateway')" style="cursor: pointer;">
                                                Gateway <i class="fas fa-sort ms-1"></i>
                                            </th>
                                            <th onclick="sortRoutes('netmask')" style="cursor: pointer;">
                                                Netmask <i class="fas fa-sort ms-1"></i>
                                            </th>
                                            <th onclick="sortRoutes('flags')" style="cursor: pointer;">
                                                Flags <i class="fas fa-sort ms-1"></i>
                                            </th>
                                            <th onclick="sortRoutes('metric')" style="cursor: pointer;">
                                                Metric <i class="fas fa-sort ms-1"></i>
                                            </th>
                                            <th onclick="sortRoutes('interface')" style="cursor: pointer;">
                                                Interface <i class="fas fa-sort ms-1"></i>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
`;

        routingTableData.forEach(route => {
            // Determine route type
            let routeType = 'network';
            if (route.destination === '0.0.0.0') {
                routeType = 'default';
            } else if (route.netmask === '255.255.255.255') {
                routeType = 'host';
            }
            
            // Create flag badges
            const flagsMap = {
                'U': { text: 'Up', class: 'success' },
                'G': { text: 'Gateway', class: 'primary' },
                'H': { text: 'Host', class: 'info' },
                'D': { text: 'Dynamic', class: 'warning' },
                'M': { text: 'Modified', class: 'danger' }
            };
            
            let flagsBadges = '';
            if (route.flags) {
                for (const flag of route.flags) {
                    if (flagsMap[flag]) {
                        flagsBadges += `<span class="badge bg-${flagsMap[flag].class} me-1" title="${flagsMap[flag].text}">${flag}</span>`;
                    } else {
                        flagsBadges += `<span class="badge bg-secondary me-1">${flag}</span>`;
                    }
                }
            }
            
            html += `
                <tr class="route-row" 
                    data-destination="${route.destination}" 
                    data-gateway="${route.gateway}" 
                    data-netmask="${route.netmask}" 
                    data-flags="${route.flags}" 
                    data-metric="${route.metric}" 
                    data-interface="${route.interface}"
                    data-type="${routeType}">
                    <td>
                        <code>${route.destination}</code>
                        ${routeType === 'default' ? '<span class="badge bg-warning ms-2">Default</span>' : ''}
                    </td>
                    <td>
                        <code>${route.gateway}</code>
                    </td>
                    <td>
                        <code>${route.netmask}</code>
                    </td>
                    <td>
                        ${flagsBadges || '<span class="text-muted">None</span>'}
                    </td>
                    <td>
                        ${route.metric}
                    </td>
                    <td>
                        <span class="badge bg-info">${route.interface}</span>
                    </td>
                </tr>
            `;
        });
        
        html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else if (dataSource.routingTableRaw) {
        html += `
            <div class="row mt-5 mb-4">
                <div class="col-12">
                    <h3 class="h5 mb-3">
                        <i class="fas fa-route me-2"></i>Routing Table
                    </h3>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-body text-center py-5">
                            <i class="fas fa-route fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted mb-3">No Routing Table Data Available</h5>
                            <p class="text-muted">Unable to parse routing table data from the uploaded artifacts.</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    contentArea.innerHTML = html;
}

function renderHardware(data) {
    const contentArea = document.getElementById('content-area');
    
    let html = `
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="h4 mb-3">
                    <i class="fas fa-server me-2"></i>System Details
                </h2>
            </div>
        </div>
    `;
    
    // Find CPU information data
    let cpuData = null;
    for (const [filename, fileData] of Object.entries(data || {})) {
        if (filename.includes('cpuInformation')) {
            cpuData = fileData;
            break;
        }
    }
    
    // Find memory information data
    let memoryData = null;
    for (const [filename, fileData] of Object.entries(data || {})) {
        if (filename.includes('memory_info')) {
            memoryData = fileData;
            break;
        }
    }
    
    if (cpuData && cpuData.cpu_info) {
        const cpuInfo = cpuData.cpu_info;
        const summary = cpuInfo.summary || {};
        const processors = cpuInfo.processors || [];
        
        // CPU Information Widget
        html += `
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-microchip me-2"></i>CPU Information
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <strong>Processor Model:</strong><br>
                                        <span class="text-primary fw-bold">${summary.model_name || 'Unknown'}</span>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Vendor:</strong><br>
                                        <span class="text-muted">${summary.vendor_id || 'Unknown'}</span>
                                    </div>
                                    <div class="mb-3">
                                        <strong>CPU Family:</strong><br>
                                        <span class="text-muted">${summary.cpu_family || 'Unknown'}</span>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <strong>Processor Count:</strong><br>
                                        <span class="text-success fw-bold">${summary.processor_count || 0} cores</span>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Cache Size:</strong><br>
                                        <span class="text-muted">${summary.cache_size || 'Unknown'}</span>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Model/Stepping:</strong><br>
                                        <span class="text-muted">${summary.model || 'Unknown'}/${summary.stepping || 'Unknown'}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- CPU Cores Details -->
                            ${processors.length > 0 ? `
                                <hr>
                                <h6 class="text-muted mb-3">CPU Cores Details</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Core</th>
                                                <th>Physical ID</th>
                                                <th>Core ID</th>
                                                <th>Frequency (MHz)</th>
                                                <th>Cache Size</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${processors.slice(0, 8).map(proc => `
                                                <tr>
                                                    <td><span class="badge bg-secondary">${proc.processor}</span></td>
                                                    <td>${proc.physical_id}</td>
                                                    <td>${proc.core_id}</td>
                                                    <td>${parseFloat(proc.cpu_MHz).toFixed(2)}</td>
                                                    <td>${proc.cache_size}</td>
                                                </tr>
                                            `).join('')}
                                            ${processors.length > 8 ? `
                                                <tr>
                                                    <td colspan="5" class="text-center text-muted">
                                                        <small>... and ${processors.length - 8} more cores</small>
                                                    </td>
                                                </tr>
                                            ` : ''}
                                        </tbody>
                                    </table>
                                </div>
                            ` : ''}
                            
                            <!-- Security Vulnerabilities -->
                            ${processors.length > 0 && processors[0].bugs ? `
                                <hr>
                                <h6 class="text-warning mb-3">
                                    <i class="fas fa-shield-alt me-2"></i>Security Vulnerabilities
                                </h6>
                                <div class="alert alert-warning">
                                    <small>
                                        <strong>Known CPU Bugs</strong><br>
                                        ${processors[0].bugs.split(' ').map(bug => `<span class="badge bg-warning text-dark me-1 mb-1">${bug}</span>`).join('')}
                                    </small>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Memory Information Widget
    if (memoryData && memoryData.entries) {
        const memInfo = memoryData.entries;
        const memTotal = memInfo.MemTotal ? memInfo.MemTotal.value : 0;
        const memFree = memInfo.MemFree ? memInfo.MemFree.value : 0;
        const memAvailable = memInfo.MemAvailable ? memInfo.MemAvailable.value : 0;
        const swapTotal = memInfo.SwapTotal ? memInfo.SwapTotal.value : 0;
        const swapFree = memInfo.SwapFree ? memInfo.SwapFree.value : 0;
        const cached = memInfo.Cached ? memInfo.Cached.value : 0;
        const buffers = memInfo.Buffers ? memInfo.Buffers.value : 0;
        
        const memUsed = memTotal - memFree;
        const memUsedPercent = memTotal > 0 ? ((memUsed / memTotal) * 100).toFixed(1) : 0;
        const swapUsed = swapTotal - swapFree;
        const swapUsedPercent = swapTotal > 0 ? ((swapUsed / swapTotal) * 100).toFixed(1) : 0;
        
        html += `
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-memory me-2"></i>Memory Information
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <strong>Total Memory</strong><br>
                                        <span class="text-primary fw-bold">${(memTotal / 1024).toFixed(2)} MB</span>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Used Memory</strong><br>
                                        <span class="text-warning fw-bold">${(memUsed / 1024).toFixed(2)} MB (${memUsedPercent}%)</span>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Free Memory</strong><br>
                                        <span class="text-success fw-bold">${(memFree / 1024).toFixed(2)} MB</span>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Available Memory</strong><br>
                                        <span class="text-info fw-bold">${(memAvailable / 1024).toFixed(2)} MB</span>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <strong>Cached Memory</strong><br>
                                        <span class="text-muted">${(cached / 1024).toFixed(2)} MB</span>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Buffers</strong><br>
                                        <span class="text-muted">${(buffers / 1024).toFixed(2)} MB</span>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Swap Total</strong><br>
                                        <span class="text-muted">${(swapTotal / 1024).toFixed(2)} MB</span>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Swap Used</strong><br>
                                        <span class="text-${swapUsedPercent > 50 ? 'danger' : 'muted'}">${(swapUsed / 1024).toFixed(2)} MB (${swapUsedPercent}%)</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Memory Usage Progress Bars -->
                            <hr>
                            <h6 class="text-muted mb-3">Memory Usage</h6>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="small">RAM Usage</span>
                                    <span class="small">${memUsedPercent}%</span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar ${memUsedPercent > 80 ? 'bg-danger' : memUsedPercent > 60 ? 'bg-warning' : 'bg-success'}" 
                                         style="width: ${memUsedPercent}%"></div>
                                </div>
                            </div>
                            ${swapTotal > 0 ? `
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="small">Swap Usage</span>
                                        <span class="small">${swapUsedPercent}%</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar ${swapUsedPercent > 50 ? 'bg-danger' : swapUsedPercent > 25 ? 'bg-warning' : 'bg-info'}" 
                                             style="width: ${swapUsedPercent}%"></div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    if (!cpuData && !memoryData) {
        html += `
            <div class="card shadow">
                <div class="card-body text-center py-5">
                    <i class="fas fa-server fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted mb-3">No Hardware Information Available</h5>
                    <p class="text-muted">No hardware data found in the uploaded artifacts.</p>
                </div>
            </div>
        `;
    }
    
    contentArea.innerHTML = html;
}

function renderEnvironment(data) {
    const contentArea = document.getElementById('content-area');
    
    let html = `
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="h4 mb-3">
                    <i class="fas fa-cog me-2"></i>Environment Variables
                </h2>
            </div>
        </div>
    `;
    
    // Find environment variables data
    let environmentData = null;
    
    for (const [filename, fileData] of Object.entries(data || {})) {
        if (filename.includes('environmentVariables') || filename.includes('environment')) {
            environmentData = fileData;
            break;
        }
    }
    
    if (environmentData && environmentData.variables) {
        const variables = environmentData.variables;
        const variableCount = Object.keys(variables).length;
        const timestamp = environmentData.timestamp;
        const command = environmentData.command_used || 'env';
        
        // Convert Unix timestamp to readable format if it's a number
        let formattedTimestamp = null;
        if (timestamp) {
            if (typeof timestamp === 'number') {
                const date = new Date(timestamp * 1000); // Convert to milliseconds
                const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
                const timeOptions = { hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true };
                formattedTimestamp = date.toLocaleDateString('en-US', dateOptions) + ' at ' + date.toLocaleTimeString('en-US', timeOptions);
            } else {
                formattedTimestamp = formatTimestamp(timestamp);
            }
        }
        
        // Automated Analysis
        const analysis = analyzeEnvironmentVariables(variables);
        
        // Statistics Cards
        html += `
            <div class="row mb-4 justify-content-center">
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${variableCount}</h5>
                            <p class="card-text">Total Variables</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${analysis.securityFindings.length}</h5>
                            <p class="card-text">Security Findings</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${analysis.pathAnalysis.customPaths.length}</h5>
                            <p class="card-text">Custom Paths</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Analysis Results
        if (analysis.securityFindings.length > 0) {
            html += `
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow">
                            <div class="card-header">
                                <h6 class="m-0 font-weight-bold text-primary">
                                    <i class="fas fa-search me-2"></i>Automated Analysis Results
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
            `;
            
            // Security Findings
            if (analysis.securityFindings.length > 0) {
                html += `
                    <div class="col-12">
                        <h6 class="text-warning mb-3"><i class="fas fa-shield-alt me-2"></i>Security Findings</h6>
                        <div class="alert alert-warning" role="alert">
                `;
                analysis.securityFindings.forEach((finding, index) => {
                    html += `
                            <div class="d-flex align-items-start mb-2 ${index < analysis.securityFindings.length - 1 ? 'border-bottom pb-2' : ''}">
                                <i class="fas fa-exclamation-triangle text-warning me-2 mt-1"></i>
                                <span class="text-dark">${finding}</span>
                            </div>
                    `;
                });
                html += `
                        </div>
                    </div>
                `;
            }
            

            
            html += `
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Environment Variables Table
        html += `
            <div class="card shadow">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-list me-2"></i>Environment Variables
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="environmentTable">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 8%;">Sr. No.</th>
                                    <th style="width: 22%;">Variable Name</th>
                                    <th style="width: 35%;">Description</th>
                                    <th style="width: 35%;">Value</th>
                                </tr>
                            </thead>
                            <tbody>
        `;
        
        // Sort variables alphabetically
        const sortedVariables = Object.entries(variables).sort(([a], [b]) => a.localeCompare(b));
        
        sortedVariables.forEach(([name, value], index) => {
            // Truncate very long values for display
            const displayValue = value && value.length > 100 ? value.substring(0, 100) + '...' : value;
            const fullValue = value || '';
            const description = getVariableDescription(name, value);
            
            html += `
                <tr>
                    <td class="text-center"><span class="badge bg-secondary">${index + 1}</span></td>
                    <td><strong>${name}</strong></td>
                    <td><small class="text-muted">${description}</small></td>
                    <td>
                        <span class="variable-value" title="${fullValue.replace(/"/g, '&quot;')}">
                            ${displayValue || '<em class="text-muted">empty</em>'}
                        </span>
                        ${value && value.length > 100 ? `
                            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="showFullValue('${name}', \`${fullValue.replace(/`/g, '\\`')}\`)">Show Full</button>
                        ` : ''}
                    </td>
                </tr>
            `;
        });
        
        html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    } else {
        html += `
            <div class="card shadow">
                <div class="card-body text-center py-5">
                    <i class="fas fa-cog fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted mb-3">No Environment Variables Available</h5>
                    <p class="text-muted">No environment variable data found in the uploaded artifacts.</p>
                </div>
            </div>
        `;
    }
    
    contentArea.innerHTML = html;
}

function renderUserAccounts(data) {
    const contentArea = document.getElementById('content-area');
    
    let html = `
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="h4 mb-3">
                    <i class="fas fa-users me-2"></i>User Accounts
                </h2>
            </div>
        </div>
        
        <!-- Password Status Guide -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white py-2">
                        <h6 class="m-0">
                            <i class="fas fa-info-circle me-2"></i>Password Status Guide
                            <button class="btn btn-sm btn-outline-light float-end" type="button" data-bs-toggle="collapse" data-bs-target="#passwordGuide" aria-expanded="false">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </h6>
                    </div>
                    <div class="collapse" id="passwordGuide">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary"><i class="fas fa-key me-2"></i>Common Password Status Codes</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><span class="badge bg-success me-2">P</span> Password set and valid</li>
                                        <li class="mb-2"><span class="badge bg-warning me-2">L</span> Account locked</li>
                                        <li class="mb-2"><span class="badge bg-danger me-2">NP</span> No password set</li>
                                        <li class="mb-2"><span class="badge bg-secondary me-2">!</span> Password disabled/locked</li>
                                        <li class="mb-2"><span class="badge bg-info me-2">*</span> System account (no login)</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-primary"><i class="fas fa-clock me-2"></i>Password Age Information</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><strong>Last Change:</strong> Days since password was last changed</li>
                                        <li class="mb-2"><strong>Min Age:</strong> Minimum days before password can be changed</li>
                                        <li class="mb-2"><strong>Max Age:</strong> Maximum days before password must be changed</li>
                                        <li class="mb-2"><strong>Warning:</strong> Days before expiration to warn user</li>
                                        <li class="mb-2"><strong>Inactive:</strong> Days after expiration before account is disabled</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="alert alert-light mt-3 mb-0">
                                <small class="text-muted">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    <strong>Tip:</strong> Focus on accounts with 'NP' (no password) or '!' (disabled) status for security analysis. 
                                    Locked accounts ('L') may indicate security incidents or policy enforcement.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Find user accounts data
    let userAccountsData = null;
    let groupAccountsData = null;
    
    for (const [filename, fileData] of Object.entries(data || {})) {
        if (filename.includes('userAccounts')) {
            userAccountsData = fileData;
        } else if (filename.includes('groupAccounts')) {
            groupAccountsData = fileData;
        }
    }
    
    // Create a mapping of users to their groups
    let userGroupsMap = {};
    if (groupAccountsData && groupAccountsData.data) {
        groupAccountsData.data.forEach(group => {
            if (group.members && group.members.length > 0) {
                group.members.forEach(username => {
                    if (!userGroupsMap[username]) {
                        userGroupsMap[username] = [];
                    }
                    userGroupsMap[username].push({
                        name: group.groupName,
                        gid: group.gid,
                        type: group.groupType
                    });
                });
            }
        });
    }
    
    if (userAccountsData && userAccountsData.data) {
        const users = userAccountsData.data;
        
        // Categorize users by type
        const rootUsers = users.filter(user => user.userType === 'root');
        const systemUsers = users.filter(user => user.userType === 'system');
        const regularUsers = users.filter(user => user.userType === 'regular');
        
        // Summary Statistics
        html += `
            <div class="row mb-4">
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card border-left-danger shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                        Root Users
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">${rootUsers.length}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-crown fa-2x text-danger"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card border-left-warning shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                        System Users
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">${systemUsers.length}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-cogs fa-2x text-warning"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card border-left-success shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                        Regular Users
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">${regularUsers.length}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-user fa-2x text-success"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card border-left-info shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                        Total Users
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">${users.length}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-users fa-2x text-info"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Security Analysis with Password Status
        const privilegedUsers = users.filter(user => user.uid === 0 || user.gid === 0);
        const shellUsers = users.filter(user => user.shell && !user.shell.includes('nologin') && !user.shell.includes('false'));
        
        // Password Security Analysis
        const usersWithPasswords = users.filter(user => user.passwordStatus && user.passwordStatus.rawStatusCode === 'P');
        const usersWithoutPasswords = users.filter(user => user.passwordStatus && (user.passwordStatus.rawStatusCode === 'NP' || user.passwordStatus.rawStatusCode === '!'));
        const lockedUsers = users.filter(user => user.passwordStatus && user.passwordStatus.rawStatusCode === 'L');
        const disabledUsers = users.filter(user => user.passwordStatus && user.passwordStatus.rawStatusCode === '!');
        const expiredUsers = users.filter(user => {
            if (!user.passwordStatus || !user.passwordStatus.accountExpirationDate) return false;
            const expDate = new Date(user.passwordStatus.accountExpirationDate);
            return expDate < new Date();
        });
        
        html += `
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-info">
                                <i class="fas fa-shield-alt me-2"></i>Security Analysis
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-lg-4">
                                    <div class="alert alert-${privilegedUsers.length > 1 ? 'warning' : 'success'}">
                                        <h6><i class="fas fa-crown me-2"></i>Privileged Users</h6>
                                        <p class="mb-1">Found <strong>${privilegedUsers.length}</strong> user(s) with UID/GID 0</p>
                                        ${privilegedUsers.length > 1 ? '<small class="text-warning"> Multiple privileged users detected</small>' : '<small class="text-success"> Normal privileged user count</small>'}
                                    </div>
                                </div>
                                <div class="col-lg-4">
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-terminal me-2"></i>Shell Access</h6>
                                        <p class="mb-1"><strong>${shellUsers.length}</strong> user(s) have shell access</p>
                                        <small class="text-muted">Users with interactive shells</small>
                                    </div>
                                </div>
                                <div class="col-lg-4">
                                    <div class="alert alert-${usersWithoutPasswords.length > 0 ? 'danger' : 'success'}">
                                        <h6><i class="fas fa-key me-2"></i>Password Security</h6>
                                        <p class="mb-1"><strong>${usersWithoutPasswords.length}</strong> user(s) without passwords</p>
                                        ${usersWithoutPasswords.length > 0 ? '<small class="text-danger"> Users without passwords found</small>' : '<small class="text-success"> All users have passwords</small>'}
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-lg-3">
                                    <div class="alert alert-${lockedUsers.length > 0 ? 'warning' : 'light'}">
                                        <h6><i class="fas fa-lock me-2"></i>Locked Accounts</h6>
                                        <p class="mb-1"><strong>${lockedUsers.length}</strong> locked account(s)</p>
                                        <small class="text-muted">Accounts with 'L' status</small>
                                    </div>
                                </div>
                                <div class="col-lg-3">
                                    <div class="alert alert-${disabledUsers.length > 0 ? 'warning' : 'light'}">
                                        <h6><i class="fas fa-ban me-2"></i>Disabled Accounts</h6>
                                        <p class="mb-1"><strong>${disabledUsers.length}</strong> disabled account(s)</p>
                                        <small class="text-muted">Accounts with '!' status</small>
                                    </div>
                                </div>
                                <div class="col-lg-3">
                                    <div class="alert alert-${expiredUsers.length > 0 ? 'danger' : 'light'}">
                                        <h6><i class="fas fa-calendar-times me-2"></i>Expired Accounts</h6>
                                        <p class="mb-1"><strong>${expiredUsers.length}</strong> expired account(s)</p>
                                        <small class="text-muted">Past expiration date</small>
                                    </div>
                                </div>
                                <div class="col-lg-3">
                                    <div class="alert alert-${usersWithPasswords.length > 0 ? 'success' : 'light'}">
                                        <h6><i class="fas fa-check-circle me-2"></i>Active Passwords</h6>
                                        <p class="mb-1"><strong>${usersWithPasswords.length}</strong> user(s) with passwords</p>
                                        <small class="text-muted">Accounts with 'P' status</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Root Users Section
        if (rootUsers.length > 0) {
            html += `
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-danger">
                                    <i class="fas fa-crown me-2"></i>Root Users (${rootUsers.length})
                                </h6>
                            </div>
                            <div class="card-body" style="padding: 0;">
                                <div class="table-responsive" style="overflow-x: auto; overflow-y: auto; max-height: 500px; width: 100%; position: relative; margin: 0; padding: 1rem;">
                                    <table class="table table-hover" style="min-width: 1500px; margin: 0;">
                                        <thead class="table-light" style="position: sticky; top: 0; z-index: 10; background-color: #f8f9fa !important;">
                                            <tr>
                                                <th style="min-width: 150px;">Username</th>
                                                <th style="min-width: 100px;">UID</th>
                                                <th style="min-width: 100px;">GID</th>
                                                <th style="min-width: 250px;">Home Directory</th>
                                                <th style="min-width: 150px;">Shell</th>
                                                <th style="min-width: 200px;">GECOS</th>
                                                <th style="min-width: 120px;">Status</th>
                                                <th style="min-width: 180px;">Last Pwd Change</th>
                                                <th style="min-width: 120px;">Min Age</th>
                                                <th style="min-width: 120px;">Max Age</th>
                                                <th style="min-width: 300px;">Password Hash</th>
                                                <th style="min-width: 150px;">Hash Type</th>
                                                <th style="min-width: 250px;">Group Memberships</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${rootUsers.map(user => {
                                                const userGroups = userGroupsMap[user.username] || [];
                                                const groupBadges = userGroups.map(group => 
                                                    `<span class="badge bg-${group.type === 'system' ? 'secondary' : 'primary'} me-1 mb-1" title="GID: ${group.gid}">${group.name}</span>`
                                                ).join('');
                                                const passwordStatus = user.passwordStatus || {};
                                                const statusCode = passwordStatus.rawStatusCode || '-';
                                                const statusBadge = statusCode === 'P' ? 'bg-success' : statusCode === 'L' ? 'bg-warning' : 'bg-secondary';
                                                const passwordHash = user.passwordHash || '-';
                                                const hashType = user.hashType || '-';
                                                const truncatedHash = passwordHash.length > 20 ? passwordHash.substring(0, 20) + '...' : passwordHash;
                                                return `
                                                <tr>
                                                    <td>
                                                        <span class="badge bg-danger" style="text-transform: none;">${user.username}</span>
                                                    </td>
                                                    <td>${user.uid}</td>
                                                    <td>${user.gid}</td>
                                                    <td><code>${user.homeDirectory}</code></td>
                                                    <td><code>${user.shell}</code></td>
                                                    <td>${user.gecos || '-'}</td>
                                                    <td><span class="badge ${statusBadge}" title="Status Code: ${statusCode}">${statusCode}</span></td>
                                                    <td>${passwordStatus.lastPasswordChange || '-'}</td>
                                                    <td>${passwordStatus.minimumPasswordAge || '-'}</td>
                                                    <td>${passwordStatus.maximumPasswordAge || '-'}</td>
                                                    <td>
                                                            <code class="text-break" title="${passwordHash}">${truncatedHash}</code>
                                                            ${passwordHash && passwordHash !== '-' && passwordHash.length > 20 ? `
                                                                <button class="btn btn-sm btn-outline-secondary ms-2" onclick="showFullPasswordHash('${user.username}', '${passwordHash.replace(/'/g, "\\'")}')">Show Full</button>
                                                            ` : ''}
                                                        </td>
                                                    <td><span class="badge ${hashType === 'No Password/Locked' ? 'bg-warning' : hashType === 'Unknown/Other' ? 'bg-secondary' : 'bg-info'}">${hashType}</span></td>
                                                    <td><div class="d-flex flex-wrap">${groupBadges || '<span class="text-muted">No groups</span>'}</div></td>
                                                </tr>`;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Regular Users Section
        if (regularUsers.length > 0) {
            html += `
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-success">
                                    <i class="fas fa-user me-2"></i>Regular Users (${regularUsers.length})
                                </h6>
                            </div>
                            <div class="card-body" style="padding: 0;">
                                <div class="table-responsive" style="overflow-x: auto; overflow-y: auto; max-height: 500px; width: 100%; position: relative; margin: 0; padding: 1rem;">
                                    <table class="table table-hover" style="min-width: 1500px; margin: 0;">
                                        <thead class="table-light" style="position: sticky; top: 0; z-index: 10; background-color: #f8f9fa !important;">
                                            <tr>
                                                <th style="min-width: 150px;">Username</th>
                                                <th style="min-width: 100px;">UID</th>
                                                <th style="min-width: 100px;">GID</th>
                                                <th style="min-width: 250px;">Home Directory</th>
                                                <th style="min-width: 150px;">Shell</th>
                                                <th style="min-width: 200px;">GECOS</th>
                                                <th style="min-width: 120px;">Status</th>
                                                <th style="min-width: 180px;">Last Pwd Change</th>
                                                <th style="min-width: 120px;">Min Age</th>
                                                <th style="min-width: 120px;">Max Age</th>
                                                <th style="min-width: 300px;">Password Hash</th>
                                                <th style="min-width: 150px;">Hash Type</th>
                                                <th style="min-width: 250px;">Group Memberships</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${regularUsers.map(user => {
                                                const userGroups = userGroupsMap[user.username] || [];
                                                const groupBadges = userGroups.map(group => 
                                                    `<span class="badge bg-${group.type === 'system' ? 'secondary' : 'primary'} me-1 mb-1" title="GID: ${group.gid}">${group.name}</span>`
                                                ).join('');
                                                const passwordStatus = user.passwordStatus || {};
                                                const statusCode = passwordStatus.rawStatusCode || '-';
                                                const statusBadge = statusCode === 'P' ? 'bg-success' : statusCode === 'L' ? 'bg-warning' : 'bg-secondary';
                                                const passwordHash = user.passwordHash || '-';
                                                const hashType = user.hashType || '-';
                                                const truncatedHash = passwordHash.length > 20 ? passwordHash.substring(0, 20) + '...' : passwordHash;
                                                return `
                                                <tr>
                                                    <td>
                                                        <span class="badge bg-success" style="text-transform: none;">${user.username}</span>
                                                    </td>
                                                    <td>${user.uid}</td>
                                                    <td>${user.gid}</td>
                                                    <td><code>${user.homeDirectory}</code></td>
                                                    <td><code>${user.shell}</code></td>
                                                    <td>${user.gecos || '-'}</td>
                                                    <td><span class="badge ${statusBadge}" title="Status Code: ${statusCode}">${statusCode}</span></td>
                                                    <td>${passwordStatus.lastPasswordChange || '-'}</td>
                                                    <td>${passwordStatus.minimumPasswordAge || '-'}</td>
                                                    <td>${passwordStatus.maximumPasswordAge || '-'}</td>
                                                    <td>
                                                            <code class="text-break" title="${passwordHash}">${truncatedHash}</code>
                                                            ${passwordHash && passwordHash !== '-' && passwordHash.length > 20 ? `
                                                                <button class="btn btn-sm btn-outline-secondary ms-2" onclick="showFullPasswordHash('${user.username}', '${passwordHash.replace(/'/g, "\\'")}')">Show Full</button>
                                                            ` : ''}
                                                        </td>
                                                    <td><span class="badge ${hashType === 'No Password/Locked' ? 'bg-warning' : hashType === 'Unknown/Other' ? 'bg-secondary' : 'bg-info'}">${hashType}</span></td>
                                                    <td><div class="d-flex flex-wrap">${groupBadges || '<span class="text-muted">No groups</span>'}</div></td>
                                                </tr>`;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // System Users Section (Collapsible)
        if (systemUsers.length > 0) {
            html += `
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-warning">
                                    <i class="fas fa-cogs me-2"></i>System Users (${systemUsers.length})
                                    <button class="btn btn-sm btn-outline-warning float-end" type="button" 
                                            data-bs-toggle="collapse" data-bs-target="#systemUsersCollapse" 
                                            aria-expanded="false" aria-controls="systemUsersCollapse">
                                        <i class="fas fa-chevron-down"></i> Show/Hide
                                    </button>
                                </h6>
                            </div>
                            <div class="collapse" id="systemUsersCollapse">
                                <div class="card-body" style="padding: 0;">
                                    <div class="table-responsive" style="overflow-x: auto; overflow-y: auto; max-height: 500px; width: 100%; position: relative; margin: 0; padding: 1rem;">
                                     <table class="table table-hover" style="min-width: 1500px; margin: 0;">
                                        <thead class="table-light" style="position: sticky; top: 0; z-index: 10; background-color: #f8f9fa !important;">
                                            <tr>
                                                <th style="min-width: 150px;">Username</th>
                                                <th style="min-width: 100px;">UID</th>
                                                <th style="min-width: 100px;">GID</th>
                                                <th style="min-width: 250px;">Home Directory</th>
                                                <th style="min-width: 150px;">Shell</th>
                                                <th style="min-width: 200px;">GECOS</th>
                                                <th style="min-width: 120px;">Status</th>
                                                <th style="min-width: 180px;">Last Pwd Change</th>
                                                <th style="min-width: 120px;">Min Age</th>
                                                <th style="min-width: 120px;">Max Age</th>
                                                <th style="min-width: 300px;">Password Hash</th>
                                                <th style="min-width: 150px;">Hash Type</th>
                                                <th style="min-width: 250px;">Group Memberships</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                                ${systemUsers.map(user => {
                                                    const userGroups = userGroupsMap[user.username] || [];
                                                    const groupBadges = userGroups.map(group => 
                                                        `<span class="badge bg-${group.type === 'system' ? 'secondary' : 'primary'} me-1 mb-1" title="GID: ${group.gid}">${group.name}</span>`
                                                    ).join('');
                                                    const passwordStatus = user.passwordStatus || {};
                                                    const statusCode = passwordStatus.rawStatusCode || '-';
                                                    const statusBadge = statusCode === 'P' ? 'bg-success' : statusCode === 'L' ? 'bg-warning' : 'bg-secondary';
                                                    const passwordHash = user.passwordHash || '-';
                                                    const hashType = user.hashType || '-';
                                                    const truncatedHash = passwordHash.length > 20 ? passwordHash.substring(0, 20) + '...' : passwordHash;
                                                    return `
                                                    <tr>
                                                        <td>
                                                            <span class="badge bg-warning text-dark" style="text-transform: none;">${user.username}</span>
                                                        </td>
                                                        <td>${user.uid}</td>
                                                        <td>${user.gid}</td>
                                                        <td><code>${user.homeDirectory}</code></td>
                                                        <td><code>${user.shell}</code></td>
                                                        <td>${user.gecos || '-'}</td>
                                                        <td><span class="badge ${statusBadge}" title="Status Code: ${statusCode}">${statusCode}</span></td>
                                                        <td>${passwordStatus.lastPasswordChange || '-'}</td>
                                                        <td>${passwordStatus.minimumPasswordAge || '-'}</td>
                                                        <td>${passwordStatus.maximumPasswordAge || '-'}</td>
                                                        <td>
                                                            <code class="text-break" title="${passwordHash}">${truncatedHash}</code>
                                                            ${passwordHash && passwordHash !== '-' && passwordHash.length > 20 ? `
                                                                <button class="btn btn-sm btn-outline-secondary ms-2" onclick="showFullPasswordHash('${user.username}', '${passwordHash.replace(/'/g, "\\'")}')">Show Full</button>
                                                            ` : ''}
                                                        </td>
                                                        <td><span class="badge ${hashType === 'No Password/Locked' ? 'bg-warning' : hashType === 'Unknown/Other' ? 'bg-secondary' : 'bg-info'}">${hashType}</span></td>
                                                        <td><div class="d-flex flex-wrap">${groupBadges || '<span class="text-muted">No groups</span>'}</div></td>
                                                    </tr>`;
                                                }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        
    } else {
        html += `
            <div class="card shadow">
                <div class="card-body text-center py-5">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted mb-3">No User Account Information Available</h5>
                    <p class="text-muted">No user account data found in the uploaded artifacts.</p>
                </div>
            </div>
        `;
    }
    
    contentArea.innerHTML = html;
}

function renderLoginHistory(data) {
    const contentArea = document.getElementById('content-area');
    
    let html = `
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="h4 mb-3">
                    <i class="fas fa-sign-in-alt me-2"></i>Login History
                </h2>
            </div>
        </div>
    `;
    
    if (data && Object.keys(data).length > 0) {
        // Statistics calculation and cards removed - now handled in Authentication section under Logs menu
        
        // Current Sessions (UTMP Logs)
        if (data.utmp_logs && Array.isArray(data.utmp_logs) && data.utmp_logs.length > 0) {
            html += `
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-warning">
                                    <i class="fas fa-user-clock me-2"></i>Current Sessions (${data.utmp_logs.length})
                                </h6>
                            </div>
                            <div class="card-body" style="padding: 0;">
                                <div class="table-responsive" style="overflow-x: auto; overflow-y: auto; max-height: 1000px; width: 100%; position: relative; margin: 0; padding: 1rem;">
                                    <table class="table table-hover" style="min-width: 1000px; margin: 0;">
                                        <thead class="table-light" style="position: sticky; top: 0; z-index: 10; background-color: #f8f9fa !important;">
                                            <tr>
                                                <th style="min-width: 120px;">Session Status</th>
                                                <th style="min-width: 120px;">Session Type</th>
                                                <th style="min-width: 120px;">Username</th>
                                                <th style="min-width: 150px;">Terminal</th>
                                                <th style="min-width: 200px;">Hostname</th>
                                                <th style="min-width: 180px;">Login Time</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data.utmp_logs.map(entry => {
                                                const sessionStatus = entry.session_status || '-';
                                                const sessionType = entry.session_type || '-';
                                                const username = entry.username || '-';
                                                const terminal = entry.terminal || '-';
                                                const hostname = entry.hostname || '-';
                                                const loginTime = entry.login_time ? new Date(entry.login_time).toLocaleString() : '-';
                                                const statusBadge = sessionStatus === 'active' ? 'bg-success' : sessionStatus === 'inactive' ? 'bg-secondary' : 'bg-info';
                                                const typeBadge = sessionType === 'user' ? 'bg-primary' : sessionType === 'system' ? 'bg-warning' : 'bg-secondary';
                                                
                                                return `
                                                    <tr>
                                                        <td><span class="badge ${statusBadge}">${sessionStatus}</span></td>
                                                        <td><span class="badge ${typeBadge}">${sessionType}</span></td>
                                                        <td><strong>${username}</strong></td>
                                                        <td>${terminal}</td>
                                                        <td>${hostname}</td>
                                                        <td>${loginTime}</td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Last Login Information (Lastlog)
        if (data.lastlog_logs && data.lastlog_logs.logs && Array.isArray(data.lastlog_logs.logs) && data.lastlog_logs.logs.length > 0) {
            html += `
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-info">
                                    <i class="fas fa-clock me-2"></i>Last Login Information (${data.lastlog_logs.logs.length})
                                </h6>
                            </div>
                            <div class="card-body" style="padding: 0;">
                                <div class="table-responsive" style="overflow-x: auto; overflow-y: auto; max-height: 400px; width: 100%; position: relative; margin: 0; padding: 1rem;">
                                    <table class="table table-hover" style="min-width: 1000px; margin: 0;">
                                        <thead class="table-light" style="position: sticky; top: 0; z-index: 10; background-color: #f8f9fa !important;">
                                            <tr>
                                                <th style="min-width: 100px;">UID</th>
                                                <th style="min-width: 120px;">Username</th>
                                                <th style="min-width: 180px;">Last Login</th>
                                                <th style="min-width: 150px;">Terminal</th>
                                                <th style="min-width: 200px;">Hostname</th>
                                                <th style="min-width: 120px;">Login Type</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data.lastlog_logs.logs.map(entry => {
                                                const uid = entry.uid || '-';
                                                const username = entry.username || '-';
                                                const lastLogin = entry.last_login_time ? new Date(entry.last_login_time).toLocaleString() : 'Never';
                                                const terminal = entry.terminal || '-';
                                                const hostname = entry.hostname || '-';
                                                const loginType = entry.login_type || '-';
                                                const typeBadge = loginType === 'local' ? 'bg-success' : loginType === 'remote' ? 'bg-warning' : 'bg-secondary';
                                                
                                                return `
                                                    <tr>
                                                        <td>${uid}</td>
                                                        <td><strong>${username}</strong></td>
                                                        <td>${lastLogin}</td>
                                                        <td>${terminal}</td>
                                                        <td>${hostname}</td>
                                                        <td><span class="badge ${typeBadge}">${loginType}</span></td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Session History (WTMP Logs)
        if (data.wtmp_logs && data.wtmp_logs.logs && Array.isArray(data.wtmp_logs.logs) && data.wtmp_logs.logs.length > 0) {
            html += `
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-success">
                                    <i class="fas fa-history me-2"></i>Session History (${data.wtmp_logs.logs.length})
                                </h6>
                            </div>
                            <div class="card-body" style="padding: 0;">
                                <div class="table-responsive" style="overflow-x: auto; overflow-y: auto; max-height: 400px; width: 100%; position: relative; margin: 0; padding: 1rem;">
                                    <table class="table table-hover" style="min-width: 1000px; margin: 0;">
                                        <thead class="table-light" style="position: sticky; top: 0; z-index: 10; background-color: #f8f9fa !important;">
                                            <tr>
                                                <th style="min-width: 180px;">Timestamp</th>
                                                <th style="min-width: 120px;">Record Type</th>
                                                <th style="min-width: 120px;">Username</th>
                                                <th style="min-width: 150px;">Terminal</th>
                                                <th style="min-width: 200px;">Hostname</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data.wtmp_logs.logs.slice(0, 500).map(entry => {
                                                const timestamp = entry.timestamp ? new Date(entry.timestamp).toLocaleString() : '-';
                                                const recordType = entry.record_type || '-';
                                                const username = entry.username || '-';
                                                const terminal = entry.terminal || '-';
                                                const hostname = entry.hostname || '-';
                                                const typeBadge = recordType === 'USER_PROCESS' ? 'bg-success' : recordType === 'DEAD_PROCESS' ? 'bg-warning' : 'bg-info';
                                                
                                                return `
                                                    <tr>
                                                        <td>${timestamp}</td>
                                                        <td><span class="badge ${typeBadge}">${recordType}</span></td>
                                                        <td><strong>${username}</strong></td>
                                                        <td>${terminal}</td>
                                                        <td>${hostname}</td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Note: Authentication Events are now handled in the Authentication section under Logs menu
        
    } else {
        html += `
            <div class="card shadow">
                <div class="card-body text-center py-5">
                    <i class="fas fa-sign-in-alt fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted mb-3">No Login History Available</h5>
                    <p class="text-muted">No login history data found in the uploaded artifacts.</p>
                </div>
            </div>
        `;
    }
    
    contentArea.innerHTML = html;
}

function parseAuthLogEntry(entry) {
    // Parse raw authentication log entry and extract structured information
    let timestamp = 'N/A';
    let event_type = 'unknown';
    let username = 'N/A';
    let result = 'N/A';
    let source = 'N/A';
    let details = 'N/A';
    
    // Handle different entry formats
    let message = '';
    if (typeof entry === 'string') {
        message = entry;
    } else if (entry && typeof entry === 'object') {
        // If entry is already structured, use it directly
        if (entry.timestamp) timestamp = entry.timestamp;
        if (entry.event_type) event_type = entry.event_type;
        if (entry.username) username = entry.username;
        if (entry.result) result = entry.result;
        if (entry.source) source = entry.source;
        if (entry.details) details = entry.details;
        if (entry.message) message = entry.message;
        
        // If already structured, return as is
        if (entry.event_type && entry.username) {
            return {
                timestamp: timestamp,
                event_type: event_type,
                username: username,
                result: result,
                source: source,
                details: details || message || 'N/A'
            };
        }
        
        // Otherwise, parse the message field
        message = entry.message || entry.details || JSON.stringify(entry);
    }
    
    // Parse timestamp if it's a Unix timestamp at the beginning
    const timestampMatch = message.match(/^(\d{10})\s*(.*)$/);
    if (timestampMatch) {
        const unixTimestamp = parseInt(timestampMatch[1]);
        timestamp = new Date(unixTimestamp * 1000).toLocaleString();
        message = timestampMatch[2].trim();
    } else {
        // Try to extract timestamp from standard syslog format
        const syslogMatch = message.match(/^(\w{3}\s+\d{1,2}\s+\d{2}:\d{2}:\d{2})\s+(.*)$/);
        if (syslogMatch) {
            timestamp = syslogMatch[1];
            message = syslogMatch[2].trim();
        }
    }
    
    // Parse sudo events
    if (message.includes('sudo') || message.includes('pam_unix(sudo')) {
        event_type = 'sudo';
        
        // Extract username from sudo session messages
        const sudoSessionMatch = message.match(/pam_unix\(sudo:session\): session (opened|closed) for user (\w+)(?:\(uid=\d+\))?(?: by (\w+)\(uid=\d+\))?/);
        if (sudoSessionMatch) {
            result = sudoSessionMatch[1];
            username = sudoSessionMatch[2];
            if (sudoSessionMatch[3]) {
                source = `by ${sudoSessionMatch[3]}`;
            }
            details = message;
        }
        
        // Extract command from sudo command messages
        const sudoCommandMatch = message.match(/(\w+) : TTY=([^;]+) ; PWD=([^;]+) ; USER=([^;]+) ; COMMAND=(.+)/);
        if (sudoCommandMatch) {
            username = sudoCommandMatch[1];
            source = sudoCommandMatch[2];
            result = 'command';
            details = `Command: ${sudoCommandMatch[5]}`;
        }
    }
    // Parse PAM authentication events
    else if (message.includes('pam_unix')) {
        event_type = 'pam';
        
        // Extract session events
        const pamSessionMatch = message.match(/pam_unix\(([^)]+):session\): session (opened|closed) for user (\w+)(?:\(uid=\d+\))?(?: by (\w+)\(uid=\d+\))?/);
        if (pamSessionMatch) {
            source = pamSessionMatch[1];
            result = pamSessionMatch[2];
            username = pamSessionMatch[3];
            if (pamSessionMatch[4]) {
                source += ` (by ${pamSessionMatch[4]})`;
            }
            details = message;
        }
        
        // Extract authentication events
        const pamAuthMatch = message.match(/pam_unix\(([^)]+)\): authentication (failure|success) for (\w+)/);
        if (pamAuthMatch) {
            source = pamAuthMatch[1];
            result = pamAuthMatch[2];
            username = pamAuthMatch[3];
            details = message;
        }
    }
    // Parse login events
    else if (message.includes('login') || message.includes('LOGIN')) {
        event_type = 'login';
        details = message;
        
        // Try to extract username
        const loginUserMatch = message.match(/(?:user|for)\s+(\w+)/);
        if (loginUserMatch) {
            username = loginUserMatch[1];
        }
    }
    // Parse SSH events
    else if (message.includes('ssh') || message.includes('SSH')) {
        event_type = 'ssh';
        details = message;
        
        // Try to extract username and result
        const sshMatch = message.match(/(Accepted|Failed|Invalid).*?for\s+(\w+)/);
        if (sshMatch) {
            result = sshMatch[1].toLowerCase();
            username = sshMatch[2];
        }
    }
    // Parse cron events
    else if (message.includes('cron')) {
        event_type = 'cron';
        details = message;
        
        const cronMatch = message.match(/pam_unix\(cron:session\): session (opened|closed) for user (\w+)(?:\(uid=\d+\))?(?: by (\w+)\(uid=\d+\))?/);
        if (cronMatch) {
            result = cronMatch[1];
            username = cronMatch[2];
            if (cronMatch[3]) {
                source = `by ${cronMatch[3]}`;
            }
        }
    }
    // Default case - try to extract any username and determine event type
    else {
        details = message;
        
        // Try to extract username from various patterns
        const userMatch = message.match(/(?:user|for|by)\s+(\w+)/);
        if (userMatch) {
            username = userMatch[1];
        }
        
        // Determine event type from message content
        if (message.includes('session')) {
            event_type = 'session';
        } else if (message.includes('auth')) {
            event_type = 'auth';
        } else if (message.includes('TTY=') && message.includes('COMMAND=')) {
            event_type = 'sudo';
            // Try to parse sudo command format that wasn't caught earlier
            const sudoMatch = message.match(/(\w+) : TTY=([^;]+) ; PWD=([^;]+) ; USER=([^;]+) ; COMMAND=(.+)/);
            if (sudoMatch) {
                username = sudoMatch[1];
                source = sudoMatch[2];
                result = 'command';
                details = `Command: ${sudoMatch[5]}`;
            }
        }
    }
    
    return {
        timestamp: timestamp,
        event_type: event_type,
        username: username,
        result: result,
        source: source,
        details: details
    };
}

function renderAuthentication(data) {
    const contentArea = document.getElementById('content-area');
    
    let html = `
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="h4 mb-3">
                    <i class="fas fa-shield-alt me-2"></i>Authentication Logs
                </h2>
            </div>
        </div>
    `;
    
    if (data && Object.keys(data).length > 0) {
        // Calculate authentication statistics
        const authLogs = data.auth_logs || {};
        const wtmpLogs = data.wtmp_logs || [];
        
        let totalLogins = 0;
        let uniqueUsers = new Set();
        let failedLogins = 0;
        let remoteLogins = 0;
        
        // Process auth logs
        if (authLogs.entries && Array.isArray(authLogs.entries)) {
            authLogs.entries.forEach(entry => {
                // Count authentication events including sudo commands
                if (entry.event_type && (entry.event_type.includes('login') || entry.event_type === 'ssh' || entry.event_type === 'sudo')) {
                    totalLogins++;
                }
                if (entry.username && entry.username !== 'N/A') uniqueUsers.add(entry.username);
                
                // Check for failed authentication using auth_result field
                const authResult = entry.auth_result || entry.session_info || '';
                if (authResult.toLowerCase().includes('fail') || authResult.toLowerCase().includes('denied')) {
                    failedLogins++;
                }
                
                // Check for remote logins - only count if there's an actual remote IP address
                if (entry.source_ip && entry.source_ip !== 'localhost' && entry.source_ip !== '127.0.0.1' && entry.source_ip !== 'kali' && !entry.source_ip.startsWith('192.168.') && !entry.source_ip.startsWith('10.') && !entry.source_ip.startsWith('172.')) {
                    remoteLogins++;
                } else if (entry.event_type === 'ssh' && entry.source_ip && entry.source_ip !== 'localhost' && entry.source_ip !== '127.0.0.1') {
                    remoteLogins++;
                }
            });
        }
        
        // Remote logins are already counted in the auth logs processing above
        
        // Statistics Cards
        const statisticsCards = `
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Total Login Events</h6>
                                    <h3 class="mb-0">${totalLogins}</h3>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-sign-in-alt fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Unique Users</h6>
                                    <h3 class="mb-0">${uniqueUsers.size}</h3>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-users fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Failed Attempts</h6>
                                    <h3 class="mb-0">${failedLogins}</h3>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Remote Logins</h6>
                                    <h3 class="mb-0">${remoteLogins}</h3>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-globe fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        html += statisticsCards;
        
        // Authentication Analysis Guide
        html += `
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-info">
                        <div class="card-header bg-info text-white py-2">
                            <h6 class="m-0">
                                <i class="fas fa-info-circle me-2"></i>Authentication Analysis Guide
                                <button class="btn btn-sm btn-outline-light float-end" type="button" data-bs-toggle="collapse" data-bs-target="#authGuide" aria-expanded="false">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </h6>
                        </div>
                        <div class="collapse" id="authGuide">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-primary"><i class="fas fa-key me-2"></i>Authentication Events</h6>
                                        <ul class="list-unstyled">
                                            <li class="mb-2"><span class="badge bg-success me-2">Successful</span> Valid login attempts</li>
                                            <li class="mb-2"><span class="badge bg-danger me-2">Failed</span> Invalid credentials or blocked</li>
                                            <li class="mb-2"><span class="badge bg-warning me-2">Session</span> Session start/end events</li>
                                            <li class="mb-2"><span class="badge bg-info me-2">Remote</span> SSH or network logins</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-primary"><i class="fas fa-shield-alt me-2"></i>Security Indicators</h6>
                                        <ul class="list-unstyled">
                                            <li class="mb-2"><strong>Multiple Failures:</strong> Potential brute force attacks</li>
                                            <li class="mb-2"><strong>Unusual Times:</strong> Off-hours login attempts</li>
                                            <li class="mb-2"><strong>Remote Access:</strong> External connection attempts</li>
                                            <li class="mb-2"><strong>Privilege Escalation:</strong> Su/sudo events</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="alert alert-light mt-3 mb-0">
                                    <small class="text-muted">
                                        <i class="fas fa-lightbulb me-1"></i>
                                        <strong>Investigation Tips:</strong> Look for patterns in failed logins, unusual source IPs, 
                                        off-hours access, and privilege escalation attempts. Cross-reference with network logs.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Authentication Events (Auth Logs)
        if (authLogs.entries && Array.isArray(authLogs.entries) && authLogs.entries.length > 0) {
            // Generate unique values for filters
            const eventTypes = [...new Set(authLogs.entries.map(entry => entry.event_type).filter(Boolean))];
            const results = [...new Set(authLogs.entries.map(entry => entry.result).filter(Boolean))];
            const usernames = [...new Set(authLogs.entries.map(entry => entry.username).filter(Boolean))];
            
            html += `
                <!-- Authentication Filters -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white py-2">
                                <h6 class="m-0">
                                    <i class="fas fa-filter me-2"></i>Authentication Filters
                                    <button class="btn btn-sm btn-outline-light float-end" type="button" data-bs-toggle="collapse" data-bs-target="#authFilters" aria-expanded="true">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                </h6>
                            </div>
                            <div class="collapse show" id="authFilters">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <label for="authSearch" class="form-label">Search Events</label>
                                            <input type="text" class="form-control" id="authSearch" placeholder="Search events..." onkeyup="filterAuthEvents()">
                                        </div>
                                        <div class="col-md-2">
                                            <label for="eventTypeFilter" class="form-label">Event Type</label>
                                            <select class="form-select" id="eventTypeFilter" onchange="filterAuthEvents()">
                                                <option value="">All Types</option>
                                                ${eventTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <label for="resultFilter" class="form-label">Result</label>
                                            <select class="form-select" id="resultFilter" onchange="filterAuthEvents()">
                                                <option value="">All Results</option>
                                                ${results.map(result => `<option value="${result}">${result}</option>`).join('')}
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <label for="usernameFilter" class="form-label">Username</label>
                                            <select class="form-select" id="usernameFilter" onchange="filterAuthEvents()">
                                                <option value="">All Users</option>
                                                ${usernames.map(user => `<option value="${user}">${user}</option>`).join('')}
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">&nbsp;</label>
                                            <div class="d-flex gap-2">
                                                <span class="badge bg-secondary align-self-center" id="authEventsCount">${authLogs.entries.length} events</span>
                                                <button class="btn btn-outline-secondary" onclick="clearAuthFilters()">
                                                    <i class="fas fa-times me-1"></i>Clear
                                                </button>
                                                <button class="btn btn-outline-info" onclick="exportAuthEvents()">
                                                    <i class="fas fa-download me-1"></i>Export
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header py-2">
                                <h6 class="m-0">
                                    <i class="fas fa-list me-2"></i>Authentication Events
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0" id="authEventsTable">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Timestamp</th>
                                                <th>Event Type</th>
                                                <th>Username</th>
                                                <th>Result</th>
                                                <th>Source</th>
                                                <th>Details</th>
                                            </tr>
                                        </thead>
                                        <tbody>
            `;
            
            authLogs.entries.forEach((entry, index) => {
                // Use structured data directly from JSON
                const timestamp = entry.timestamp ? new Date(entry.timestamp * 1000).toLocaleString() : 'N/A';
                const eventType = entry.event_type || 'unknown';
                const username = entry.username || 'N/A';
                const authResult = entry.auth_result || entry.session_info || 'unknown';
                const sourceInfo = entry.source_ip || entry.hostname || (entry.message && entry.message.includes('TTY=') ? entry.message.match(/TTY=([^\s;]+)/)?.[1] : null) || 'N/A';
                const details = entry.command ? `Command: ${entry.command}` : entry.message || entry.session_info || 'N/A';
                
                const resultBadge = authResult && authResult.toLowerCase().includes('fail') ? 
                    'bg-danger' : authResult && (authResult.toLowerCase().includes('success') || authResult.toLowerCase().includes('opened')) ? 
                    'bg-success' : authResult && authResult.toLowerCase().includes('closed') ? 
                    'bg-warning' : 'bg-secondary';
                
                const eventTypeBadge = eventType === 'sudo' ? 'bg-primary' : 
                    eventType === 'login' ? 'bg-info' : 
                    eventType === 'ssh' ? 'bg-success' : 
                    eventType === 'pam' ? 'bg-warning' : 'bg-secondary';
                
                html += `
                    <tr class="auth-event-row" data-index="${index}">
                        <td><small>${timestamp}</small></td>
                        <td><span class="badge ${eventTypeBadge}">${eventType}</span></td>
                        <td><strong>${username}</strong></td>
                        <td><span class="badge ${resultBadge}">${authResult}</span></td>
                        <td><small>${sourceInfo}</small></td>
                        <td><small class="text-truncate" style="max-width: 300px;" title="${details}">${details}</small></td>
                    </tr>
                `;
            });
            
            html += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Store original data for filtering (will be set after HTML is rendered)
        } else {
            html += `
                <div class="card shadow">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-shield-alt fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted mb-3">No Authentication Events</h5>
                        <p class="text-muted">No authentication log data found in the uploaded artifacts.</p>
                    </div>
                </div>
            `;
        }
    } else {
        html += `
            <div class="card shadow">
                <div class="card-body text-center py-5">
                    <i class="fas fa-shield-alt fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted mb-3">No Data Available</h5>
                    <p class="text-muted">No authentication data found in the uploaded artifacts.</p>
                </div>
            </div>
        `;
    }
    
    contentArea.innerHTML = html;
    
    // Set original data for filtering after HTML is rendered
    if (data && data.auth_logs && data.auth_logs.entries) {
        window.originalAuthData = data.auth_logs.entries;
        const countElement = document.getElementById('authEventsCount');
        if (countElement) {
            countElement.textContent = data.auth_logs.entries.length + ' events';
        }
    }
}

function renderGenericData(section, data) {
    const contentArea = document.getElementById('content-area');
    const sectionTitle = section.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
    
    let html = `
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="h4 mb-3">
                    <i class="fas fa-info-circle me-2"></i>${sectionTitle}
                </h2>
            </div>
        </div>
    `;
    
    if (data && Object.keys(data).length > 0) {
        html += `
            <div class="card shadow">
                <div class="card-body">
                    <pre class="bg-light p-3 rounded"><code>${JSON.stringify(data, null, 2)}</code></pre>
                </div>
            </div>
        `;
    } else {
        html += `
            <div class="card shadow">
                <div class="card-body text-center py-5">
                    <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted mb-3">No Data Available</h5>
                    <p class="text-muted">No ${sectionTitle.toLowerCase()} data found in the uploaded artifacts.</p>
                </div>
            </div>
        `;
    }
    
    contentArea.innerHTML = html;
}

function renderProcesses(data) {
    const contentArea = document.getElementById('content-area');
    
    let html = `
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="h4 mb-3">
                    <i class="fas fa-tasks me-2"></i>Running Processes
                </h2>
            </div>
        </div>
        
        <!-- Process Analysis Guide -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white py-2">
                        <h6 class="m-0">
                            <i class="fas fa-info-circle me-2"></i>Process Analysis Guide
                            <button class="btn btn-sm btn-outline-light float-end" type="button" data-bs-toggle="collapse" data-bs-target="#processGuide" aria-expanded="false">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </h6>
                    </div>
                    <div class="collapse" id="processGuide">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary"><i class="fas fa-chart-line me-2"></i>Resource Usage Indicators</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><span class="badge bg-success me-2">Low CPU</span> 0-10% CPU usage (normal)</li>
                                        <li class="mb-2"><span class="badge bg-warning me-2">Med CPU</span> 10-50% CPU usage (moderate)</li>
                                        <li class="mb-2"><span class="badge bg-danger me-2">High CPU</span> 50%+ CPU usage (investigate)</li>
                                        <li class="mb-2"><span class="badge bg-info me-2">Memory</span> High memory % may indicate leaks</li>
                                        <li class="mb-2"><span class="badge bg-secondary me-2">Threads</span> Multiple threads per process</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-primary"><i class="fas fa-shield-alt me-2"></i>Security Analysis Points</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><strong>Process Status:</strong> Running vs Sleeping processes</li>
                                        <li class="mb-2"><strong>User Context:</strong> Processes running as root or system users</li>
                                        <li class="mb-2"><strong>Command Line:</strong> Full command with arguments and paths</li>
                                        <li class="mb-2"><strong>Parent-Child:</strong> Process relationships (PPID)</li>
                                        <li class="mb-2"><strong>Start Time:</strong> When the process was initiated</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <h6 class="text-primary"><i class="fas fa-info-circle me-2"></i>Process State Column Guide</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <ul class="list-unstyled">
                                                <li class="mb-2"><span class="badge bg-success me-2">R</span> Running - Process is currently executing</li>
                                                <li class="mb-2"><span class="badge bg-info me-2">S</span> Sleeping - Interruptible sleep (waiting for event)</li>
                                                <li class="mb-2"><span class="badge bg-warning me-2">D</span> Disk Sleep - Uninterruptible sleep (I/O wait)</li>
                                                <li class="mb-2"><span class="badge bg-danger me-2">Z</span> Zombie - Terminated but not reaped by parent</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <ul class="list-unstyled">
                                                <li class="mb-2"><span class="badge bg-secondary me-2">T</span> Stopped - Process stopped by signal</li>
                                                <li class="mb-2"><span class="badge bg-dark me-2">t</span> Tracing - Process being traced by debugger</li>
                                                <li class="mb-2"><span class="badge bg-primary me-2">X</span> Dead - Process should never be seen</li>
                                                <li class="mb-2"><span class="badge bg-light text-dark me-2">I</span> Idle - Kernel thread in uninterruptible wait</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-light mt-3 mb-0">
                                <small class="text-muted">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    <strong>Investigation Tips:</strong> Look for unusual processes running as root, high resource usage, 
                                    suspicious command lines, or processes with no parent (PPID=0). Check for processes 
                                    running from unusual locations like /tmp or /var/tmp.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Process Filters and Search -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white py-2">
                        <h6 class="m-0">
                            <i class="fas fa-filter me-2"></i>Process Filters
                            <button class="btn btn-sm btn-outline-light float-end" type="button" data-bs-toggle="collapse" data-bs-target="#processFilters" aria-expanded="true">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </h6>
                    </div>
                    <div class="collapse show" id="processFilters">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <label for="processSearch" class="form-label">Search Processes</label>
                                    <input type="text" class="form-control" id="processSearch" placeholder="Search by name, command, or user..." onkeyup="filterProcesses()">
                                </div>
                                <div class="col-md-2">
                                    <label for="userFilter" class="form-label">User</label>
                                    <select class="form-select" id="userFilter" onchange="filterProcesses()">
                                        <option value="">All Users</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="cpuThreshold" class="form-label">Min CPU %</label>
                                    <input type="number" class="form-control" id="cpuThreshold" placeholder="0" min="0" max="100" onchange="filterProcesses()">
                                </div>
                                <div class="col-md-2">
                                    <label for="memoryThreshold" class="form-label">Min Memory %</label>
                                    <input type="number" class="form-control" id="memoryThreshold" placeholder="0" min="0" max="100" onchange="filterProcesses()">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-secondary" onclick="clearProcessFilters()">
                                            <i class="fas fa-times me-1"></i>Clear
                                        </button>
                                        <button class="btn btn-outline-info" onclick="exportProcesses()">
                                            <i class="fas fa-download me-1"></i>Export
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Find processes data
    let processesData = null;
    let processCount = 0;
    
    // Data is already extracted by renderSectionContent, use it directly
    const dataSource = data || {};
    
    for (const [filename, fileData] of Object.entries(dataSource)) {
        // Look specifically for processes_*.json files (running processes), not process_hunting_data
        if (filename.startsWith('processes_') && filename.endsWith('.json') && fileData) {
            // Handle different data structures
            if (Array.isArray(fileData)) {
                processesData = fileData;
            } else if (fileData.data && Array.isArray(fileData.data)) {
                processesData = fileData.data;
            } else if (fileData.processes && Array.isArray(fileData.processes)) {
                processesData = fileData.processes;
            }
            break;
        }
    }
    
    if (processesData && processesData.length > 0) {
        processCount = processesData.length;
        
        // Get unique users for filter dropdown
        const uniqueUsers = [...new Set(processesData.map(p => p.user || p.USER || 'unknown').filter(u => u))];
        
        // Statistics Cards
        const totalCpu = processesData.reduce((sum, p) => sum + parseFloat(p.cpuPercent || p.cpu || p.CPU || p['%CPU'] || 0), 0);
        const totalMemory = processesData.reduce((sum, p) => sum + parseFloat(p.memoryPercent || p.memory || p.MEM || p['%MEM'] || 0), 0);
        const runningProcesses = processesData.filter(p => (p.stat || p.state || p.STAT || p.status || '').includes('R')).length;
        
        html += `
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${processCount}</h5>
                            <p class="card-text">Total Processes</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${runningProcesses}</h5>
                            <p class="card-text">Running</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${totalCpu.toFixed(1)}%</h5>
                            <p class="card-text">Total CPU</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${totalMemory.toFixed(1)}%</h5>
                            <p class="card-text">Total Memory</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Processes Table
        html += `
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-list me-2"></i>Process List
                        <span class="badge bg-secondary ms-2" id="processCount">${processCount}</span>
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="processesTable">
                            <thead class="table-dark">
                                <tr>
                                    <th onclick="sortProcesses('pid')" style="cursor: pointer;">
                                        PID <i class="fas fa-sort"></i>
                                    </th>
                                    <th onclick="sortProcesses('user')" style="cursor: pointer;">
                                        User <i class="fas fa-sort"></i>
                                    </th>
                                    <th onclick="sortProcesses('cpu')" style="cursor: pointer;">
                                        CPU % <i class="fas fa-sort"></i>
                                    </th>
                                    <th onclick="sortProcesses('memory')" style="cursor: pointer;">
                                        Memory % <i class="fas fa-sort"></i>
                                    </th>
                                    <th onclick="sortProcesses('state')" style="cursor: pointer;">
                                        State <i class="fas fa-sort"></i>
                                    </th>
                                    <th onclick="sortProcesses('name')" style="cursor: pointer;">
                                        Process Name <i class="fas fa-sort"></i>
                                    </th>
                                    <th>Command</th>
                                </tr>
                            </thead>
                            <tbody id="processesTableBody">
        `;
        
        // Add processes to table
        processesData.forEach((process, index) => {
            const pid = process.pid || process.PID || 'N/A';
            const user = process.user || process.USER || 'unknown';
            const cpu = parseFloat(process.cpuPercent || process.cpu || process.CPU || process['%CPU'] || 0).toFixed(1);
            const memory = parseFloat(process.memoryPercent || process.memory || process.MEM || process['%MEM'] || 0).toFixed(1);
            const state = process.stat || process.state || process.STAT || process.status || 'N/A';
            const name = process.name || process.COMMAND || process.command || process.CMD || 'N/A';
            const command = process.command || process.COMMAND || process.args || process.CMD || name;
            
            // Determine state badge color
            let stateBadge = 'secondary';
            if (state.includes('R')) stateBadge = 'success';
            else if (state.includes('S')) stateBadge = 'primary';
            else if (state.includes('Z')) stateBadge = 'danger';
            else if (state.includes('T')) stateBadge = 'warning';
            
            // Determine CPU usage color
            let cpuClass = '';
            if (parseFloat(cpu) > 50) cpuClass = 'text-danger fw-bold';
            else if (parseFloat(cpu) > 20) cpuClass = 'text-warning fw-bold';
            else if (parseFloat(cpu) > 5) cpuClass = 'text-info';
            
            // Determine memory usage color
            let memClass = '';
            if (parseFloat(memory) > 50) memClass = 'text-danger fw-bold';
            else if (parseFloat(memory) > 20) memClass = 'text-warning fw-bold';
            else if (parseFloat(memory) > 5) memClass = 'text-info';
            
            html += `
                <tr class="process-row" data-pid="${pid}" data-user="${user}" data-cpu="${cpu}" data-memory="${memory}" data-name="${name.toLowerCase()}" data-command="${command.toLowerCase()}">
                    <td><span class="badge bg-light text-dark">${pid}</span></td>
                    <td><span class="badge bg-secondary" style="text-transform: none;">${user}</span></td>
                    <td><span class="${cpuClass}">${cpu}%</span></td>
                    <td><span class="${memClass}">${memory}%</span></td>
                    <td><span class="badge bg-${stateBadge}">${state}</span></td>
                    <td><strong>${name}</strong></td>
                    <td><small class="text-muted" title="${command}">${command.length > 60 ? command.substring(0, 60) + '...' : command}</small></td>
                </tr>
            `;
        });
        
        html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        
        // Populate user filter dropdown
        setTimeout(() => {
            const userFilter = document.getElementById('userFilter');
            if (userFilter) {
                uniqueUsers.sort().forEach(user => {
                    const option = document.createElement('option');
                    option.value = user;
                    option.textContent = user;
                    userFilter.appendChild(option);
                });
            }
        }, 100);
        
    } else {
        html += `
            <div class="card shadow">
                <div class="card-body text-center py-5">
                    <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted mb-3">No Process Data Available</h5>
                    <p class="text-muted">No running processes data found in the uploaded artifacts.</p>
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Expected Data:</strong> Upload artifacts containing process information (ps, top, htop output) to view running processes.
                    </div>
                </div>
            </div>
        `;
    }
    
    contentArea.innerHTML = html;
}

function renderProcessHunting(data) {
    const contentArea = document.getElementById('content-area');
    
    let html = `
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="h4 mb-3">
                    <i class="fas fa-search me-2"></i>Process Hunting
                </h2>
            </div>
        </div>
        
        <!-- Process Hunting Analysis Guide -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark py-2">
                        <h6 class="m-0">
                            <i class="fas fa-info-circle me-2"></i>Process Hunting Analysis Guide
                            <button class="btn btn-sm btn-outline-dark float-end" type="button" data-bs-toggle="collapse" data-bs-target="#huntingGuide" aria-expanded="false">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </h6>
                    </div>
                    <div class="collapse" id="huntingGuide">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary"><i class="fas fa-fingerprint me-2"></i>Hash Analysis</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><strong>SHA256:</strong> Primary hash for file identification</li>
                                        <li class="mb-2"><strong>MD5:</strong> Legacy hash for quick comparison</li>
                                        <li class="mb-2"><strong>Known Good:</strong> Compare against baseline hashes</li>
                                        <li class="mb-2"><strong>Suspicious:</strong> Unknown or modified binaries</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-primary"><i class="fas fa-shield-alt me-2"></i>Security Indicators</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><strong>File Path:</strong> Unusual locations (/tmp, /var/tmp)</li>
                                        <li class="mb-2"><strong>Permissions:</strong> Executable files with unusual permissions</li>
                                        <li class="mb-2"><strong>Timestamps:</strong> Recent modifications or access times</li>
                                        <li class="mb-2"><strong>Size:</strong> Unusually large or small binaries</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="alert alert-warning mt-3 mb-0">
                                <small class="text-muted">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    <strong>Investigation Focus:</strong> Look for processes in unusual locations, 
                                    recently modified binaries, or executables with suspicious hash values. 
                                    Cross-reference with threat intelligence databases.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Process Hunting Filters -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white py-2">
                        <h6 class="m-0">
                            <i class="fas fa-filter me-2"></i>Hunting Filters
                            <button class="btn btn-sm btn-outline-light float-end" type="button" data-bs-toggle="collapse" data-bs-target="#huntingFilters" aria-expanded="true">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </h6>
                    </div>
                    <div class="collapse show" id="huntingFilters">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <label for="huntingSearch" class="form-label">Search Processes</label>
                                    <input type="text" class="form-control" id="huntingSearch" placeholder="Search by path, hash, or size..." onkeyup="filterProcessHunting()">
                                </div>
                                <div class="col-md-2">
                                    <label for="pathFilter" class="form-label">Path Contains</label>
                                    <select class="form-select" id="pathFilter" onchange="filterProcessHunting()">
                                        <option value="">All Paths</option>
                                        <option value="/tmp">/tmp</option>
                                        <option value="/var/tmp">/var/tmp</option>
                                        <option value="/usr/bin">/usr/bin</option>
                                        <option value="/sbin">/sbin</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="sizeFilter" class="form-label">Min Size (KB)</label>
                                    <input type="number" class="form-control" id="sizeFilter" placeholder="0" min="0" onchange="filterProcessHunting()">
                                </div>
                                <div class="col-md-2">
                                    <label for="permissionFilter" class="form-label">Permissions</label>
                                    <select class="form-select" id="permissionFilter" onchange="filterProcessHunting()">
                                        <option value="">All Permissions</option>
                                        <option value="755">755 (rwxr-xr-x)</option>
                                        <option value="777">777 (rwxrwxrwx)</option>
                                        <option value="4755">4755 (setuid)</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-secondary" onclick="clearHuntingFilters()">
                                            <i class="fas fa-times me-1"></i>Clear
                                        </button>
                                        <button class="btn btn-outline-info" onclick="exportProcessHunting()">
                                            <i class="fas fa-download me-1"></i>Export
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Find process hunting data
    let huntingData = null;
    let processCount = 0;
    
    const dataSource = data || {};
    
    for (const [filename, fileData] of Object.entries(dataSource)) {
        if (filename.includes('process_hunting_data') && filename.endsWith('.json') && fileData) {
            if (Array.isArray(fileData)) {
                huntingData = fileData;
            } else if (fileData.data && Array.isArray(fileData.data)) {
                huntingData = fileData.data;
            }
            break;
        }
    }
    
    if (huntingData && huntingData.length > 0) {
        processCount = huntingData.length;
        
        // Calculate statistics
        const totalSize = huntingData.reduce((sum, p) => sum + (p.metadata?.size || 0), 0);
        const avgSize = totalSize / processCount;
        const uniquePaths = [...new Set(huntingData.map(p => p.metadata?.path?.split('/').slice(0, -1).join('/') || 'unknown'))];
        const recentFiles = huntingData.filter(p => {
            const mtime = p.metadata?.mtime || 0;
            const dayAgo = Date.now() / 1000 - 86400;
            return mtime > dayAgo;
        }).length;
        
        // Statistics Cards
        html += `
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${processCount}</h5>
                            <p class="card-text">Total Processes</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${uniquePaths.length}</h5>
                            <p class="card-text">Unique Paths</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${(avgSize / 1024).toFixed(1)}KB</h5>
                            <p class="card-text">Avg Size</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${recentFiles}</h5>
                            <p class="card-text">Recent Files</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Process Hunting Table
        html += `
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-list me-2"></i>Process Hunting Results
                        <span class="badge bg-secondary ms-2" id="huntingCount">${processCount}</span>
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="huntingTable">
                            <thead class="table-dark">
                                <tr>
                                    <th onclick="sortProcessHunting('path')" style="cursor: pointer;">
                                        Path <i class="fas fa-sort"></i>
                                    </th>
                                    <th onclick="sortProcessHunting('size')" style="cursor: pointer;">
                                        Size <i class="fas fa-sort"></i>
                                    </th>
                                    <th onclick="sortProcessHunting('permissions')" style="cursor: pointer;">
                                        Permissions <i class="fas fa-sort"></i>
                                    </th>
                                    <th onclick="sortProcessHunting('mtime')" style="cursor: pointer;">
                                        Modified <i class="fas fa-sort"></i>
                                    </th>
                                    <th>SHA256 Hash</th>
                                    <th>MD5 Hash</th>
                                </tr>
                            </thead>
                            <tbody id="huntingTableBody">
        `;
        
        // Add hunting data to table
        huntingData.forEach((process, index) => {
            const metadata = process.metadata || {};
            const hashes = process.hashes || {};
            
            const path = metadata.path || 'N/A';
            const size = metadata.size || 0;
            const mode = metadata.mode || '0o000000';
            const mtime = metadata.mtime || 0;
            const sha256 = hashes.sha256 || 'N/A';
            const md5 = hashes.md5 || 'N/A';
            
            // Format size
            const sizeFormatted = size > 1024 * 1024 ? 
                `${(size / (1024 * 1024)).toFixed(1)} MB` : 
                size > 1024 ? 
                `${(size / 1024).toFixed(1)} KB` : 
                `${size} B`;
            
            // Format permissions
            const permissions = mode.replace('0o', '');
            
            // Format timestamp
            const modifiedDate = mtime > 0 ? new Date(mtime * 1000).toLocaleString() : 'N/A';
            
            // Determine if path is suspicious
            let pathClass = '';
            if (path.includes('/tmp') || path.includes('/var/tmp')) {
                pathClass = 'text-warning fw-bold';
            }
            
            // Determine if size is unusual
            let sizeClass = '';
            if (size > 10 * 1024 * 1024) { // > 10MB
                sizeClass = 'text-danger fw-bold';
            } else if (size < 1024) { // < 1KB
                sizeClass = 'text-warning';
            }
            
            html += `
                <tr class="hunting-row" data-path="${path.toLowerCase()}" data-size="${size}" data-permissions="${permissions}" data-mtime="${mtime}">
                    <td class="${pathClass}">
                        <i class="fas fa-file-code me-1"></i>
                        <span title="${path}">${path.length > 50 ? path.substring(0, 47) + '...' : path}</span>
                    </td>
                    <td class="${sizeClass}">${sizeFormatted}</td>
                    <td>
                        <span class="badge bg-secondary">${permissions}</span>
                    </td>
                    <td>${modifiedDate}</td>
                    <td>
                        <small class="font-monospace text-muted" title="${sha256}">
                            ${sha256.substring(0, 16)}...
                        </small>
                    </td>
                    <td>
                        <small class="font-monospace text-muted" title="${md5}">
                            ${md5.substring(0, 16)}...
                        </small>
                    </td>
                </tr>
            `;
        });
        
        html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        
        // Store original data for filtering
        window.huntingOriginalData = huntingData;
        
    } else {
        html += `
            <div class="alert alert-warning" role="alert">
                <h4 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>No Process Hunting Data Available</h4>
                <p class="mb-0">No process hunting data found in the uploaded artifacts.</p>
                <hr>
                <p class="mb-0">
                    <strong>Expected Data:</strong> Upload artifacts containing process hunting information 
                    (process_hunting_data_*.json files) to view detailed process analysis.
                </p>
            </div>
        `;
    }
    
    contentArea.innerHTML = html;
}

















// }





// Process filtering and sorting functions
let processesOriginalData = [];
let huntingOriginalData = [];
let huntingSortOrder = {};

// Process Hunting filtering and sorting functions
function filterProcessHunting() {
    const searchTerm = document.getElementById('huntingSearch').value.toLowerCase();
    const pathFilter = document.getElementById('pathFilter').value;
    const sizeFilter = parseInt(document.getElementById('sizeFilter').value) || 0;
    const permissionFilter = document.getElementById('permissionFilter').value;
    
    const rows = document.querySelectorAll('.hunting-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const path = row.dataset.path;
        const size = parseInt(row.dataset.size) || 0;
        const permissions = row.dataset.permissions;
        const rowText = row.textContent.toLowerCase();
        
        let show = true;
        
        // Search filter
        if (searchTerm && !rowText.includes(searchTerm)) {
            show = false;
        }
        
        // Path filter
        if (pathFilter && !path.includes(pathFilter.toLowerCase())) {
            show = false;
        }
        
        // Size filter (in KB)
        if (sizeFilter > 0 && size < sizeFilter * 1024) {
            show = false;
        }
        
        // Permission filter
        if (permissionFilter && !permissions.includes(permissionFilter)) {
            show = false;
        }
        
        row.style.display = show ? '' : 'none';
        if (show) visibleCount++;
    });
    
    // Update count
    const countElement = document.getElementById('huntingCount');
    if (countElement) {
        countElement.textContent = visibleCount;
    }
}

function sortProcessHunting(column) {
    const table = document.getElementById('huntingTable');
    const tbody = document.getElementById('huntingTableBody');
    const rows = Array.from(tbody.querySelectorAll('.hunting-row'));
    
    // Toggle sort order
    huntingSortOrder[column] = huntingSortOrder[column] === 'asc' ? 'desc' : 'asc';
    const isAsc = huntingSortOrder[column] === 'asc';
    
    rows.sort((a, b) => {
        let aVal, bVal;
        
        switch (column) {
            case 'path':
                aVal = a.dataset.path;
                bVal = b.dataset.path;
                break;
            case 'size':
                aVal = parseInt(a.dataset.size) || 0;
                bVal = parseInt(b.dataset.size) || 0;
                break;
            case 'permissions':
                aVal = a.dataset.permissions;
                bVal = b.dataset.permissions;
                break;
            case 'mtime':
                aVal = parseInt(a.dataset.mtime) || 0;
                bVal = parseInt(b.dataset.mtime) || 0;
                break;
            default:
                return 0;
        }
        
        if (typeof aVal === 'string') {
            return isAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        } else {
            return isAsc ? aVal - bVal : bVal - aVal;
        }
    });
    
    // Clear and re-append sorted rows
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
    
    // Update sort indicators
    const headers = table.querySelectorAll('th[onclick]');
    headers.forEach(header => {
        const icon = header.querySelector('i');
        if (header.textContent.toLowerCase().includes(column)) {
            icon.className = `fas fa-sort-${isAsc ? 'up' : 'down'}`;
        } else {
            icon.className = 'fas fa-sort';
        }
    });
}

function clearHuntingFilters() {
    document.getElementById('huntingSearch').value = '';
    document.getElementById('pathFilter').value = '';
    document.getElementById('sizeFilter').value = '';
    document.getElementById('permissionFilter').value = '';
    filterProcessHunting();
}

function exportProcessHunting() {
    if (!window.huntingOriginalData || window.huntingOriginalData.length === 0) {
        alert('No process hunting data available to export.');
        return;
    }
    
    // Create CSV content
    const headers = ['Path', 'Size (Bytes)', 'Permissions', 'Modified Time', 'SHA256', 'MD5', 'UID', 'GID', 'Inode', 'Device'];
    let csvContent = headers.join(',') + '\n';
    
    window.huntingOriginalData.forEach(process => {
        const metadata = process.metadata || {};
        const hashes = process.hashes || {};
        
        const row = [
            `"${metadata.path || 'N/A'}"`,
            metadata.size || 0,
            `"${metadata.mode || 'N/A'}"`,
            metadata.mtime || 0,
            `"${hashes.sha256 || 'N/A'}"`,
            `"${hashes.md5 || 'N/A'}"`,
            metadata.uid || 0,
            metadata.gid || 0,
            metadata.inode || 0,
            metadata.device || 0
        ];
        csvContent += row.join(',') + '\n';
    });
    
    // Create and download file
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `process_hunting_export_${new Date().toISOString().slice(0, 10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
let processesSortOrder = {};

function filterProcesses() {
    const searchTerm = document.getElementById('processSearch').value.toLowerCase();
    const userFilter = document.getElementById('userFilter').value;
    const cpuThreshold = parseFloat(document.getElementById('cpuThreshold').value) || 0;
    const memoryThreshold = parseFloat(document.getElementById('memoryThreshold').value) || 0;
    
    const rows = document.querySelectorAll('.process-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const pid = row.dataset.pid;
        const user = row.dataset.user;
        const cpu = parseFloat(row.dataset.cpu);
        const memory = parseFloat(row.dataset.memory);
        const name = row.dataset.name;
        const command = row.dataset.command;
        
        let visible = true;
        
        // Search filter
        if (searchTerm && !name.includes(searchTerm) && !command.includes(searchTerm) && !user.toLowerCase().includes(searchTerm) && !pid.includes(searchTerm)) {
            visible = false;
        }
        
        // User filter
        if (userFilter && user !== userFilter) {
            visible = false;
        }
        
        // CPU threshold filter
        if (cpu < cpuThreshold) {
            visible = false;
        }
        
        // Memory threshold filter
        if (memory < memoryThreshold) {
            visible = false;
        }
        
        row.style.display = visible ? '' : 'none';
        if (visible) visibleCount++;
    });
    
    // Update process count
    const countBadge = document.getElementById('processCount');
    if (countBadge) {
        countBadge.textContent = visibleCount;
    }
}

function sortProcesses(column) {
    const table = document.getElementById('processesTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Toggle sort order
    processesSortOrder[column] = processesSortOrder[column] === 'asc' ? 'desc' : 'asc';
    const isAscending = processesSortOrder[column] === 'asc';
    
    // Update sort icons
    table.querySelectorAll('th i.fas').forEach(icon => {
        icon.className = 'fas fa-sort';
    });
    
    const currentHeader = table.querySelector(`th[onclick="sortProcesses('${column}')"] i`);
    if (currentHeader) {
        currentHeader.className = `fas fa-sort-${isAscending ? 'up' : 'down'}`;
    }
    
    rows.sort((a, b) => {
        let aVal, bVal;
        
        switch (column) {
            case 'pid':
                aVal = parseInt(a.dataset.pid) || 0;
                bVal = parseInt(b.dataset.pid) || 0;
                break;
            case 'user':
                aVal = a.dataset.user.toLowerCase();
                bVal = b.dataset.user.toLowerCase();
                break;
            case 'cpu':
                aVal = parseFloat(a.dataset.cpu) || 0;
                bVal = parseFloat(b.dataset.cpu) || 0;
                break;
            case 'memory':
                aVal = parseFloat(a.dataset.memory) || 0;
                bVal = parseFloat(b.dataset.memory) || 0;
                break;
            case 'state':
                aVal = a.querySelector('td:nth-child(5)').textContent.toLowerCase();
                bVal = b.querySelector('td:nth-child(5)').textContent.toLowerCase();
                break;
            case 'name':
                aVal = a.dataset.name;
                bVal = b.dataset.name;
                break;
            default:
                return 0;
        }
        
        if (typeof aVal === 'string') {
            return isAscending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        } else {
            return isAscending ? aVal - bVal : bVal - aVal;
        }
    });
    
    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
}

function clearProcessFilters() {
    document.getElementById('processSearch').value = '';
    document.getElementById('userFilter').value = '';
    document.getElementById('cpuThreshold').value = '';
    document.getElementById('memoryThreshold').value = '';
    filterProcesses();
}

function exportProcesses() {
    const table = document.getElementById('processesTable');
    if (!table) return;
    
    const rows = table.querySelectorAll('tr');
    let csv = '';
    
    // Add headers
    const headers = [];
    table.querySelectorAll('thead th').forEach(th => {
        headers.push(th.textContent.replace(/\s+/g, ' ').trim());
    });
    csv += headers.join(',') + '\n';
    
    // Add visible data rows
    table.querySelectorAll('tbody tr').forEach(row => {
        if (row.style.display !== 'none') {
            const cells = [];
            row.querySelectorAll('td').forEach(td => {
                let cellText = td.textContent.replace(/\s+/g, ' ').trim();
                // Escape commas and quotes
                if (cellText.includes(',') || cellText.includes('"')) {
                    cellText = '"' + cellText.replace(/"/g, '""') + '"';
                }
                cells.push(cellText);
            });
            csv += cells.join(',') + '\n';
        }
    });
    
    // Download CSV
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `processes_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function renderServices(data) {
    const contentArea = document.getElementById('content-area');
    
    let html = `
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="h4 mb-3">
                    <i class="fas fa-cogs me-2"></i>System Services
                </h2>
            </div>
        </div>
        
        <!-- Services Analysis Guide -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white py-2">
                        <h6 class="m-0">
                            <i class="fas fa-info-circle me-2"></i>Services Analysis Guide
                            <button class="btn btn-sm btn-outline-light float-end" type="button" data-bs-toggle="collapse" data-bs-target="#servicesGuide" aria-expanded="false">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </h6>
                    </div>
                    <div class="collapse" id="servicesGuide">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary"><i class="fas fa-chart-line me-2"></i>Service States</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><span class="badge bg-success me-2">active</span> Service is running and operational</li>
                                        <li class="mb-2"><span class="badge bg-secondary me-2">inactive</span> Service is stopped</li>
                                        <li class="mb-2"><span class="badge bg-warning me-2">failed</span> Service failed to start or crashed</li>
                                        <li class="mb-2"><span class="badge bg-info me-2">activating</span> Service is starting up</li>
                                        <li class="mb-2"><span class="badge bg-dark me-2">deactivating</span> Service is shutting down</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-primary"><i class="fas fa-shield-alt me-2"></i>Load States</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><strong>loaded:</strong> Unit configuration loaded successfully</li>
                                        <li class="mb-2"><strong>not-found:</strong> Unit file not found</li>
                                        <li class="mb-2"><strong>bad-setting:</strong> Configuration error in unit file</li>
                                        <li class="mb-2"><strong>error:</strong> Error loading unit configuration</li>
                                        <li class="mb-2"><strong>masked:</strong> Unit is masked and cannot be started</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="alert alert-light mt-3 mb-0">
                                <small class="text-muted">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    <strong>Investigation Tips:</strong> Look for failed services, unusual services running as root, 
                                    services with suspicious names, or services that should be running but are inactive. 
                                    Pay attention to services with recent start times or those running from unusual locations.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Services Filters -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white py-2">
                        <h6 class="m-0">
                            <i class="fas fa-filter me-2"></i>Service Filters
                            <button class="btn btn-sm btn-outline-light float-end" type="button" data-bs-toggle="collapse" data-bs-target="#servicesFilters" aria-expanded="true">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </h6>
                    </div>
                    <div class="collapse show" id="servicesFilters">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="serviceSearch" class="form-label">Search Services</label>
                                    <input type="text" class="form-control" id="serviceSearch" placeholder="Search by name or description..." onkeyup="filterServices()">
                                </div>
                                <div class="col-md-2">
                                    <label for="loadStateFilter" class="form-label">Load State</label>
                                    <select class="form-select" id="loadStateFilter" onchange="filterServices()">
                                        <option value="">All States</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="activeStateFilter" class="form-label">Active State</label>
                                    <select class="form-select" id="activeStateFilter" onchange="filterServices()">
                                        <option value="">All States</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="subStateFilter" class="form-label">Sub State</label>
                                    <select class="form-select" id="subStateFilter" onchange="filterServices()">
                                        <option value="">All States</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-secondary" onclick="clearServicesFilters()">
                                            <i class="fas fa-times me-1"></i>Clear
                                        </button>
                                        <button class="btn btn-outline-info" onclick="exportServices()">
                                            <i class="fas fa-download me-1"></i>Export
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Find services data
    let servicesData = null;
    let serviceCount = 0;
    
    // Data is already extracted by renderSectionContent, use it directly
    const dataSource = data || {};
    
    console.log('Services data received:', dataSource); // Debug log
    
    for (const [filename, fileData] of Object.entries(dataSource)) {
        console.log('Processing file:', filename, fileData); // Debug log
        // Look specifically for systemdServices_*.json files
        if (filename.includes('systemdServices') && fileData) {
            // Handle different data structures
            if (Array.isArray(fileData)) {
                servicesData = fileData;
            } else if (fileData.data && Array.isArray(fileData.data)) {
                servicesData = fileData.data;
            } else if (fileData.services && Array.isArray(fileData.services)) {
                servicesData = fileData.services;
            }
            console.log('Found services data:', servicesData); // Debug log
            break;
        }
    }
    
    if (servicesData && servicesData.length > 0) {
        serviceCount = servicesData.length;
        
        // Get unique states for filter dropdowns
        const uniqueLoadStates = [...new Set(servicesData.map(s => s.load_state || s.load || s.LOAD || 'unknown').filter(s => s))];
        const uniqueActiveStates = [...new Set(servicesData.map(s => s.active_state || s.active || s.ACTIVE || 'unknown').filter(s => s))];
        const uniqueSubStates = [...new Set(servicesData.map(s => s.sub_state || s.sub || s.SUB || 'unknown').filter(s => s))];
        
        // Statistics Cards
        const activeServices = servicesData.filter(s => (s.active_state || s.active || s.ACTIVE || '').toLowerCase() === 'active').length;
        const failedServices = servicesData.filter(s => (s.active_state || s.active || s.ACTIVE || '').toLowerCase() === 'failed').length;
        const loadedServices = servicesData.filter(s => (s.load_state || s.load || s.LOAD || '').toLowerCase() === 'loaded').length;
        
        html += `
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${serviceCount}</h5>
                            <p class="card-text">Total Services</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${activeServices}</h5>
                            <p class="card-text">Active</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${failedServices}</h5>
                            <p class="card-text">Failed</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${loadedServices}</h5>
                            <p class="card-text">Loaded</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Services Table
        html += `
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-list me-2"></i>Services List
                        <span class="badge bg-secondary ms-2" id="serviceCount">${serviceCount}</span>
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="servicesTable">
                            <thead class="table-dark">
                                <tr>
                                    <th onclick="sortServices('unit')" style="cursor: pointer;">
                                        Unit Name <i class="fas fa-sort"></i>
                                    </th>
                                    <th onclick="sortServices('load')" style="cursor: pointer;">
                                        Load State<i class="fas fa-sort"></i>
                                    </th>
                                    <th onclick="sortServices('active')" style="cursor: pointer;">
                                        Active State<i class="fas fa-sort"></i>
                                    </th>
                                    <th onclick="sortServices('sub')" style="cursor: pointer;">
                                        Sub State<i class="fas fa-sort"></i>
                                    </th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody id="servicesTableBody">
        `;
        
        // Add services to table
        servicesData.forEach((service, index) => {
            const unit = service.unit || service.UNIT || 'N/A';
            const load = service.load_state || service.load || service.LOAD || 'unknown';
            const active = service.active_state || service.active || service.ACTIVE || 'unknown';
            const sub = service.sub_state || service.sub || service.SUB || 'unknown';
            const description = service.description || service.DESCRIPTION || 'No description available';
            
            // Determine load state badge color
            let loadBadge = 'secondary';
            if (load.toLowerCase() === 'loaded') loadBadge = 'success';
            else if (load.toLowerCase() === 'not-found') loadBadge = 'warning';
            else if (load.toLowerCase() === 'error') loadBadge = 'danger';
            else if (load.toLowerCase() === 'masked') loadBadge = 'dark';
            
            // Determine active state badge color
            let activeBadge = 'secondary';
            if (active.toLowerCase() === 'active') activeBadge = 'success';
            else if (active.toLowerCase() === 'inactive') activeBadge = 'secondary';
            else if (active.toLowerCase() === 'failed') activeBadge = 'danger';
            else if (active.toLowerCase() === 'activating') activeBadge = 'info';
            else if (active.toLowerCase() === 'deactivating') activeBadge = 'warning';
            
            // Determine sub state badge color
            let subBadge = 'light text-dark';
            if (sub.toLowerCase() === 'running') subBadge = 'success';
            else if (sub.toLowerCase() === 'dead') subBadge = 'secondary';
            else if (sub.toLowerCase() === 'failed') subBadge = 'danger';
            else if (sub.toLowerCase() === 'exited') subBadge = 'info';
            
            html += `
                <tr class="service-row" data-unit="${unit.toLowerCase()}" data-load="${load.toLowerCase()}" data-active="${active.toLowerCase()}" data-sub="${sub.toLowerCase()}" data-description="${description.toLowerCase()}">
                    <td><strong>${unit}</strong></td>
                    <td><span class="badge bg-${loadBadge}">${load}</span></td>
                    <td><span class="badge bg-${activeBadge}">${active}</span></td>
                    <td><span class="badge bg-${subBadge}">${sub}</span></td>
                    <td><small class="text-muted" title="${description}">${description.length > 80 ? description.substring(0, 80) + '...' : description}</small></td>
                </tr>
            `;
        });
        
        html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        
        // Populate filter dropdowns
        setTimeout(() => {
            const loadStateFilter = document.getElementById('loadStateFilter');
            const activeStateFilter = document.getElementById('activeStateFilter');
            const subStateFilter = document.getElementById('subStateFilter');
            
            if (loadStateFilter) {
                uniqueLoadStates.sort().forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = state;
                    loadStateFilter.appendChild(option);
                });
            }
            
            if (activeStateFilter) {
                uniqueActiveStates.sort().forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = state;
                    activeStateFilter.appendChild(option);
                });
            }
            
            if (subStateFilter) {
                uniqueSubStates.sort().forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = state;
                    subStateFilter.appendChild(option);
                });
            }
        }, 100);
        
    } else {
        console.log('No services data found. Available files:', Object.keys(dataSource)); // Debug log
        html += `
            <div class="card shadow">
                <div class="card-body text-center py-5">
                    <i class="fas fa-cogs fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted mb-3">No Services Data Available</h5>
                    <p class="text-muted">No systemd services data found in the uploaded artifacts.</p>
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Expected Data:</strong> Upload artifacts containing systemd services information to view system services.
                        <br><small class="text-muted">Available files: ${Object.keys(dataSource).join(', ')}</small>
                    </div>
                </div>
            </div>
        `;
    }
    
    contentArea.innerHTML = html;
}

function renderTriggeredTasks(data) {
    const contentArea = document.getElementById('content-area');
    
    let html = `
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="h4 mb-3">
                    <i class="fas fa-clock me-2"></i>Triggered Tasks
                </h2>
            </div>
        </div>
        
        <!-- Triggered Tasks Analysis Guide -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white py-2">
                        <h6 class="m-0">
                            <i class="fas fa-info-circle me-2"></i>Triggered Tasks Analysis Guide
                            <button class="btn btn-sm btn-outline-light float-end" type="button" data-bs-toggle="collapse" data-bs-target="#triggeredTasksGuide" aria-expanded="false">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </h6>
                    </div>
                    <div class="collapse" id="triggeredTasksGuide">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary"><i class="fas fa-chart-line me-2"></i>Key Analysis Points</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><strong>Next Run Time:</strong> When the task is scheduled to execute next</li>
                                        <li class="mb-2"><strong>Time Left:</strong> Remaining time until next execution</li>
                                        <li class="mb-2"><strong>Last Run:</strong> When the task was last executed</li>
                                        <li class="mb-2"><strong>Passed Time:</strong> Time since last execution</li>
                                        <li class="mb-2"><strong>Unit Name:</strong> The systemd unit/service name</li>
                                        <li class="mb-2"><strong>Activates:</strong> What the task triggers or activates</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-primary"><i class="fas fa-shield-alt me-2"></i>Security Considerations</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><strong>Suspicious Timing:</strong> Tasks scheduled at unusual times</li>
                                        <li class="mb-2"><strong>Unknown Units:</strong> Unfamiliar or custom systemd units</li>
                                        <li class="mb-2"><strong>Frequent Execution:</strong> Tasks running too frequently</li>
                                        <li class="mb-2"><strong>System Access:</strong> Tasks with elevated privileges</li>
                                        <li class="mb-2"><strong>External Triggers:</strong> Tasks activated by external events</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <small class="text-muted">
                                        <i class="fas fa-lightbulb me-1"></i>
                                        <strong>Investigation Tips:</strong> Look for tasks with unusual schedules, unknown units, 
                                        or those that activate suspicious services. Pay attention to tasks that run frequently 
                                        or have been recently modified.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Find triggered tasks data
    let triggeredTasksData = [];
    let taskCount = 0;
    
    // Handle data format - backend returns array directly
    if (Array.isArray(data)) {
        triggeredTasksData = data;
    } else if (data && Array.isArray(data.data)) {
        triggeredTasksData = data.data;
    } else {
        // Fallback: Look for triggered_tasks_data files in object format
        for (const [filename, fileData] of Object.entries(data || {})) {
            if (filename.includes('triggered_tasks_data') && filename.endsWith('.json') && fileData) {
                if (Array.isArray(fileData)) {
                    triggeredTasksData = fileData;
                } else if (fileData.data && Array.isArray(fileData.data)) {
                    triggeredTasksData = fileData.data;
                }
                break;
            }
        }
    }
    
    if (triggeredTasksData && triggeredTasksData.length > 0) {
        taskCount = triggeredTasksData.length;
        
        // Statistics Cards
        const activeTasks = triggeredTasksData.filter(t => t.next && t.next !== 'n/a').length;
        const recentTasks = triggeredTasksData.filter(t => t.last && t.last !== 'n/a').length;
        const systemTasks = triggeredTasksData.filter(t => t.unit && t.unit.includes('system')).length;
        
        html += `
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${taskCount}</h5>
                            <p class="card-text">Total Tasks</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${activeTasks}</h5>
                            <p class="card-text">Scheduled</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${recentTasks}</h5>
                            <p class="card-text">Recently Run</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${systemTasks}</h5>
                            <p class="card-text">System Tasks</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Triggered Tasks Filters
        html += `
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white py-2">
                            <h6 class="m-0">
                                <i class="fas fa-filter me-2"></i>Task Filters
                                <button class="btn btn-sm btn-outline-light float-end" type="button" data-bs-toggle="collapse" data-bs-target="#taskFilters" aria-expanded="true">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </h6>
                        </div>
                        <div class="collapse show" id="taskFilters">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label for="taskSearch" class="form-label">Search Tasks:</label>
                                        <input type="text" class="form-control" id="taskSearch" placeholder="Search by unit name or activates..." onkeyup="filterTriggeredTasks()">
                                    </div>
                                    <div class="col-md-2">
                                        <label for="statusFilter" class="form-label">Status:</label>
                                        <select class="form-select" id="statusFilter" onchange="filterTriggeredTasks()">
                                            <option value="">All</option>
                                            <option value="scheduled">Scheduled</option>
                                            <option value="recent">Recently Run</option>
                                            <option value="inactive">Inactive</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label for="unitTypeFilter" class="form-label">Unit Type:</label>
                                        <select class="form-select" id="unitTypeFilter" onchange="filterTriggeredTasks()">
                                            <option value="">All</option>
                                            <option value="timer">Timer</option>
                                            <option value="service">Service</option>
                                            <option value="target">Target</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-outline-secondary mt-4" onclick="clearTaskFilters()">
                                            <i class="fas fa-times me-1"></i>Clear
                                        </button>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Filtered Count:</label>
                                        <div class="badge bg-info fs-6" id="taskCount">${taskCount}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Triggered Tasks Table
        html += `
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover mb-0" id="triggeredTasksTable">
                                    <thead class="table-dark sticky-top">
                                        <tr>
                                            <th class="sticky-top" onclick="sortTriggeredTasks('status')" style="cursor: pointer;">
                                                Status <i class="fas fa-sort"></i>
                                            </th>
                                            <th class="sticky-top" onclick="sortTriggeredTasks('next')" style="cursor: pointer;">
                                                Next Run <i class="fas fa-sort"></i>
                                            </th>
                                            <th class="sticky-top" onclick="sortTriggeredTasks('left')" style="cursor: pointer;">
                                                Time Left <i class="fas fa-sort"></i>
                                            </th>
                                            <th class="sticky-top" onclick="sortTriggeredTasks('last')" style="cursor: pointer;">
                                                Last Run <i class="fas fa-sort"></i>
                                            </th>
                                            <th class="sticky-top" onclick="sortTriggeredTasks('passed')" style="cursor: pointer;">
                                                Time Passed <i class="fas fa-sort"></i>
                                            </th>
                                            <th class="sticky-top" onclick="sortTriggeredTasks('unit')" style="cursor: pointer;">
                                                Unit <i class="fas fa-sort"></i>
                                            </th>
                                            <th class="sticky-top" onclick="sortTriggeredTasks('activates')" style="cursor: pointer;">
                                                Activates <i class="fas fa-sort"></i>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
        `;
        
        triggeredTasksData.forEach((task, index) => {
            // Parse the data correctly based on actual JSON structure
            const nextDay = task.next || 'n/a';
            const nextDate = task.left || 'n/a';
            const lastTime = task.last || 'n/a';
            const timezone = task.passed || 'n/a';
            const interval = task.unit || 'unknown';
            const activatesInfo = task.activates || 'n/a';
            
            // Combine next run information
            const nextRun = nextDay !== 'n/a' && nextDate !== 'n/a' ? `${nextDay} ${nextDate}` : 'n/a';
            
            // Extract time left from activates field (first part before space)
             let timeLeft = 'n/a';
             if (activatesInfo !== 'n/a') {
                 const parts = activatesInfo.split(' ');
                 // Look for time duration patterns like "13min", "2h", "20h", "2 days", "3 weeks"
                 if (parts.length > 0) {
                     if (parts[0].match(/^\d+min$|^\d+h$|^\d+s$/)) {
                         timeLeft = parts[0];
                     } else if (parts[0].match(/^\d+$/) && parts.length > 1 && (parts[1] === 'days' || parts[1] === 'weeks')) {
                         timeLeft = `${parts[0]} ${parts[1]}`;
                     } else if (interval && interval.match(/^\d+min$|^\d+h$/)) {
                         // Use interval as fallback for time left
                         timeLeft = interval;
                     }
                 }
             }
            
            // Extract last run info from activates field
            let lastRun = 'n/a';
            let timePassed = 'n/a';
            if (activatesInfo !== 'n/a') {
                // Look for date pattern in activates
                const dateMatch = activatesInfo.match(/(\w{3} \d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2} \w+)/);
                if (dateMatch) {
                    lastRun = dateMatch[1];
                    // Extract time passed (look for pattern like "4min 32s ago")
                    const timePassedMatch = activatesInfo.match(/(\d+\w+\s+\d+\w+\s+ago)/);
                    if (timePassedMatch) {
                        timePassed = timePassedMatch[1];
                    }
                } else if (lastTime !== 'n/a') {
                    lastRun = `${lastTime} ${timezone}`;
                }
            }
            
            // Extract unit names from activates field
            let unitNames = 'unknown';
            if (activatesInfo !== 'n/a') {
                const timerMatch = activatesInfo.match(/([\w-]+\.timer)/);
                const serviceMatch = activatesInfo.match(/([\w-]+\.service)/);
                if (timerMatch && serviceMatch) {
                    unitNames = `${timerMatch[1]}  ${serviceMatch[1]}`;
                } else if (timerMatch) {
                    unitNames = timerMatch[1];
                } else if (serviceMatch) {
                    unitNames = serviceMatch[1];
                }
            }
            
            // Determine status for filtering
            let status = 'inactive';
            if (nextRun !== 'n/a') status = 'scheduled';
            else if (lastRun !== 'n/a') status = 'recent';
            
            // Determine unit type
            let unitType = 'other';
            if (unitNames.includes('.timer')) unitType = 'timer';
            else if (unitNames.includes('.service')) unitType = 'service';
            else if (unitNames.includes('.target')) unitType = 'target';
            
            // Status badge
            let statusBadge = '';
            if (status === 'scheduled') {
                statusBadge = '<span class="badge bg-success">Scheduled</span>';
            } else if (status === 'recent') {
                statusBadge = '<span class="badge bg-info">Recent</span>';
            } else {
                statusBadge = '<span class="badge bg-secondary">Inactive</span>';
            }
            
            html += `
                <tr class="triggered-task-row" 
                    data-next="${nextRun}" 
                    data-left="${timeLeft}" 
                    data-last="${lastRun}" 
                    data-passed="${timePassed}" 
                    data-unit="${unitNames}" 
                    data-activates="${activatesInfo}"
                    data-status="${status}"
                    data-unit-type="${unitType}">
                    <td>${statusBadge}</td>
                    <td>${nextRun}</td>
                    <td>${timeLeft}</td>
                    <td>${lastRun}</td>
                    <td>${timePassed}</td>
                    <td><code>${unitNames}</code></td>
                    <td class="text-truncate" style="max-width: 300px;" title="${activatesInfo}">${interval}</td>
                </tr>
            `;
        });
        
        html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else {
        html += `
            <div class="row">
                <div class="col-12">
                    <div class="alert alert-info text-center" role="alert">
                        <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted mb-3">No Triggered Tasks Data Available</h5>
                        <p class="text-muted">No triggered tasks data found in the uploaded artifacts.</p>
                        <p class="text-muted">
                            <strong>Expected Data:</strong> Upload artifacts containing triggered tasks information 
                            (triggered_tasks_data_*.json files) to view system scheduled tasks.
                        </p>
                    </div>
                </div>
            </div>
        `;
    }
    
    contentArea.innerHTML = html;
}

// Services filtering and sorting functions
let servicesOriginalData = [];
let servicesSortOrder = {};

function filterServices() {
    const searchTerm = document.getElementById('serviceSearch').value.toLowerCase();
    const loadStateFilter = document.getElementById('loadStateFilter').value.toLowerCase();
    const activeStateFilter = document.getElementById('activeStateFilter').value.toLowerCase();
    const subStateFilter = document.getElementById('subStateFilter').value.toLowerCase();
    
    const rows = document.querySelectorAll('.service-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const unit = row.dataset.unit;
        const load = row.dataset.load;
        const active = row.dataset.active;
        const sub = row.dataset.sub;
        const description = row.dataset.description;
        
        let visible = true;
        
        // Search filter
        if (searchTerm && !unit.includes(searchTerm) && !description.includes(searchTerm)) {
            visible = false;
        }
        
        // Load state filter
        if (loadStateFilter && load !== loadStateFilter) {
            visible = false;
        }
        
        // Active state filter
        if (activeStateFilter && active !== activeStateFilter) {
            visible = false;
        }
        
        // Sub state filter
        if (subStateFilter && sub !== subStateFilter) {
            visible = false;
        }
        
        row.style.display = visible ? '' : 'none';
        if (visible) visibleCount++;
    });
    
    // Update service count
    const countBadge = document.getElementById('serviceCount');
    if (countBadge) {
        countBadge.textContent = visibleCount;
    }
}

// Triggered Tasks Functions
let triggeredTasksOriginalData = [];
let triggeredTasksSortOrder = {};

function filterTriggeredTasks() {
    const searchTerm = document.getElementById('taskSearch').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value.toLowerCase();
    const unitTypeFilter = document.getElementById('unitTypeFilter').value.toLowerCase();
    
    const rows = document.querySelectorAll('.triggered-task-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const unit = row.dataset.unit;
        const activates = row.dataset.activates;
        const status = row.dataset.status;
        const unitType = row.dataset.unitType;
        
        let visible = true;
        
        // Search filter
        if (searchTerm && !unit.toLowerCase().includes(searchTerm) && !activates.toLowerCase().includes(searchTerm)) {
            visible = false;
        }
        
        // Status filter
        if (statusFilter && status !== statusFilter) {
            visible = false;
        }
        
        // Unit type filter
        if (unitTypeFilter && unitType !== unitTypeFilter) {
            visible = false;
        }
        
        row.style.display = visible ? '' : 'none';
        if (visible) visibleCount++;
    });
    
    // Update triggered tasks count
    const countBadge = document.getElementById('taskCount');
    if (countBadge) {
        countBadge.textContent = visibleCount;
    }
}

function clearTaskFilters() {
    document.getElementById('taskSearch').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('unitTypeFilter').value = '';
    filterTriggeredTasks();
}

function sortTriggeredTasks(column) {
    const table = document.querySelector('#triggeredTasksTable tbody');
    const rows = Array.from(table.querySelectorAll('.triggered-task-row'));
    
    // Determine sort order
    const currentOrder = triggeredTasksSortOrder[column] || 'asc';
    const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
    triggeredTasksSortOrder = { [column]: newOrder };
    
    // Update sort indicators
    document.querySelectorAll('#triggeredTasksTable th .sort-indicator').forEach(indicator => {
        indicator.textContent = '';
    });
    const indicator = document.querySelector(`#triggeredTasksTable th[onclick*="${column}"] .sort-indicator`);
    if (indicator) {
        indicator.textContent = newOrder === 'asc' ? ' ' : ' ';
    }
    
    // Sort rows
    rows.sort((a, b) => {
        let aVal, bVal;
        
        switch (column) {
            case 'status':
                aVal = a.dataset.status;
                bVal = b.dataset.status;
                break;
            case 'unit':
                aVal = a.dataset.unit;
                bVal = b.dataset.unit;
                break;
            case 'next':
                aVal = a.dataset.next;
                bVal = b.dataset.next;
                break;
            case 'left':
                aVal = a.dataset.left;
                bVal = b.dataset.left;
                break;
            case 'last':
                aVal = a.dataset.last;
                bVal = b.dataset.last;
                break;
            case 'passed':
                aVal = a.dataset.passed;
                bVal = b.dataset.passed;
                break;
            case 'activates':
                aVal = a.dataset.activates;
                bVal = b.dataset.activates;
                break;
            default:
                return 0;
        }
        
        // Handle numeric sorting for time-related fields
        if (['next', 'left', 'last', 'passed'].includes(column)) {
            aVal = aVal === 'n/a' ? -1 : parseInt(aVal) || 0;
            bVal = bVal === 'n/a' ? -1 : parseInt(bVal) || 0;
        }
        
        if (aVal < bVal) return newOrder === 'asc' ? -1 : 1;
        if (aVal > bVal) return newOrder === 'asc' ? 1 : -1;
        return 0;
    });
    
    // Re-append sorted rows
    rows.forEach(row => table.appendChild(row));
}

function clearTaskFilters() {
    // Clear all filter inputs
    document.getElementById('taskSearch').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('unitTypeFilter').value = '';
    
    // Reset triggered tasks sort order
    triggeredTasksSortOrder = {};
    
    // Clear sort indicators
    document.querySelectorAll('#triggeredTasksTable th .sort-indicator').forEach(indicator => {
        indicator.textContent = '';
    });
    
    // Re-filter to show all tasks
    filterTriggeredTasks();
}

function sortServices(column) {
    const table = document.getElementById('servicesTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Toggle sort order
    servicesSortOrder[column] = servicesSortOrder[column] === 'asc' ? 'desc' : 'asc';
    const isAscending = servicesSortOrder[column] === 'asc';
    
    // Update sort icons
    table.querySelectorAll('th i').forEach(icon => {
        icon.className = 'fas fa-sort';
    });
    
    const currentHeader = table.querySelector(`th[onclick="sortServices('${column}')"] i`);
    if (currentHeader) {
        currentHeader.className = isAscending ? 'fas fa-sort-up' : 'fas fa-sort-down';
    }
    
    // Sort rows
    rows.sort((a, b) => {
        let aVal, bVal;
        
        switch (column) {
            case 'unit':
                aVal = a.dataset.unit;
                bVal = b.dataset.unit;
                break;
            case 'load':
                aVal = a.dataset.load;
                bVal = b.dataset.load;
                break;
            case 'active':
                aVal = a.dataset.active;
                bVal = b.dataset.active;
                break;
            case 'sub':
                aVal = a.dataset.sub;
                bVal = b.dataset.sub;
                break;
            default:
                return 0;
        }
        
        return isAscending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
    });
    
    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
}

function clearServicesFilters() {
    document.getElementById('serviceSearch').value = '';
    document.getElementById('loadStateFilter').value = '';
    document.getElementById('activeStateFilter').value = '';
    document.getElementById('subStateFilter').value = '';
    filterServices();
}

function exportServices() {
    const table = document.getElementById('servicesTable');
    if (!table) return;
    
    const rows = table.querySelectorAll('tr');
    let csv = '';
    
    // Add headers
    const headers = [];
    table.querySelectorAll('thead th').forEach(th => {
        headers.push(th.textContent.replace(/\s+/g, ' ').trim());
    });
    csv += headers.join(',') + '\n';
    
    // Add visible data rows
    table.querySelectorAll('tbody tr').forEach(row => {
        if (row.style.display !== 'none') {
            const cells = [];
            row.querySelectorAll('td').forEach(td => {
                let cellText = td.textContent.replace(/\s+/g, ' ').trim();
                // Escape commas and quotes
                if (cellText.includes(',') || cellText.includes('"')) {
                    cellText = '"' + cellText.replace(/"/g, '""') + '"';
                }
                cells.push(cellText);
            });
            csv += cells.join(',') + '\n';
        }
    });
    
    // Download CSV
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `services_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function renderCollectionLogs(data) {
    const contentArea = document.getElementById('content-area');
    
    let html = `
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="h4 mb-3">
                    <i class="fas fa-file-alt me-2"></i>Collection Logs
                </h2>
            </div>
        </div>
    `;
    
    if (data && data.logs) {
        const logData = data;
        
        // Statistics Cards
        if (logData.statistics) {
            const stats = logData.statistics;
            html += `
                <div class="row mb-4">
                    <div class="col-md-2">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">${stats.total_entries || 0}</h5>
                                <p class="card-text">Total Entries</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">${stats.info_count || 0}</h5>
                                <p class="card-text">Info</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card bg-secondary text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">${stats.debug_count || 0}</h5>
                                <p class="card-text">Debug</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">${stats.warning_count || 0}</h5>
                                <p class="card-text">Warnings</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card bg-danger text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">${stats.error_count || 0}</h5>
                                <p class="card-text">Errors</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">${stats.components ? stats.components.length : 0}</h5>
                                <p class="card-text">Components</p>
                            </div>
                        </div>
                    </div>
                    ${stats.other_count ? `
                    <div class="col-md-2">
                        <div class="card bg-dark text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">${stats.other_count}</h5>
                                <p class="card-text">Other</p>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        }
        
        // Filters
        html += `
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="logLevelFilter" class="form-label">Log Level</label>
                            <select id="logLevelFilter" class="form-select" onchange="filterCollectionLogs()">
                                <option value="">All Levels</option>
                                <option value="INFO">INFO</option>
                                <option value="DEBUG">DEBUG</option>
                                <option value="WARNING">WARNING</option>
                                <option value="ERROR">ERROR</option>
                                <option value="UNKNOWN">UNKNOWN</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="componentFilter" class="form-label">Component</label>
                            <select id="componentFilter" class="form-select" onchange="filterCollectionLogs()">
                                <option value="">All Components</option>
                                ${logData.statistics && logData.statistics.components ? 
                                    logData.statistics.components.map(comp => `<option value="${comp}">${comp}</option>`).join('') : ''}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="messageFilter" class="form-label">Search Message</label>
                            <input type="text" id="messageFilter" class="form-control" placeholder="Search in messages..." onkeyup="filterCollectionLogs()">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-secondary d-block" onclick="clearCollectionLogFilters()">Clear Filters</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Log Entries Table
        if (logData.logs && logData.logs.length > 0) {
            html += `
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                            <table class="table table-striped table-hover mb-0" id="collectionLogsTable">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th class="sticky-top" onclick="sortCollectionLogs('timestamp')" style="width: 180px; cursor: pointer;">Timestamp <i class="fas fa-sort"></i></th>
                                        <th class="sticky-top" onclick="sortCollectionLogs('level')" style="width: 80px; cursor: pointer;">Level <i class="fas fa-sort"></i></th>
                                        <th class="sticky-top" onclick="sortCollectionLogs('component')" style="width: 150px; cursor: pointer;">Component <i class="fas fa-sort"></i></th>
                                        <th class="sticky-top" onclick="sortCollectionLogs('message')" style="cursor: pointer;">Message <i class="fas fa-sort"></i></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${logData.logs.map(log => `
                                        <tr class="log-entry" data-level="${log.level}" data-component="${log.component}" data-message="${log.message.toLowerCase()}">
                                            <td class="text-nowrap">${log.timestamp}</td>
                                            <td><span class="badge bg-${getLevelBadgeClass(log.level)}">${log.level}</span></td>
                                            <td class="text-truncate" style="max-width: 150px;" title="${log.component}">${log.component}</td>
                                            <td class="text-break">${log.message}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        } else {
            html += `
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted mb-3">No Log Entries</h5>
                        <p class="text-muted">No collection log entries found.</p>
                    </div>
                </div>
            `;
        }
    } else {
        html += `
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h5 class="text-muted mb-3">Error Loading Collection Logs</h5>
                    <p class="text-muted">${data && data.error ? data.error : 'Failed to load collection log data.'}</p>
                </div>
            </div>
        `;
    }
    
    contentArea.innerHTML = html;
}

function getLevelBadgeClass(level) {
    switch(level) {
        case 'INFO': return 'info';
        case 'DEBUG': return 'secondary';
        case 'WARNING': return 'warning';
        case 'ERROR': return 'danger';
        default: return 'light';
    }
}

function filterCollectionLogs() {
    const levelFilter = document.getElementById('logLevelFilter').value;
    const componentFilter = document.getElementById('componentFilter').value;
    const messageFilter = document.getElementById('messageFilter').value.toLowerCase();
    
    const rows = document.querySelectorAll('#collectionLogsTable .log-entry');
    
    rows.forEach(row => {
        const level = row.getAttribute('data-level');
        const component = row.getAttribute('data-component');
        const message = row.getAttribute('data-message');
        
        let show = true;
        
        if (levelFilter && level !== levelFilter) {
            show = false;
        }
        
        if (componentFilter && component !== componentFilter) {
            show = false;
        }
        
        if (messageFilter && !message.includes(messageFilter)) {
            show = false;
        }
        
        row.style.display = show ? '' : 'none';
    });
}

function clearCollectionLogFilters() {
    document.getElementById('logLevelFilter').value = '';
    document.getElementById('componentFilter').value = '';
    document.getElementById('messageFilter').value = '';
    filterCollectionLogs();
}

// Collection logs sorting
let collectionLogsSortOrder = {};

function sortCollectionLogs(column) {
    const table = document.getElementById('collectionLogsTable');
    if (!table) return;
    
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Toggle sort order
    collectionLogsSortOrder[column] = collectionLogsSortOrder[column] === 'asc' ? 'desc' : 'asc';
    const isAscending = collectionLogsSortOrder[column] === 'asc';
    
    // Update sort icons
    table.querySelectorAll('th i.fas').forEach(icon => {
        icon.className = 'fas fa-sort';
    });
    
    const currentHeader = table.querySelector(`th[onclick="sortCollectionLogs('${column}')"] i`);
    if (currentHeader) {
        currentHeader.className = `fas fa-sort-${isAscending ? 'up' : 'down'}`;
    }
    
    rows.sort((a, b) => {
        let aVal, bVal;
        
        switch (column) {
            case 'timestamp':
                aVal = a.querySelector('td:nth-child(1)').textContent;
                bVal = b.querySelector('td:nth-child(1)').textContent;
                // Convert to Date for proper sorting
                aVal = new Date(aVal).getTime() || 0;
                bVal = new Date(bVal).getTime() || 0;
                break;
            case 'level':
                aVal = a.dataset.level.toLowerCase();
                bVal = b.dataset.level.toLowerCase();
                break;
            case 'component':
                aVal = a.dataset.component.toLowerCase();
                bVal = b.dataset.component.toLowerCase();
                break;
            case 'message':
                aVal = a.querySelector('td:nth-child(4)').textContent.toLowerCase();
                bVal = b.querySelector('td:nth-child(4)').textContent.toLowerCase();
                break;
            default:
                return 0;
        }
        
        if (typeof aVal === 'string') {
            return isAscending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        } else {
            return isAscending ? aVal - bVal : bVal - aVal;
        }
    });
    
    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
}

function setActiveNavLink(activeLink) {
    // Remove active class from all nav links
    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
    });
    
    // Add active class to clicked link
    activeLink.classList.add('active');
}

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar-wrapper');
    const content = document.getElementById('page-content-wrapper');
    
    if (sidebarCollapsed) {
        sidebar.style.marginLeft = '0';
        sidebar.style.width = '280px';
        content.style.marginLeft = '0';
        sidebarCollapsed = false;
    } else {
        sidebar.style.marginLeft = '-280px';
        sidebar.style.width = '280px';
        content.style.marginLeft = '0';
        sidebarCollapsed = true;
    }
}

function performSearch() {
    const query = document.getElementById('searchInput').value.trim();
    if (!query) {
        alert('Please enter a search term');
        return;
    }
    
    // Show search modal
    const modal = new bootstrap.Modal(document.getElementById('searchModal'));
    modal.show();
    
    // Show loading in search results
    document.getElementById('searchResults').innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Searching...</span>
            </div>
            <p class="mt-3 text-muted">Searching artifacts for "${query}"...</p>
        </div>
    `;
    
    // Perform search
    fetch(`/analysis/{{ case.case_id }}/search?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displaySearchResults(data.results, query);
            } else {
                document.getElementById('searchResults').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Search failed: ${data.message || 'Unknown error'}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Search error:', error);
            document.getElementById('searchResults').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Network error during search
                </div>
            `;
        });
}

function analyzeEnvironmentVariables(variables) {
    const analysis = {
        securityFindings: [],
        pathAnalysis: {
            customPaths: [],
            suspiciousPaths: []
        }
    };
    
    // Security Analysis
    for (const [name, value] of Object.entries(variables)) {
        // Check for privilege escalation indicators
        if (name === 'SUDO_USER' && value) {
            analysis.securityFindings.push(`Privilege escalation detected: User '${value}' used sudo`);
        }
        
        if (name === 'SUDO_COMMAND' && value) {
            analysis.securityFindings.push(`Sudo command executed: ${value}`);
        }
        
        // Check for potential security risks in PATH
        if (name === 'PATH' && value) {
            const paths = value.split(':');
            const suspiciousPaths = paths.filter(path => 
                path.includes('/tmp') || 
                path.includes('/var/tmp') || 
                path.startsWith('.') ||
                path.includes('..') ||
                path === ''
            );
            
            if (suspiciousPaths.length > 0) {
                analysis.securityFindings.push(`Suspicious paths in PATH: ${suspiciousPaths.join(', ')}`);
            }
            
            // Identify custom paths (not standard system paths)
            const standardPaths = ['/usr/local/sbin', '/usr/local/bin', '/usr/sbin', '/usr/bin', '/sbin', '/bin'];
            const customPaths = paths.filter(path => !standardPaths.includes(path) && path.trim() !== '');
            analysis.pathAnalysis.customPaths = customPaths;
        }
        

        
        // Check for potentially dangerous variables
        if (name.includes('PASSWORD') || name.includes('SECRET') || name.includes('KEY')) {
            analysis.securityFindings.push(`Potential credential in environment: ${name}`);
        }
        
        // Check for LD_PRELOAD or LD_LIBRARY_PATH (potential for library injection)
        if (name === 'LD_PRELOAD' && value) {
            analysis.securityFindings.push(`Library preload detected: ${value}`);
        }
        
        if (name === 'LD_LIBRARY_PATH' && value) {
            analysis.securityFindings.push(`Custom library path: ${value}`);
        }
    }
    
    return analysis;
}

// Function to get variable description
function getVariableDescription(name, value) {
    const descriptions = {
        'PATH': 'System executable search paths - directories where the shell looks for commands',
        'HOME': 'User home directory path',
        'USER': 'Current username',
        'LOGNAME': 'Login name of the current user',
        'SHELL': 'Default shell program for the user',
        'TERM': 'Terminal type identifier for proper display formatting',
        'DISPLAY': 'X11 display server connection string for GUI applications',
        'LANG': 'System language and locale settings',
        'LC_ALL': 'Locale settings override for all categories',
        'PWD': 'Present working directory path',
        'OLDPWD': 'Previous working directory path',
        'EDITOR': 'Default text editor program',
        'PAGER': 'Default pager program for viewing text',
        'BROWSER': 'Default web browser program',
        'MAIL': 'Mail spool file location',
        'MAILCHECK': 'Interval for checking new mail',
        'PS1': 'Primary shell prompt format string',
        'PS2': 'Secondary shell prompt for multi-line commands',
        'IFS': 'Internal Field Separator for word splitting',
        'HISTFILE': 'Command history file location',
        'HISTSIZE': 'Number of commands to remember in history',
        'HISTCONTROL': 'History behavior control settings',
        'TMOUT': 'Shell timeout value in seconds',
        'UMASK': 'Default file creation permissions mask',
        'TZ': 'Timezone setting',
        'COLORTERM': 'Color terminal capability indicator',
        'LS_COLORS': 'Color scheme for ls command output',
        'GREP_COLOR': 'Color highlighting for grep matches',
        'LESS': 'Default options for less pager',
        'MANPATH': 'Manual page search directories',
        'INFOPATH': 'Info document search directories',
        'CDPATH': 'Directory search path for cd command',
        'FPATH': 'Function definition search path',
        'TMPDIR': 'Temporary files directory',
        'XDG_CONFIG_HOME': 'User configuration files directory',
        'XDG_DATA_HOME': 'User data files directory',
        'XDG_CACHE_HOME': 'User cache files directory',
        'XDG_CURRENT_DESKTOP': 'Current desktop environment name',
        'DESKTOP_SESSION': 'Desktop session type identifier',
        'GDMSESSION': 'GDM session type',
        'SESSION_MANAGER': 'Session management connection string',
        'DBUS_SESSION_BUS_ADDRESS': 'D-Bus session bus connection address',
        'SSH_CLIENT': 'SSH client connection information',
        'SSH_CONNECTION': 'SSH connection details',
        'SSH_TTY': 'SSH terminal device',
        'SSH_AUTH_SOCK': 'SSH authentication agent socket',
        'GPG_AGENT_INFO': 'GPG agent connection information',
        'XAUTHORITY': 'X11 authorization file location',
        'WINDOWID': 'X11 window identifier',
        'COLUMNS': 'Terminal width in characters',
        'LINES': 'Terminal height in lines'
    };
    
    // Check for sudo-related variables
    if (name.startsWith('SUDO_')) {
        return 'Sudo execution context variable - contains information from privilege escalation';
    }
    
    // Check for other common patterns
    if (name.endsWith('_HOME') && !descriptions[name]) {
        return 'Application home directory path';
    }
    if (name.endsWith('_PATH') && !descriptions[name]) {
        return 'Application-specific search path';
    }
    if (name.endsWith('_CONFIG') && !descriptions[name]) {
        return 'Application configuration setting';
    }
    
    return descriptions[name] || 'Custom environment variable - application or user defined setting';
}

function displaySearchResults(results, query) {
    const searchResults = document.getElementById('searchResults');
    
    if (results.length === 0) {
        searchResults.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h5 class="text-muted mb-3">No Results Found</h5>
                <p class="text-muted">No matches found for "${query}"</p>
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="mb-3">
            <h6 class="text-primary">Found ${results.length} result(s) for "${query}"</h6>
        </div>
    `;
    
    results.forEach(result => {
        html += `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title">
                                <i class="fas fa-file-code me-2"></i>${result.filename}
                            </h6>
                            <p class="card-text">
                                <small class="text-muted">Match in: ${result.match_location || 'Content'}</small>
                            </p>
                            ${result.snippet ? `<p class="card-text"><small>${result.snippet}</small></p>` : ''}
                        </div>
                        <div>
                            <a href="/analysis/{{ case.case_id }}/artifact/${result.artifact_id}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye me-1"></i>View
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    searchResults.innerHTML = html;
}

function showError(message) {
    const contentArea = document.getElementById('content-area');
    contentArea.innerHTML = `
        <div class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Error:</strong> ${message}
        </div>
    `;
}

function downloadArtifact(artifactId) {
    const caseId = getCurrentCaseId();
    if (caseId) {
        window.open(`/cases/${caseId}/artifacts/${artifactId}/download`, '_blank');
    }
}

function viewArtifact(artifactId) {
    const caseId = getCurrentCaseId();
    if (caseId) {
        window.open(`/analysis/${caseId}/artifact/${artifactId}`, '_blank');
    }
}

function getCurrentCaseId() {
    // Extract case ID from the current URL path
    const pathParts = window.location.pathname.split('/');
    const analysisIndex = pathParts.indexOf('analysis');
    if (analysisIndex !== -1 && pathParts[analysisIndex + 1]) {
        return pathParts[analysisIndex + 1];
    }
    return null;
}

function formatFileSize(bytes) {
    if (!bytes || bytes === 0) return '0 bytes';
    
    const k = 1024;
    const sizes = ['bytes', 'KB', 'MB', 'GB'];
    
    if (bytes < k) {
        return bytes + ' bytes';
    }
    
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    const size = (bytes / Math.pow(k, i)).toFixed(2);
    
    return size + ' ' + sizes[i];
}

function renderArtifactTypesChart(types) {
    // Simple chart rendering - you can enhance this with Chart.js
    const chartContainer = document.getElementById('artifactTypesChart');
    let html = '';
    
    types.forEach(type => {
        const percentage = (type.count / types.reduce((sum, t) => sum + t.count, 0)) * 100;
        html += `
            <div class="mb-2">
                <div class="d-flex justify-content-between">
                    <span class="text-sm">${type.category}</span>
                    <span class="text-sm">${type.count}</span>
                </div>
                <div class="progress progress-sm">
                    <div class="progress-bar bg-primary" style="width: ${percentage}%"></div>
                </div>
            </div>
        `;
    });
    
    chartContainer.innerHTML = html;
}

// Add custom CSS
const style = document.createElement('style');
style.textContent = `
    .nav-section-header {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .nav-section-header:hover {
        background-color: rgba(0,0,0,0.05);
    }
    
    .nav-section-header .fa-chevron-down {
        transition: transform 0.2s;
    }
    
    .border-left-primary {
        border-left: 0.25rem solid #4e73df !important;
    }
    
    .border-left-success {
        border-left: 0.25rem solid #1cc88a !important;
    }
    
    .border-left-info {
        border-left: 0.25rem solid #36b9cc !important;
    }
    
    .border-left-warning {
        border-left: 0.25rem solid #f6c23e !important;
    }
    
    .progress-sm {
        height: 0.5rem;
    }
    
    #sidebar-wrapper {
        transition: margin-left 0.3s ease;
    }
    
    @media (max-width: 768px) {
        #sidebar-wrapper {
            margin-left: -280px;
        }
        
        #sidebar-wrapper.show {
            margin-left: 0;
        }
    }
`;

function showFullValue(variableName, fullValue) {
    // Create a modal to show the full value
    const modalHtml = `
        <div class="modal fade" id="fullValueModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-cog me-2"></i>Environment Variable: ${variableName}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="bg-light p-3 rounded">
                            <pre class="mb-0" style="white-space: pre-wrap; word-wrap: break-word;">${fullValue}</pre>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="copyToClipboard('${fullValue.replace(/'/g, "\\'").replace(/"/g, '\\"')}')">Copy Value</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('fullValueModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('fullValueModal'));
    modal.show();
    
    // Clean up modal after it's hidden
    document.getElementById('fullValueModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

function showFullPasswordHash(username, fullHash) {
    // Create a modal to show the full password hash
    const modalHtml = `
        <div class="modal fade" id="fullPasswordHashModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-key me-2"></i>Password Hash: ${username}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="bg-light p-3 rounded">
                            <pre class="mb-0" style="white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', monospace;">${fullHash}</pre>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="copyToClipboard(\`${fullHash}\`)">Copy Hash</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('fullPasswordHashModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('fullPasswordHashModal'));
    modal.show();
    
    // Clean up modal after it's hidden
    document.getElementById('fullPasswordHashModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

function renderNetworkConnections(data) {
    const contentArea = document.getElementById('content-area');
    
    let html = `
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="h4 mb-3">
                    <i class="fas fa-plug me-2"></i>Network Connections
                </h2>
            </div>
        </div>
        
        <!-- Network Connections Analysis Guide -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white py-2">
                        <h6 class="m-0">
                            <i class="fas fa-info-circle me-2"></i>Network Connections Analysis Guide
                            <button class="btn btn-sm btn-outline-light float-end" type="button" data-bs-toggle="collapse" data-bs-target="#networkGuide" aria-expanded="false">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </h6>
                    </div>
                    <div class="collapse" id="networkGuide">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary"><i class="fas fa-shield-alt me-2"></i>Connection States</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><span class="badge bg-success me-2">ESTABLISHED</span> Active connection in use</li>
                                        <li class="mb-2"><span class="badge bg-info me-2">LISTEN</span> Service waiting for connections</li>
                                        <li class="mb-2"><span class="badge bg-warning me-2">TIME_WAIT</span> Connection closing gracefully</li>
                                        <li class="mb-2"><span class="badge bg-secondary me-2">CLOSE_WAIT</span> Waiting for local close</li>
                                        <li class="mb-2"><span class="badge bg-danger me-2">SYN_SENT</span> Connection attempt in progress</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-primary"><i class="fas fa-search me-2"></i>Security Analysis Points</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><strong>Protocol:</strong> TCP vs UDP connection types</li>
                                        <li class="mb-2"><strong>Local Address:</strong> Interface and port binding</li>
                                        <li class="mb-2"><strong>Remote Address:</strong> External connection endpoints</li>
                                        <li class="mb-2"><strong>Process ID:</strong> Associated running process</li>
                                        <li class="mb-2"><strong>Port Numbers:</strong> Well-known vs high ports</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="alert alert-light mt-3 mb-0">
                                <small class="text-muted">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    <strong>Investigation Tips:</strong> Look for unusual listening ports, external connections to suspicious IPs, 
                                    high port numbers (>1024) used by unknown processes, and connections at unusual times. 
                                    Pay attention to processes with network activity that shouldn't normally communicate externally.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Find network connections data
    let connectionsData = null;
    let connectionCount = 0;
    let connectionTrackingData = null;
    let routingTableData = null;
    
    // Data is already extracted by renderSectionContent, use it directly
    const dataSource = data || {};
    
    console.log('Network connections data received:', dataSource); // Debug log
    
    // Try to find connections data in various possible structures
    if (dataSource.connections && Array.isArray(dataSource.connections)) {
        connectionsData = dataSource.connections;
        connectionCount = connectionsData.length;
    } else if (dataSource.networkConnections_data && Array.isArray(dataSource.networkConnections_data)) {
        connectionsData = dataSource.networkConnections_data;
        connectionCount = connectionsData.length;
    } else {
        // Try to find in nested structure
        for (const key in dataSource) {
            if (key.includes('networkConnections') && dataSource[key] && dataSource[key].connections) {
                connectionsData = dataSource[key].connections;
                connectionCount = connectionsData.length;
                break;
            }
        }
    }
    
    // Process connection tracking data
    for (const key in dataSource) {
        if (key.includes('connectionTracking') && dataSource[key]) {
            connectionTrackingData = parseConnectionTrackingData(dataSource[key]);
            break;
        }
    }
    
    // Process routing table data
    console.log('All dataSource keys:', Object.keys(dataSource));
    
    // Try direct access first
    if (dataSource.routingTableRaw) {
        console.log('Found routing table data directly:', dataSource.routingTableRaw);
        routingTableData = parseRoutingTableData(dataSource.routingTableRaw);
    } else {
        // Fall back to searching for keys
        for (const key in dataSource) {
            console.log('Checking key:', key, typeof dataSource[key]);
            if (key.includes('routingTableRaw') && dataSource[key]) {
                console.log('Found routing table data in key:', key, dataSource[key]);
                routingTableData = parseRoutingTableData(dataSource[key]);
                break;
            }
        }
    }
    
    // Check if we have routing table data
    console.log('Final routing table data:', routingTableData);
    
    if (connectionsData && connectionCount > 0) {
        // Calculate statistics
        const tcpConnections = connectionsData.filter(c => c.protocol === 'tcp').length;
        const udpConnections = connectionsData.filter(c => c.protocol === 'udp').length;
        const listeningConnections = connectionsData.filter(c => c.state === 'LISTEN').length;
        const establishedConnections = connectionsData.filter(c => c.state === 'ESTABLISHED').length;
        
        html += `
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${connectionCount}</h5>
                            <p class="card-text">Total Connections</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${tcpConnections}</h5>
                            <p class="card-text">TCP</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${udpConnections}</h5>
                            <p class="card-text">UDP</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${listeningConnections}</h5>
                            <p class="card-text">Listening</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filters -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">Search Connections</label>
                                    <input type="text" class="form-control" id="connectionSearch" placeholder="Search by IP, port, or protocol..." oninput="filterConnections()">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Protocol</label>
                                    <select class="form-select" id="protocolFilter" onchange="filterConnections()">
                                        <option value="">All Protocols</option>
                                        <option value="tcp">TCP</option>
                                        <option value="udp">UDP</option>
                                        <option value="tcp6">TCP6</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">State</label>
                                    <select class="form-select" id="stateFilter" onchange="filterConnections()">
                                        <option value="">All States</option>
                                        <option value="LISTEN">LISTEN</option>
                                        <option value="ESTABLISHED">ESTABLISHED</option>
                                        <option value="CLOSE_WAIT">CLOSE_WAIT</option>
                                        <option value="TIME_WAIT">TIME_WAIT</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Port Range</label>
                                    <select class="form-select" id="portFilter" onchange="filterConnections()">
                                        <option value="">All Ports</option>
                                        <option value="well-known">Well-known (1-1023)</option>
                                        <option value="registered">Registered (1024-49151)</option>
                                        <option value="dynamic">Dynamic (49152-65535)</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-secondary" onclick="clearConnectionFilters()">
                                            <i class="fas fa-times me-1"></i>Clear
                                        </button>
                                        <button class="btn btn-outline-info" onclick="exportConnections()">
                                            <i class="fas fa-download me-1"></i>Export
                                        </button>
                                        <span class="badge bg-primary align-self-center ms-2" id="connectionCount">${connectionCount}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Connections Table -->
            <div class="row">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0" id="connectionsTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th onclick="sortConnections('protocol')" style="cursor: pointer;">
                                                Protocol <i class="fas fa-sort ms-1"></i>
                                            </th>
                                            <th onclick="sortConnections('localAddress')" style="cursor: pointer;">
                                                Local Address <i class="fas fa-sort ms-1"></i>
                                            </th>
                                            <th onclick="sortConnections('remoteAddress')" style="cursor: pointer;">
                                                Remote Address <i class="fas fa-sort ms-1"></i>
                                            </th>
                                            <th onclick="sortConnections('state')" style="cursor: pointer;">
                                                State <i class="fas fa-sort ms-1"></i>
                                            </th>
                                            <th onclick="sortConnections('localPort')" style="cursor: pointer;">
                                                Local Port <i class="fas fa-sort ms-1"></i>
                                            </th>
                                            <th onclick="sortConnections('remotePort')" style="cursor: pointer;">
                                                Remote Port <i class="fas fa-sort ms-1"></i>
                                            </th>
                                            <th>Risk Level</th>
                                        </tr>
                                    </thead>
                                    <tbody>
        `;
        
        connectionsData.forEach((connection, index) => {
            const localPort = connection.localPort || connection.localAddress?.split(':').pop() || 'N/A';
            const remotePort = connection.remotePort || connection.remoteAddress?.split(':').slice(-1)[0] || 'N/A';
            const localIP = connection.localIP || connection.localAddress?.split(':').slice(0, -1).join(':') || 'N/A';
            const remoteIP = connection.remoteIP || connection.remoteAddress?.split(':').slice(0, -1).join(':') || 'N/A';
            
            // Determine risk level
            let riskLevel = 'low';
            let riskBadge = 'success';
            let riskText = 'Low';
            
            if (connection.state === 'ESTABLISHED' && remoteIP !== '0.0.0.0' && remoteIP !== '::' && !remoteIP.startsWith('127.') && !remoteIP.startsWith('192.168.') && !remoteIP.startsWith('10.')) {
                riskLevel = 'high';
                riskBadge = 'danger';
                riskText = 'High';
            } else if (parseInt(localPort) > 49152 || parseInt(remotePort) > 49152) {
                riskLevel = 'medium';
                riskBadge = 'warning';
                riskText = 'Medium';
            }
            
            html += `
                <tr class="connection-row" 
                    data-protocol="${connection.protocol?.toLowerCase() || ''}" 
                    data-state="${connection.state?.toLowerCase() || ''}" 
                    data-local-port="${localPort}" 
                    data-remote-port="${remotePort}"
                    data-local-ip="${localIP}"
                    data-remote-ip="${remoteIP}"
                    data-risk="${riskLevel}">
                    <td>
                        <span class="badge bg-secondary">${connection.protocol?.toUpperCase() || 'N/A'}</span>
                    </td>
                    <td>
                        <code>${connection.localAddress || 'N/A'}</code>
                        <br><small class="text-muted">IP: ${localIP}</small>
                    </td>
                    <td>
                        <code>${connection.remoteAddress || 'N/A'}</code>
                        <br><small class="text-muted">IP: ${remoteIP}</small>
                    </td>
                    <td>
                        <span class="badge ${connection.state === 'LISTEN' ? 'bg-info' : connection.state === 'ESTABLISHED' ? 'bg-success' : 'bg-secondary'}">
                            ${connection.state || 'N/A'}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${parseInt(localPort) <= 1023 ? 'bg-primary' : parseInt(localPort) <= 49151 ? 'bg-info' : 'bg-warning'}">
                            ${localPort}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${parseInt(remotePort) <= 1023 ? 'bg-primary' : parseInt(remotePort) <= 49151 ? 'bg-info' : 'bg-warning'}">
                            ${remotePort}
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-${riskBadge}">${riskText}</span>
                    </td>
                </tr>
            `;
        });
        
        html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
    } else {
        // Check if this is an error response from the backend
        if (dataSource.error) {
            html += `
                <div class="card shadow border-warning">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <h5 class="text-warning mb-3">Network Data Error</h5>
                        <p class="text-muted">${dataSource.error}</p>
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Expected Data:</strong> Upload artifacts containing network connections information 
                            (networkConnections_*.json files) to view active network connections.
                        </div>
                    </div>
                </div>
            `;
        } else {
            html += `
                <div class="card shadow">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-network-wired fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted mb-3">No Network Connections Available</h5>
                        <p class="text-muted">No network connections data found in the uploaded artifacts.</p>
                        <p class="text-muted">
                            <strong>Expected Data:</strong> Upload artifacts containing network connections information 
                            (networkConnections_*.json files) to view active network connections.
                        </p>
                    </div>
                </div>
            `;
        }
    }
    
    // Add Connection Tracking section if data is available
    if (connectionTrackingData && connectionTrackingData.length > 0) {
        html += `
            <div class="row mt-5 mb-4">
                <div class="col-12">
                    <h3 class="h5 mb-3">
                        <i class="fas fa-route me-2"></i>Connection Tracking (conntrack)
                    </h3>
                </div>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${connectionTrackingData.length}</h5>
                            <p class="card-text">Tracked Flows</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${connectionTrackingData.filter(c => c.protocol === 'tcp').length}</h5>
                            <p class="card-text">TCP Flows</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${connectionTrackingData.filter(c => c.protocol === 'udp').length}</h5>
                            <p class="card-text">UDP Flows</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${connectionTrackingData.filter(c => c.flags && c.flags.includes('UNREPLIED')).length}</h5>
                            <p class="card-text">Unreplied</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Connection Tracking Filters -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">Search Connections</label>
                                    <input type="text" class="form-control" id="conntrackSearch" placeholder="Search by IP, port, or protocol..." oninput="filterConntrack()">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Protocol</label>
                                    <select class="form-select" id="conntrackProtocolFilter" onchange="filterConntrack()">
                                        <option value="">All Protocols</option>
                                        <option value="tcp">TCP</option>
                                        <option value="udp">UDP</option>
                                        <option value="icmp">ICMP</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Flags</label>
                                    <select class="form-select" id="conntrackFlagsFilter" onchange="filterConntrack()">
                                        <option value="">All Flags</option>
                                        <option value="UNREPLIED">UNREPLIED</option>
                                        <option value="ASSURED">ASSURED</option>
                                        <option value="SEEN_REPLY">SEEN_REPLY</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">TTL Range</label>
                                    <select class="form-select" id="conntrackTtlFilter" onchange="filterConntrack()">
                                        <option value="">All TTL</option>
                                        <option value="low">Low (< 30s)</option>
                                        <option value="medium">Medium (30-300s)</option>
                                        <option value="high">High (> 300s)</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-secondary" onclick="clearConntrackFilters()">
                                            <i class="fas fa-times me-1"></i>Clear
                                        </button>
                                        <button class="btn btn-outline-info" onclick="exportConntrack()">
                                            <i class="fas fa-download me-1"></i>Export
                                        </button>
                                        <span class="badge bg-primary align-self-center ms-2" id="conntrackCount">${connectionTrackingData.length}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0" id="conntrackTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Protocol</th>
                                            <th>Source</th>
                                            <th>Destination</th>
                                            <th>Reply Source</th>
                                            <th>Reply Destination</th>
                                            <th>TTL</th>
                                            <th>Flags</th>
                                        </tr>
                                    </thead>
                                    <tbody>
        `;
        
        connectionTrackingData.forEach(flow => {
            const protocolBadge = flow.protocol === 'tcp' ? 'bg-success' : flow.protocol === 'udp' ? 'bg-info' : 'bg-secondary';
            const flagsBadges = flow.flags ? flow.flags.map(flag => `<span class="badge bg-${flag === 'UNREPLIED' ? 'danger' : flag === 'ASSURED' ? 'success' : 'secondary'} me-1">${flag}</span>`).join('') : '';
            
            html += `
                <tr class="conntrack-row" 
                    data-protocol="${flow.protocol}" 
                    data-src="${flow.src}" 
                    data-dst="${flow.dst}" 
                    data-sport="${flow.sport}" 
                    data-dport="${flow.dport}" 
                    data-ttl="${flow.ttl}" 
                    data-flags="${flow.flags ? flow.flags.join(',') : ''}">
                    <td>
                        <span class="badge ${protocolBadge}">${flow.protocol.toUpperCase()}</span>
                        <br><small class="text-muted">ID: ${flow.protocolNumber}</small>
                    </td>
                    <td>
                        <code>${flow.src}:${flow.sport}</code>
                    </td>
                    <td>
                        <code>${flow.dst}:${flow.dport}</code>
                    </td>
                    <td>
                        <code>${flow.replySrc}:${flow.replySport}</code>
                    </td>
                    <td>
                        <code>${flow.replyDst}:${flow.replyDport}</code>
                    </td>
                    <td>
                        <span class="badge ${flow.ttl < 30 ? 'bg-warning' : 'bg-info'}">${flow.ttl}s</span>
                    </td>
                    <td>
                        ${flagsBadges || '<span class="text-muted">None</span>'}
                    </td>
                </tr>
            `;
        });
        
        html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Add Routing Table section if data is available
    if (routingTableData && routingTableData.length > 0) {
        console.log('Adding routing table section with', routingTableData.length, 'routes');
        
        html += `
            <!-- Routing Table Section -->
            <div class="row mt-5 mb-4">
                <div class="col-12">
                    <h3 class="h5 mb-3">
                        <i class="fas fa-route me-2"></i>Routing Table
                        <span class="badge bg-primary ms-2" id="routeCount">${routingTableData.length}</span>
                    </h3>
                </div>
            </div>
            
            <!-- Routing Table -->
            <div class="row">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0" id="routingTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Destination</th>
                                            <th>Gateway</th>
                                            <th>Netmask</th>
                                            <th>Flags</th>
                                            <th>Metric</th>
                                            <th>Interface</th>
                                        </tr>
                                    </thead>
                                    <tbody>
        `;
        
        routingTableData.forEach(route => {
            html += `
                <tr>
                    <td><code>${route.destination}</code></td>
                    <td><code>${route.gateway}</code></td>
                    <td><code>${route.netmask}</code></td>
                    <td>${route.flags}</td>
                    <td>${route.metric}</td>
                    <td>${route.interface}</td>
                </tr>
            `;
        });
        
        html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    contentArea.innerHTML = html;
}

// Function to parse connection tracking data from conntrack output
function parseConnectionTrackingData(trackingData) {
    if (!trackingData || !trackingData.stdout) {
        return [];
    }
    
    const lines = trackingData.stdout.trim().split('\n');
    const flows = [];
    
    lines.forEach(line => {
        if (line.trim()) {
            const flow = parseConntrackLine(line);
            if (flow) {
                flows.push(flow);
            }
        }
    });
    
    return flows;
}

// Function to parse routing table data from route -n output
function parseRoutingTableData(data) {
    console.log('Parsing routing table data:', data);
    
    if (!data || !data.stdout) {
        console.error('No stdout in routing table data');
        return [];
    }
    
    const lines = data.stdout.trim().split('\n');
    console.log('Routing table lines:', lines);
    
    const routes = [];
    
    // Skip the first two lines (header lines)
    for (let i = 2; i < lines.length; i++) {
        const line = lines[i].trim();
        if (line) {
            console.log('Processing line:', line);
            const parts = line.split(/\s+/);
            console.log('Line parts:', parts);
            
            if (parts.length >= 8) {
                const route = {
                    destination: parts[0],
                    gateway: parts[1],
                    netmask: parts[2],
                    flags: parts[3],
                    metric: parts[4],
                    ref: parts[5],
                    use: parts[6],
                    interface: parts[7]
                };
                
                console.log('Adding route:', route);
                routes.push(route);
            } else {
                console.warn('Line has insufficient parts:', parts.length, line);
            }
        }
    }
    
    console.log('Parsed routes:', routes);
    return routes;
}

// Function to filter routing table
function filterRoutes() {
    const searchTerm = document.getElementById('routeSearch').value.toLowerCase();
    const interfaceFilter = document.getElementById('interfaceFilter').value.toLowerCase();
    const routeTypeFilter = document.getElementById('routeTypeFilter').value.toLowerCase();
    const flagsFilter = document.getElementById('flagsFilter').value;
    
    const rows = document.querySelectorAll('.route-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const destination = row.dataset.destination.toLowerCase();
        const gateway = row.dataset.gateway.toLowerCase();
        const netmask = row.dataset.netmask.toLowerCase();
        const flags = row.dataset.flags.toLowerCase();
        const interface = row.dataset.interface.toLowerCase();
        const type = row.dataset.type.toLowerCase();
        
        let show = true;
        
        // Search filter
        if (searchTerm) {
            show = destination.includes(searchTerm) || 
                   gateway.includes(searchTerm) || 
                   netmask.includes(searchTerm) || 
                   flags.includes(searchTerm) || 
                   interface.includes(searchTerm);
        }
        
        // Interface filter
        if (show && interfaceFilter) {
            show = interface === interfaceFilter;
        }
        
        // Route type filter
        if (show && routeTypeFilter) {
            show = type === routeTypeFilter;
        }
        
        // Flags filter
        if (show && flagsFilter) {
            show = flags.includes(flagsFilter.toLowerCase());
        }
        
        row.style.display = show ? '' : 'none';
        if (show) visibleCount++;
    });
    
    // Update count
    document.getElementById('routeCount').textContent = visibleCount;
}

// Function to clear routing table filters
function clearRouteFilters() {
    document.getElementById('routeSearch').value = '';
    document.getElementById('interfaceFilter').value = '';
    document.getElementById('routeTypeFilter').value = '';
    document.getElementById('flagsFilter').value = '';
    filterRoutes();
}

// Function to export routing table as CSV
function exportRoutes() {
    const rows = document.querySelectorAll('.route-row');
    const visibleRows = Array.from(rows).filter(row => row.style.display !== 'none');
    
    if (visibleRows.length === 0) {
        alert('No routes to export');
        return;
    }
    
    let csv = 'Destination,Gateway,Netmask,Flags,Metric,Interface,Type\n';
    
    visibleRows.forEach(row => {
        const destination = row.dataset.destination;
        const gateway = row.dataset.gateway;
        const netmask = row.dataset.netmask;
        const flags = row.dataset.flags;
        const metric = row.dataset.metric;
        const interface = row.dataset.interface;
        const type = row.dataset.type;
        
        csv += `"${destination}","${gateway}","${netmask}","${flags}","${metric}","${interface}","${type}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('href', url);
    a.setAttribute('download', 'routing_table.csv');
    a.click();
}

// Function to sort routing table
function sortRoutes(column) {
    const table = document.getElementById('routingTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Toggle sort direction
    const currentSortColumn = tbody.getAttribute('data-sort-column') || '';
    const currentSortDirection = tbody.getAttribute('data-sort-direction') || 'asc';
    const isAscending = currentSortColumn === column ? currentSortDirection !== 'asc' : true;
    
    tbody.setAttribute('data-sort-column', column);
    tbody.setAttribute('data-sort-direction', isAscending ? 'asc' : 'desc');
    
    // Sort rows
    rows.sort((a, b) => {
        let aVal, bVal;
        
        switch (column) {
            case 'destination':
                aVal = a.dataset.destination;
                bVal = b.dataset.destination;
                break;
            case 'gateway':
                aVal = a.dataset.gateway;
                bVal = b.dataset.gateway;
                break;
            case 'netmask':
                aVal = a.dataset.netmask;
                bVal = b.dataset.netmask;
                break;
            case 'flags':
                aVal = a.dataset.flags;
                bVal = b.dataset.flags;
                break;
            case 'metric':
                aVal = parseInt(a.dataset.metric);
                bVal = parseInt(b.dataset.metric);
                break;
            case 'interface':
                aVal = a.dataset.interface;
                bVal = b.dataset.interface;
                break;
            default:
                return 0;
        }
        
        if (typeof aVal === 'string') {
            return isAscending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        } else {
            return isAscending ? aVal - bVal : bVal - aVal;
        }
    });
    
    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
}

// Function to parse individual conntrack line
function parseConntrackLine(line) {
    const parts = line.split(/\s+/);
    const flow = {
        protocol: parts[0],
        protocolNumber: parts[1],
        ttl: parseInt(parts[2]),
        flags: []
    };
    
    // Parse key-value pairs
    for (let i = 3; i < parts.length; i++) {
        const part = parts[i];
        
        if (part.startsWith('src=')) {
            if (!flow.src) {
                flow.src = part.substring(4);
            } else {
                flow.replySrc = part.substring(4);
            }
        } else if (part.startsWith('dst=')) {
            if (!flow.dst) {
                flow.dst = part.substring(4);
            } else {
                flow.replyDst = part.substring(4);
            }
        } else if (part.startsWith('sport=')) {
            if (!flow.sport) {
                flow.sport = part.substring(6);
            } else {
                flow.replySport = part.substring(6);
            }
        } else if (part.startsWith('dport=')) {
            if (!flow.dport) {
                flow.dport = part.substring(6);
            } else {
                flow.replyDport = part.substring(6);
            }
        } else if (part.startsWith('[') && part.endsWith(']')) {
            flow.flags.push(part.substring(1, part.length - 1));
        }
    }
    
    return flow;
}

// Function to filter connection tracking data
function filterConntrack() {
    const searchTerm = document.getElementById('conntrackSearch').value.toLowerCase();
    const protocolFilter = document.getElementById('conntrackProtocolFilter').value.toLowerCase();
    const flagsFilter = document.getElementById('conntrackFlagsFilter').value;
    const ttlFilter = document.getElementById('conntrackTtlFilter').value;
    
    const rows = document.querySelectorAll('.conntrack-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const protocol = row.dataset.protocol.toLowerCase();
        const src = row.dataset.src.toLowerCase();
        const dst = row.dataset.dst.toLowerCase();
        const sport = row.dataset.sport;
        const dport = row.dataset.dport;
        const ttl = parseInt(row.dataset.ttl);
        const flags = row.dataset.flags.toLowerCase();
        
        let show = true;
        
        // Search filter
        if (searchTerm) {
            const searchText = `${protocol} ${src} ${dst} ${sport} ${dport}`.toLowerCase();
            if (!searchText.includes(searchTerm)) {
                show = false;
            }
        }
        
        // Protocol filter
        if (protocolFilter && protocol !== protocolFilter) {
            show = false;
        }
        
        // Flags filter
        if (flagsFilter && !flags.includes(flagsFilter.toLowerCase())) {
            show = false;
        }
        
        // TTL filter
        if (ttlFilter) {
            if (ttlFilter === 'low' && ttl >= 30) show = false;
            if (ttlFilter === 'medium' && (ttl < 30 || ttl > 300)) show = false;
            if (ttlFilter === 'high' && ttl <= 300) show = false;
        }
        
        row.style.display = show ? '' : 'none';
        if (show) visibleCount++;
    });
    
    // Update count badge
    const countBadge = document.getElementById('conntrackCount');
    if (countBadge) {
        countBadge.textContent = visibleCount;
    }
}

// Function to clear connection tracking filters
function clearConntrackFilters() {
    document.getElementById('conntrackSearch').value = '';
    document.getElementById('conntrackProtocolFilter').value = '';
    document.getElementById('conntrackFlagsFilter').value = '';
    document.getElementById('conntrackTtlFilter').value = '';
    
    const rows = document.querySelectorAll('.conntrack-row');
    rows.forEach(row => {
        row.style.display = '';
    });
    
    // Update count badge
    const countBadge = document.getElementById('conntrackCount');
    if (countBadge) {
        countBadge.textContent = rows.length;
    }
}

// Function to export connection tracking data
function exportConntrack() {
    const visibleRows = Array.from(document.querySelectorAll('.conntrack-row')).filter(row => row.style.display !== 'none');
    
    if (visibleRows.length === 0) {
        alert('No connection tracking data to export');
        return;
    }
    
    let csvContent = 'Protocol,Source,Destination,Reply Source,Reply Destination,TTL,Flags\n';
    
    visibleRows.forEach(row => {
        const protocol = row.dataset.protocol;
        const src = `${row.dataset.src}:${row.dataset.sport}`;
        const dst = `${row.dataset.dst}:${row.dataset.dport}`;
        const replySrc = row.cells[3].textContent.trim();
        const replyDst = row.cells[4].textContent.trim();
        const ttl = row.dataset.ttl;
        const flags = row.dataset.flags || 'None';
        
        csvContent += `"${protocol}","${src}","${dst}","${replySrc}","${replyDst}","${ttl}","${flags}"\n`;
    });
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'connection_tracking_data.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function filterPorts() {
    const searchTerm = document.getElementById('portSearch').value.toLowerCase();
    const typeFilter = document.getElementById('portTypeFilter').value.toLowerCase();
    const protocolFilter = document.getElementById('portProtocolFilter').value.toLowerCase();
    const statusFilter = document.getElementById('portStatusFilter').value.toLowerCase();
    
    const rows = document.querySelectorAll('.port-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const process = row.getAttribute('data-process') || '';
        const user = row.getAttribute('data-user') || '';
        const type = row.getAttribute('data-type') || '';
        const localIp = row.getAttribute('data-local-ip') || '';
        const localPort = row.getAttribute('data-local-port') || '';
        const remoteIp = row.getAttribute('data-remote-ip') || '';
        const remotePort = row.getAttribute('data-remote-port') || '';
        const status = row.getAttribute('data-status') || '';
        
        // Search filter
        const matchesSearch = !searchTerm || 
            process.includes(searchTerm) ||
            user.includes(searchTerm) ||
            localIp.includes(searchTerm) ||
            localPort.includes(searchTerm) ||
            remoteIp.includes(searchTerm) ||
            remotePort.includes(searchTerm);
        
        // Type filter (TCP/UDP)
        const matchesType = !typeFilter || type.includes(typeFilter);
        
        // Protocol filter (IPv4/IPv6)
        const matchesProtocol = !protocolFilter || type.includes(protocolFilter);
        
        // Status filter (listening/connected)
        const matchesStatus = !statusFilter || status === statusFilter;
        
        if (matchesSearch && matchesType && matchesProtocol && matchesStatus) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update count badge
    const countBadge = document.getElementById('portCount');
    if (countBadge) {
        countBadge.textContent = visibleCount;
    }
}

function clearPortFilters() {
    document.getElementById('portSearch').value = '';
    document.getElementById('portTypeFilter').value = '';
    document.getElementById('portProtocolFilter').value = '';
    document.getElementById('portStatusFilter').value = '';
    filterPorts();
}

function exportPorts() {
    const visibleRows = document.querySelectorAll('.port-row:not([style*="display: none"])');
    
    if (visibleRows.length === 0) {
        alert('No data to export');
        return;
    }
    
    let csvContent = 'Process,PID,User,Type,Local Address,Local Port,Remote Address,Remote Port\n';
    
    visibleRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const rowData = [];
        
        cells.forEach(cell => {
            // Extract text content, removing HTML tags and extra whitespace
            let cellText = cell.textContent.trim();
            // Escape quotes and wrap in quotes if contains comma
            if (cellText.includes(',') || cellText.includes('"')) {
                cellText = '"' + cellText.replace(/"/g, '""') + '"';
            }
            rowData.push(cellText);
        });
        
        csvContent += rowData.join(',') + '\n';
    });
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'open_ports_data.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function filterSockets() {
    const searchTerm = document.getElementById('socketSearch').value.toLowerCase();
    const typeFilter = document.getElementById('socketTypeFilter').value.toLowerCase();
    const stateFilter = document.getElementById('socketStateFilter').value.toLowerCase();
    const processFilter = document.getElementById('socketProcessFilter').value.toLowerCase();
    
    const rows = document.querySelectorAll('.socket-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const process = row.getAttribute('data-process') || '';
        const pid = row.getAttribute('data-pid') || '';
        const type = row.getAttribute('data-type') || '';
        const state = row.getAttribute('data-state') || '';
        const localAddress = row.getAttribute('data-local-address') || '';
        const peerAddress = row.getAttribute('data-peer-address') || '';
        
        // Search filter
        const matchesSearch = !searchTerm || 
            process.includes(searchTerm) ||
            pid.includes(searchTerm) ||
            localAddress.includes(searchTerm) ||
            peerAddress.includes(searchTerm);
        
        // Type filter (TCP/UDP)
        const matchesType = !typeFilter || type.includes(typeFilter);
        
        // State filter (LISTEN/ESTAB/UNCONN)
        const matchesState = !stateFilter || state.includes(stateFilter);
        
        // Process filter
        const matchesProcess = !processFilter || process.includes(processFilter);
        
        if (matchesSearch && matchesType && matchesState && matchesProcess) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update count badge
    const countBadge = document.getElementById('socketCount');
    if (countBadge) {
        countBadge.textContent = visibleCount;
    }
}

function clearSocketFilters() {
    document.getElementById('socketSearch').value = '';
    document.getElementById('socketTypeFilter').value = '';
    document.getElementById('socketStateFilter').value = '';
    document.getElementById('socketProcessFilter').value = '';
    filterSockets();
}

function exportSockets() {
    const visibleRows = document.querySelectorAll('.socket-row:not([style*="display: none"])');
    
    if (visibleRows.length === 0) {
        alert('No data to export');
        return;
    }
    
    let csvContent = 'Process,PID,Type,State,Local Address,Peer Address,Recv-Q,Send-Q\n';
    
    visibleRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const rowData = [];
        
        cells.forEach(cell => {
            // Extract text content, removing HTML tags and extra whitespace
            let cellText = cell.textContent.trim();
            // Escape quotes and wrap in quotes if contains comma
            if (cellText.includes(',') || cellText.includes('"')) {
                cellText = '"' + cellText.replace(/"/g, '""') + '"';
            }
            rowData.push(cellText);
        });
        
        csvContent += rowData.join(',') + '\n';
    });
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'socket_statistics_data.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function renderNetworkPorts(data) {
    const contentArea = document.getElementById('content-area');
    
    let html = `
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="h4 mb-3">
                    <i class="fas fa-door-open me-2"></i>Open Ports
                </h2>
            </div>
        </div>
        
        <!-- Open Ports Analysis Guide -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white py-2">
                        <h6 class="m-0">
                            <i class="fas fa-info-circle me-2"></i>Open Ports Analysis Guide
                            <button class="btn btn-sm btn-outline-light float-end" type="button" data-bs-toggle="collapse" data-bs-target="#portsGuide" aria-expanded="false">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </h6>
                    </div>
                    <div class="collapse" id="portsGuide">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary"><i class="fas fa-shield-alt me-2"></i>Port Types</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><span class="badge bg-success me-2">TCP</span> Reliable connection-oriented protocol</li>
                                        <li class="mb-2"><span class="badge bg-info me-2">UDP</span> Fast connectionless protocol</li>
                                        <li class="mb-2"><span class="badge bg-warning me-2">IPv4</span> Standard IP version 4</li>
                                        <li class="mb-2"><span class="badge bg-secondary me-2">IPv6</span> Next generation IP version 6</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-primary"><i class="fas fa-search me-2"></i>Security Analysis Points</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><strong>Process:</strong> Which application opened the port</li>
                                        <li class="mb-2"><strong>User:</strong> Account running the process</li>
                                        <li class="mb-2"><strong>Local Address:</strong> Interface binding (0.0.0.0 = all)</li>
                                        <li class="mb-2"><strong>Remote Address:</strong> Connected endpoints</li>
                                        <li class="mb-2"><strong>Port Numbers:</strong> Well-known (<1024) vs dynamic</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="alert alert-light mt-3 mb-0">
                                <small class="text-muted">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    <strong>Investigation Tips:</strong> Look for unusual processes listening on network ports, 
                                    services bound to all interfaces (0.0.0.0), high port numbers used by unknown processes, 
                                    and processes running as privileged users. Pay attention to remote connections and 
                                    processes that shouldn't normally accept network connections.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Find open ports data
    let portsData = null;
    let portCount = 0;
    
    // Data is already extracted by renderSectionContent, use it directly
    const dataSource = data || {};
    
    console.log('Open ports data received:', dataSource); // Debug log
    
    // Try to find ports data in various possible structures
    if (dataSource.openPorts && Array.isArray(dataSource.openPorts)) {
        portsData = dataSource.openPorts;
        portCount = portsData.length;
    } else if (dataSource.openPorts_data && Array.isArray(dataSource.openPorts_data)) {
        portsData = dataSource.openPorts_data;
        portCount = portsData.length;
    } else {
        // Try to find in nested structure
        for (const key in dataSource) {
            if (key.includes('openPorts') && dataSource[key] && Array.isArray(dataSource[key])) {
                portsData = dataSource[key];
                portCount = portsData.length;
                break;
            }
        }
    }
    
    if (portsData && portCount > 0) {
        // Calculate statistics
        const tcpPorts = portsData.filter(p => p.type && p.type.toLowerCase().includes('tcp')).length;
        const udpPorts = portsData.filter(p => p.type && p.type.toLowerCase().includes('udp')).length;
        const ipv4Ports = portsData.filter(p => p.type && p.type.toLowerCase().includes('ipv4')).length;
        const ipv6Ports = portsData.filter(p => p.type && p.type.toLowerCase().includes('ipv6')).length;
        const listeningPorts = portsData.filter(p => p.localAddress && p.localAddress !== '' && (!p.remoteAddress || p.remoteAddress === '')).length;
        
        html += `
            <div class="row mb-4">
                <div class="col-md-2">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${portCount}</h5>
                            <p class="card-text">Total Ports</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${tcpPorts}</h5>
                            <p class="card-text">TCP</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${udpPorts}</h5>
                            <p class="card-text">UDP</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${ipv4Ports}</h5>
                            <p class="card-text">IPv4</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-secondary text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${ipv6Ports}</h5>
                            <p class="card-text">IPv6</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-dark text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${listeningPorts}</h5>
                            <p class="card-text">Listening</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filters -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label for="portSearch" class="form-label">Search</label>
                                    <input type="text" class="form-control" id="portSearch" placeholder="Search by process, user, IP, or port..." oninput="filterPorts()">
                                </div>
                                <div class="col-md-2">
                                    <label for="portTypeFilter" class="form-label">Type</label>
                                    <select class="form-select" id="portTypeFilter" onchange="filterPorts()">
                                        <option value="">All Types</option>
                                        <option value="tcp">TCP</option>
                                        <option value="udp">UDP</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="portProtocolFilter" class="form-label">Protocol</label>
                                    <select class="form-select" id="portProtocolFilter" onchange="filterPorts()">
                                        <option value="">All Protocols</option>
                                        <option value="ipv4">IPv4</option>
                                        <option value="ipv6">IPv6</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="portStatusFilter" class="form-label">Status</label>
                                    <select class="form-select" id="portStatusFilter" onchange="filterPorts()">
                                        <option value="">All Status</option>
                                        <option value="listening">Listening</option>
                                        <option value="connected">Connected</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-secondary" onclick="clearPortFilters()">
                                            <i class="fas fa-times me-1"></i>Clear
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="exportPorts()">
                                            <i class="fas fa-download me-1"></i>Export
                                        </button>
                                        <span class="badge bg-primary align-self-center ms-2" id="portCount">${portCount}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ports Table -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Process</th>
                                            <th>PID</th>
                                            <th>User</th>
                                            <th>Type</th>
                                            <th>Local Address</th>
                                            <th>Local Port</th>
                                            <th>Remote Address</th>
                                            <th>Remote Port</th>
                                        </tr>
                                    </thead>
                                    <tbody id="portsTableBody">
        `;
        
        // Generate table rows
        portsData.forEach((port, index) => {
            const isListening = port.localAddress && port.localAddress !== '' && (!port.remoteAddress || port.remoteAddress === '');
            const statusClass = isListening ? 'listening' : 'connected';
            
            html += `
                <tr class="port-row" 
                    data-process="${(port.command || '').toLowerCase()}" 
                    data-user="${(port.user || '').toLowerCase()}" 
                    data-type="${(port.type || '').toLowerCase()}" 
                    data-local-ip="${(port.localIP || '').toLowerCase()}" 
                    data-local-port="${port.localPort || ''}" 
                    data-remote-ip="${(port.remoteIP || '').toLowerCase()}" 
                    data-remote-port="${port.remotePort || ''}" 
                    data-status="${statusClass}">
                    <td><span class="badge bg-secondary me-1">${port.command || 'N/A'}</span></td>
                    <td>${port.pid || 'N/A'}</td>
                    <td><span class="badge bg-info">${port.user || 'N/A'}</span></td>
                    <td><span class="badge ${port.type && port.type.toLowerCase().includes('tcp') ? 'bg-success' : 'bg-info'}">${port.type || 'N/A'}</span></td>
                    <td><code>${port.localAddress || port.localIP || 'N/A'}</code></td>
                    <td><span class="badge bg-primary">${port.localPort || 'N/A'}</span></td>
                    <td><code>${port.remoteAddress || port.remoteIP || 'N/A'}</code></td>
                    <td><span class="badge bg-warning">${port.remotePort || 'N/A'}</span></td>
                </tr>
            `;
        });
        
        html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else {
        html += `
            <div class="row">
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        No open ports data available for this case.
                    </div>
                </div>
            </div>
        `;
    }
    
    contentArea.innerHTML = html;
}

function renderNetworkSockets(data) {
    const contentArea = document.getElementById('content-area');
    
    let html = `
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="h4 mb-3">
                    <i class="fas fa-plug me-2"></i>Socket Statistics
                </h2>
            </div>
        </div>
        
        <!-- Socket Statistics Analysis Guide -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white py-2">
                        <h6 class="m-0">
                            <i class="fas fa-info-circle me-2"></i>Socket Statistics Analysis Guide
                            <button class="btn btn-sm btn-outline-light float-end" type="button" data-bs-toggle="collapse" data-bs-target="#socketsGuide" aria-expanded="false">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </h6>
                    </div>
                    <div class="collapse" id="socketsGuide">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary"><i class="fas fa-network-wired me-2"></i>Socket States</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><span class="badge bg-success me-2">LISTEN</span> Socket is listening for connections</li>
                                        <li class="mb-2"><span class="badge bg-info me-2">ESTAB</span> Established connection</li>
                                        <li class="mb-2"><span class="badge bg-warning me-2">UNCONN</span> Unconnected socket</li>
                                        <li class="mb-2"><span class="badge bg-secondary me-2">CLOSE-WAIT</span> Waiting for close</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-primary"><i class="fas fa-search me-2"></i>Security Analysis Points</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><strong>Process:</strong> Which application owns the socket</li>
                                        <li class="mb-2"><strong>PID:</strong> Process identifier for tracking</li>
                                        <li class="mb-2"><strong>Local Address:</strong> Interface and port binding</li>
                                        <li class="mb-2"><strong>Peer Address:</strong> Remote connection endpoint</li>
                                        <li class="mb-2"><strong>Queue Status:</strong> Send/Receive buffer usage</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="alert alert-light mt-3 mb-0">
                                <small class="text-muted">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    <strong>Investigation Tips:</strong> Look for unusual processes with network sockets, 
                                    services listening on unexpected interfaces, high queue values indicating potential issues, 
                                    and processes that shouldn't normally have network connections. Pay attention to 
                                    established connections to unknown remote addresses.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Find socket data
    let socketsData = null;
    let socketCount = 0;
    
    // Data is already extracted by renderSectionContent, use it directly
    const dataSource = data || {};
    
    console.log('Socket statistics data received:', dataSource); // Debug log
    console.log('Data type:', typeof dataSource);
    console.log('Is array:', Array.isArray(dataSource));
    console.log('Data keys:', Object.keys(dataSource || {}));
    
    // Try to find sockets data in various possible structures
    // The backend returns: {success: true, data: {'socketStatistics_20250825_231413.json': [socket_array]}}
    
    // First check if data is directly an array (from socketStatistics_20250825_231413.json)
    if (Array.isArray(dataSource)) {
        socketsData = dataSource;
        socketCount = socketsData.length;
        console.log('Using direct array, count:', socketCount);
        console.log('First socket sample:', socketsData[0]);
    } else if (dataSource.sockets && Array.isArray(dataSource.sockets)) {
        socketsData = dataSource.sockets;
        socketCount = socketsData.length;
        console.log('Using dataSource.sockets, count:', socketCount);
    } else if (dataSource.socketStatistics && Array.isArray(dataSource.socketStatistics)) {
        socketsData = dataSource.socketStatistics;
        socketCount = socketsData.length;
        console.log('Using dataSource.socketStatistics, count:', socketCount);
    } else {
        // Try to find in nested structure from backend response
        console.log('Searching through keys...');
        for (const key in dataSource) {
            console.log('Checking key:', key, 'type:', typeof dataSource[key], 'isArray:', Array.isArray(dataSource[key]));
            if (dataSource[key] && Array.isArray(dataSource[key])) {
                socketsData = dataSource[key];
                socketCount = socketsData.length;
                console.log('Found array in key:', key, 'count:', socketCount);
                break;
            } else if (dataSource[key] && typeof dataSource[key] === 'object' && dataSource[key].sockets && Array.isArray(dataSource[key].sockets)) {
                socketsData = dataSource[key].sockets;
                socketCount = socketsData.length;
                console.log('Found nested sockets in key:', key, 'count:', socketCount);
                break;
            }
            // Check for socketStatistics_*.json files containing arrays
            else if (key.includes('socketStatistics') && dataSource[key] && Array.isArray(dataSource[key])) {
                socketsData = dataSource[key];
                socketCount = socketsData.length;
                console.log('Found socket statistics array in key:', key, 'count:', socketCount);
                break;
            }
        }
    }
    
    if (socketsData && socketCount > 0) {
        // Calculate statistics
        const tcpSockets = socketsData.filter(s => s.netid && s.netid.toLowerCase() === 'tcp').length;
        const udpSockets = socketsData.filter(s => s.netid && s.netid.toLowerCase() === 'udp').length;
        const listeningSockets = socketsData.filter(s => s.state && s.state.toLowerCase() === 'listen').length;
        const establishedSockets = socketsData.filter(s => s.state && s.state.toLowerCase() === 'estab').length;
        const unconnnectedSockets = socketsData.filter(s => s.state && s.state.toLowerCase() === 'unconn').length;
        
        html += `
            <div class="row mb-4">
                <div class="col-md-2">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${socketCount}</h5>
                            <p class="card-text">Total Sockets</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${tcpSockets}</h5>
                            <p class="card-text">TCP</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${udpSockets}</h5>
                            <p class="card-text">UDP</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${listeningSockets}</h5>
                            <p class="card-text">Listening</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-secondary text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${establishedSockets}</h5>
                            <p class="card-text">Established</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-dark text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${unconnnectedSockets}</h5>
                            <p class="card-text">Unconnected</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filters -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label for="socketSearch" class="form-label">Search</label>
                                    <input type="text" class="form-control" id="socketSearch" placeholder="Search by process, PID, address, or port..." oninput="filterSockets()">
                                </div>
                                <div class="col-md-2">
                                    <label for="socketTypeFilter" class="form-label">Type</label>
                                    <select class="form-select" id="socketTypeFilter" onchange="filterSockets()">
                                        <option value="">All Types</option>
                                        <option value="tcp">TCP</option>
                                        <option value="udp">UDP</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="socketStateFilter" class="form-label">State</label>
                                    <select class="form-select" id="socketStateFilter" onchange="filterSockets()">
                                        <option value="">All States</option>
                                        <option value="listen">LISTEN</option>
                                        <option value="estab">ESTAB</option>
                                        <option value="unconn">UNCONN</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="socketProcessFilter" class="form-label">Process</label>
                                    <input type="text" class="form-control" id="socketProcessFilter" placeholder="Process name..." oninput="filterSockets()">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-secondary" onclick="clearSocketFilters()">
                                            <i class="fas fa-times me-1"></i>Clear
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="exportSockets()">
                                            <i class="fas fa-download me-1"></i>Export
                                        </button>
                                        <span class="badge bg-primary align-self-center ms-2" id="socketCount">${socketCount}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sockets Table -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Process</th>
                                            <th>PID</th>
                                            <th>Type</th>
                                            <th>State</th>
                                            <th>Local Address</th>
                                            <th>Peer Address</th>
                                            <th>Recv-Q</th>
                                            <th>Send-Q</th>
                                        </tr>
                                    </thead>
                                    <tbody id="socketsTableBody">
        `;
        
        // Generate table rows
        socketsData.forEach((socket, index) => {
            // Extract process name from the process field
            let processName = 'N/A';
            if (socket.process && socket.process.includes('"')) {
                const match = socket.process.match(/"([^"]+)"/); 
                if (match) {
                    processName = match[1];
                }
            }
            
            const stateClass = socket.state ? {
                'LISTEN': 'bg-success',
                'ESTAB': 'bg-info', 
                'UNCONN': 'bg-warning',
                'CLOSE-WAIT': 'bg-secondary'
            }[socket.state] || 'bg-light' : 'bg-light';
            
            html += `
                <tr class="socket-row" 
                    data-process="${processName.toLowerCase()}" 
                    data-pid="${socket.pid || ''}" 
                    data-type="${(socket.netid || '').toLowerCase()}" 
                    data-state="${(socket.state || '').toLowerCase()}" 
                    data-local-address="${(socket.localAddress || '').toLowerCase()}" 
                    data-peer-address="${(socket.peerAddress || '').toLowerCase()}">
                    <td><span class="badge bg-secondary me-1">${processName}</span></td>
                    <td>${socket.pid || 'N/A'}</td>
                    <td><span class="badge ${socket.netid && socket.netid.toLowerCase() === 'tcp' ? 'bg-success' : 'bg-info'}">${socket.netid || 'N/A'}</span></td>
                    <td><span class="badge ${stateClass}">${socket.state || 'N/A'}</span></td>
                    <td><code>${socket.localAddress || 'N/A'}</code></td>
                    <td><code>${socket.peerAddress || 'N/A'}</code></td>
                    <td><span class="badge bg-primary">${socket.recvQ || '0'}</span></td>
                    <td><span class="badge bg-warning">${socket.sendQ || '0'}</span></td>
                </tr>
            `;
        });
        
        html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else {
        html += `
            <div class="row">
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        No socket statistics data available for this case.
                    </div>
                </div>
            </div>
        `;
    }
    
    contentArea.innerHTML = html;
}

function renderNetworkInterfaces(data) {
    const contentArea = document.getElementById('content-area');
    
    let html = `
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="h4 mb-3">
                    <i class="fas fa-ethernet me-2"></i>Network Interfaces
                </h2>
            </div>
        </div>
        
        <!-- Network Interfaces Analysis Guide -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white py-2">
                        <h6 class="m-0">
                            <i class="fas fa-info-circle me-2"></i>Network Interfaces Analysis Guide
                            <button class="btn btn-sm btn-outline-light float-end" type="button" data-bs-toggle="collapse" data-bs-target="#interfaceGuide" aria-expanded="false">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </h6>
                    </div>
                    <div class="collapse" id="interfaceGuide">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary"><i class="fas fa-network-wired me-2"></i>Interface States</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><span class="badge bg-success me-2">UP</span> Interface is active and operational</li>
                                        <li class="mb-2"><span class="badge bg-secondary me-2">DOWN</span> Interface is inactive or disabled</li>
                                        <li class="mb-2"><span class="badge bg-info me-2">RUNNING</span> Interface has carrier signal</li>
                                        <li class="mb-2"><span class="badge bg-warning me-2">PROMISC</span> Promiscuous mode enabled</li>
                                        <li class="mb-2"><span class="badge bg-dark me-2">LOOPBACK</span> Local loopback interface</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-primary"><i class="fas fa-shield-alt me-2"></i>Security Analysis Points</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><strong>IP Addresses:</strong> IPv4 and IPv6 configurations</li>
                                        <li class="mb-2"><strong>MAC Address:</strong> Hardware identifier</li>
                                        <li class="mb-2"><strong>MTU Size:</strong> Maximum transmission unit</li>
                                        <li class="mb-2"><strong>Traffic Stats:</strong> RX/TX packets and bytes</li>
                                        <li class="mb-2"><strong>Interface Type:</strong> Physical, virtual, or tunnel</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="alert alert-light mt-3 mb-0">
                                <small class="text-muted">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    <strong>Investigation Tips:</strong> Look for unusual interface configurations, suspicious IP addresses, 
                                    promiscuous mode enabled on interfaces, unexpected network ranges, and hidden or tunneling interfaces. 
                                    Pay attention to interfaces with high traffic volumes or unusual naming patterns.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Find network interfaces data
    let interfacesData = null;
    let interfaceCount = 0;
    
    // Data is already extracted by renderSectionContent, use it directly
    const dataSource = data || {};
    
    console.log('Network interfaces data received:', dataSource); // Debug log
    
    // Try to find interfaces data in various possible structures
    if (dataSource.interfaces && Array.isArray(dataSource.interfaces)) {
        interfacesData = dataSource.interfaces;
        interfaceCount = interfacesData.length;
    } else {
        // Try to find in nested structure - look for networkInterfaces file
        for (const key in dataSource) {
            if (key.includes('networkInterfaces') && dataSource[key]) {
                const fileData = dataSource[key];
                // Parse ifconfig, ipAddr, and ipLink data
                interfacesData = parseNetworkInterfaceData(fileData);
                interfaceCount = interfacesData ? interfacesData.length : 0;
                break;
            }
        }
    }
    
    if (interfacesData && interfaceCount > 0) {
        // Calculate statistics
        const activeInterfaces = interfacesData.filter(i => i.status === 'UP').length;
        const ipv4Interfaces = interfacesData.filter(i => i.ipv4Address && i.ipv4Address !== '127.0.0.1').length;
        const ipv6Interfaces = interfacesData.filter(i => i.ipv6Address).length;
        
        html += `
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${interfaceCount}</h5>
                            <p class="card-text">Total Interfaces</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${activeInterfaces}</h5>
                            <p class="card-text">Active</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${ipv4Interfaces}</h5>
                            <p class="card-text">IPv4</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">${ipv6Interfaces}</h5>
                            <p class="card-text">IPv6</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filters -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">Search Interfaces</label>
                                    <input type="text" class="form-control" id="interfaceSearch" placeholder="Search by name, IP, or MAC..." oninput="filterInterfaces()">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="statusFilter" onchange="filterInterfaces()">
                                        <option value="">All Status</option>
                                        <option value="UP">UP</option>
                                        <option value="DOWN">DOWN</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Type</label>
                                    <select class="form-select" id="typeFilter" onchange="filterInterfaces()">
                                        <option value="">All Types</option>
                                        <option value="ethernet">Ethernet</option>
                                        <option value="loopback">Loopback</option>
                                        <option value="wireless">Wireless</option>
                                        <option value="bridge">Bridge</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">IP Version</label>
                                    <select class="form-select" id="ipFilter" onchange="filterInterfaces()">
                                        <option value="">All IPs</option>
                                        <option value="ipv4">IPv4 Only</option>
                                        <option value="ipv6">IPv6 Only</option>
                                        <option value="both">Both IPv4 & IPv6</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-secondary" onclick="clearInterfaceFilters()">
                                            <i class="fas fa-times me-1"></i>Clear
                                        </button>
                                        <button class="btn btn-outline-info" onclick="exportInterfaces()">
                                            <i class="fas fa-download me-1"></i>Export
                                        </button>
                                        <span class="badge bg-primary align-self-center ms-2" id="interfaceCount">${interfaceCount}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Interfaces Table -->
            <div class="row">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0" id="interfacesTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th onclick="sortInterfaces('name')" style="cursor: pointer;">
                                                Interface <i class="fas fa-sort ms-1"></i>
                                            </th>
                                            <th onclick="sortInterfaces('status')" style="cursor: pointer;">
                                                Status <i class="fas fa-sort ms-1"></i>
                                            </th>
                                            <th onclick="sortInterfaces('ipv4Address')" style="cursor: pointer;">
                                                IPv4 Address <i class="fas fa-sort ms-1"></i>
                                            </th>
                                            <th onclick="sortInterfaces('ipv6Address')" style="cursor: pointer;">
                                                IPv6 Address <i class="fas fa-sort ms-1"></i>
                                            </th>
                                            <th onclick="sortInterfaces('macAddress')" style="cursor: pointer;">
                                                MAC Address <i class="fas fa-sort ms-1"></i>
                                            </th>
                                            <th onclick="sortInterfaces('mtu')" style="cursor: pointer;">
                                                MTU <i class="fas fa-sort ms-1"></i>
                                            </th>
                                            <th>RX/TX Stats</th>
                                        </tr>
                                    </thead>
                                    <tbody>
        `;
        
        interfacesData.forEach((interface, index) => {
            const statusBadge = interface.status === 'UP' ? 'bg-success' : 'bg-secondary';
            const ipv4 = interface.ipv4Address || 'N/A';
            const ipv6 = interface.ipv6Address || 'N/A';
            const mac = interface.macAddress || 'N/A';
            const mtu = interface.mtu || 'N/A';
            const rxStats = interface.rxPackets ? `${interface.rxPackets} packets (${interface.rxBytes || 'N/A'})` : 'N/A';
            const txStats = interface.txPackets ? `${interface.txPackets} packets (${interface.txBytes || 'N/A'})` : 'N/A';
            
            html += `
                <tr class="interface-row" 
                    data-name="${interface.name}" 
                    data-status="${interface.status || 'Unknown'}" 
                    data-type="${(interface.type || 'Unknown').toLowerCase()}" 
                    data-ipv4="${interface.ipv4Address || ''}" 
                    data-ipv6="${interface.ipv6Address || ''}" 
                    data-mac="${interface.macAddress || ''}" 
                    data-mtu="${interface.mtu || 0}">
                    <td>
                        <strong>${interface.name}</strong>
                        <br><small class="text-muted">${interface.type || 'Unknown'}</small>
                    </td>
                    <td>
                        <span class="badge ${statusBadge}">${interface.status || 'Unknown'}</span>
                        ${interface.flags ? `<br><small class="text-muted">${interface.flags}</small>` : ''}
                    </td>
                    <td>
                        <code>${ipv4}</code>
                        ${interface.netmask ? `<br><small class="text-muted">Mask: ${interface.netmask}</small>` : ''}
                        ${interface.broadcast ? `<br><small class="text-muted">Broadcast: ${interface.broadcast}</small>` : ''}
                    </td>
                    <td>
                        <code>${ipv6}</code>
                        ${interface.ipv6Scope ? `<br><small class="text-muted">Scope: ${interface.ipv6Scope}</small>` : ''}
                    </td>
                    <td>
                        <code>${mac}</code>
                    </td>
                    <td>
                        <span class="badge bg-info">${mtu}</span>
                    </td>
                    <td>
                        <small class="text-success">RX: ${rxStats}</small>
                        <br><small class="text-primary">TX: ${txStats}</small>
                        ${interface.rxErrors || interface.txErrors ? `<br><small class="text-danger">Errors: RX ${interface.rxErrors || 0}, TX ${interface.txErrors || 0}</small>` : ''}
                    </td>
                </tr>
            `;
        });
        
        html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
    } else {
        // Check if this is an error response from the backend
        if (dataSource.error) {
            html += `
                <div class="card shadow border-warning">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <h5 class="text-warning mb-3">Network Interface Data Error</h5>
                        <p class="text-muted">${dataSource.error}</p>
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Expected Data:</strong> Upload artifacts containing network interface information 
                            (networkInterfaces_*.json files) to view network interface configurations.
                        </div>
                    </div>
                </div>
            `;
        } else {
            html += `
                <div class="card shadow">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-ethernet fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted mb-3">No Network Interfaces Available</h5>
                        <p class="text-muted">No network interface data found in the uploaded artifacts.</p>
                        <p class="text-muted">
                            <strong>Expected Data:</strong> Upload artifacts containing network interface information 
                            (networkInterfaces_*.json files) to view network interface configurations.
                        </p>
                    </div>
                </div>
            `;
        }
    }
    
    contentArea.innerHTML = html;
}

function parseNetworkInterfaceData(fileData) {
    const interfaces = [];
    
    // Parse ifconfig output
    if (fileData.ifconfig && fileData.ifconfig.stdout) {
        const ifconfigOutput = fileData.ifconfig.stdout;
        const interfaceBlocks = ifconfigOutput.split(/\n(?=\w)/);
        
        interfaceBlocks.forEach(block => {
            if (block.trim()) {
                const lines = block.split('\n');
                const firstLine = lines[0];
                const match = firstLine.match(/^(\w+):\s*flags=\d+<([^>]+)>\s*mtu\s+(\d+)/);
                
                if (match) {
                    const interfaceData = {
                        name: match[1],
                        flags: match[2],
                        mtu: match[3],
                        status: match[2].includes('UP') ? 'UP' : 'DOWN',
                        type: match[1].startsWith('eth') ? 'Ethernet' : 
                              match[1].startsWith('lo') ? 'Loopback' : 
                              match[1].startsWith('wlan') ? 'Wireless' : 'Other'
                    };
                    
                    // Parse additional lines for IP addresses, MAC, etc.
                    lines.forEach(line => {
                        const inetMatch = line.match(/inet\s+([\d.]+)\s+netmask\s+([\d.]+)(?:\s+broadcast\s+([\d.]+))?/);
                        const inet6Match = line.match(/inet6\s+([\w:]+)\s+prefixlen\s+(\d+)\s+scopeid\s+([\w<>]+)/);
                        const etherMatch = line.match(/ether\s+([\w:]+)/);
                        const rxMatch = line.match(/RX packets\s+(\d+)\s+bytes\s+(\d+)/);
                        const txMatch = line.match(/TX packets\s+(\d+)\s+bytes\s+(\d+)/);
                        const rxErrorMatch = line.match(/RX errors\s+(\d+)/);
                        const txErrorMatch = line.match(/TX errors\s+(\d+)/);
                        
                        if (inetMatch) {
                            interfaceData.ipv4Address = inetMatch[1];
                            interfaceData.netmask = inetMatch[2];
                            if (inetMatch[3]) interfaceData.broadcast = inetMatch[3];
                        }
                        if (inet6Match) {
                            interfaceData.ipv6Address = inet6Match[1];
                            interfaceData.ipv6Scope = inet6Match[3];
                        }
                        if (etherMatch) {
                            interfaceData.macAddress = etherMatch[1];
                        }
                        if (rxMatch) {
                            interfaceData.rxPackets = rxMatch[1];
                            interfaceData.rxBytes = rxMatch[2];
                        }
                        if (txMatch) {
                            interfaceData.txPackets = txMatch[1];
                            interfaceData.txBytes = txMatch[2];
                        }
                        if (rxErrorMatch) {
                            interfaceData.rxErrors = rxErrorMatch[1];
                        }
                        if (txErrorMatch) {
                            interfaceData.txErrors = txErrorMatch[1];
                        }
                    });
                    
                    interfaces.push(interfaceData);
                }
            }
        });
    }
    
    return interfaces;
}

function renderSystemLogs(data) {
    const contentArea = document.getElementById('content-area');
    
    // Store data globally for filter functions
    window.currentSystemLogsData = data;
    
    if (!data || Object.keys(data).length === 0) {
        contentArea.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No system logs data available</div>';
        return;
    }
    
    let html = `
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="h4 mb-3">
                    <i class="fas fa-clipboard-list me-2"></i>System Logs
                </h2>
            </div>
        </div>
        
        <!-- System Logs Analysis Guide -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white py-2">
                        <h6 class="m-0">
                            <i class="fas fa-info-circle me-2"></i>System Logs Analysis Guide
                            <button class="btn btn-sm btn-outline-light float-end" type="button" data-bs-toggle="collapse" data-bs-target="#systemGuide" aria-expanded="false">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </h6>
                    </div>
                    <div class="collapse" id="systemGuide">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-info"><i class="fas fa-search me-2"></i>What to Look For</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><strong>Service Failures:</strong> Look for failed service starts, crashes, or unexpected shutdowns</li>
                                        <li class="mb-2"><strong>Authentication Events:</strong> Monitor login attempts, privilege escalations, and access violations</li>
                                        <li class="mb-2"><strong>System Events:</strong> Check for boot messages, shutdown events, and configuration changes</li>
                                        <li class="mb-2"><strong>Application Errors:</strong> Search for application crashes, dependency issues, or resource exhaustion</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-info"><i class="fas fa-shield-alt me-2"></i>Security Indicators</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><strong>Failed Logins:</strong> Multiple authentication failures from same source</li>
                                        <li class="mb-2"><strong>Privilege Changes:</strong> Unexpected sudo usage or permission modifications</li>
                                        <li class="mb-2"><strong>Service Manipulation:</strong> Unauthorized service starts/stops or configuration changes</li>
                                        <li class="mb-2"><strong>System Modifications:</strong> Changes to critical system files or configurations</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <small class="text-muted">
                                        <i class="fas fa-lightbulb me-1"></i>
                                        <strong>Investigation Tips:</strong> Focus on error and warning messages, correlate events across different services, 
                                        look for patterns in failed authentication attempts, and monitor for unusual service behavior or configuration changes.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Calculate analytics metrics
    const metrics = calculateSystemAnalysisMetrics(data);
    
    // Analytics Cards
    html += `
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-list-alt fa-2x mb-2"></i>
                        <h4 class="mb-1">${metrics.totalEntries.toLocaleString()}</h4>
                        <small>Total Entries</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <h4 class="mb-1">${metrics.criticalEvents.toLocaleString()}</h4>
                        <small>Critical Events</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-shield-alt fa-2x mb-2"></i>
                        <h4 class="mb-1">${metrics.securityEvents.toLocaleString()}</h4>
                        <small>Security Events</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-heartbeat fa-2x mb-2"></i>
                        <h4 class="mb-1">${metrics.systemHealth}%</h4>
                        <small>System Health</small>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Filters Section
    html += `
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="m-0"><i class="fas fa-filter me-2"></i>Filters & Search</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="systemLogSearch" class="form-label">Search Logs</label>
                                <input type="text" class="form-control" id="systemLogSearch" placeholder="Search messages...">
                            </div>
                            <div class="col-md-2">
                                <label for="systemLogLevel" class="form-label">Log Level</label>
                                <select class="form-select" id="systemLogLevel">
                                    <option value="">All Levels</option>
                                    <option value="error">Error</option>
                                    <option value="warning">Warning</option>
                                    <option value="info">Info</option>
                                    <option value="debug">Debug</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="systemService" class="form-label">Service</label>
                                <select class="form-select" id="systemService">
                                    <option value="">All Services</option>
                                    ${generateServiceOptions(data)}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="systemEntryLimit" class="form-label">Entry Limit</label>
                                <select class="form-select" id="systemEntryLimit">
                                    <option value="100">100</option>
                                    <option value="250">250</option>
                                    <option value="500">500</option>
                                    <option value="1000">1000</option>
                                    <option value="all">All</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary" onclick="applySystemFilters()">Apply Filters</button>
                                    <button class="btn btn-secondary" onclick="clearSystemFilters()">Clear</button>
                                    <button class="btn btn-success" onclick="exportFilteredSystemLogs()">Export CSV</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    html += '<div class="system-logs-container" id="systemLogsTable">';
    
    // Process each log file
    Object.keys(data).forEach(filename => {
        const logData = data[filename];
        
        if (!logData || (!logData.entries && !Array.isArray(logData))) {
            return;
        }
        
        const entries = logData.entries || logData;
        const statistics = logData.statistics || {};
        
        html += `
            <div class="log-file-section mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <i class="fas fa-file-alt text-primary me-2"></i>${filename}
                    </h5>
                    <div class="log-stats">
                        <span class="badge bg-primary me-1">Total: ${statistics.total_entries || (Array.isArray(entries) ? entries.length : 0)}</span>
                        ${statistics.error_entries ? `<span class="badge bg-danger me-1">Errors: ${statistics.error_entries}</span>` : ''}
                        ${statistics.warning_entries ? `<span class="badge bg-warning me-1">Warnings: ${statistics.warning_entries}</span>` : ''}
                        ${statistics.info_entries ? `<span class="badge bg-info me-1">Info: ${statistics.info_entries}</span>` : ''}
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 150px;">Timestamp</th>
                                <th style="width: 100px;">Host</th>
                                <th style="width: 120px;">Service</th>
                                <th style="width: 60px;">PID</th>
                                <th style="width: 80px;">Level</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        // Display first 100 entries for performance
        // Ensure entries is an array before calling slice
        const displayEntries = Array.isArray(entries) ? entries.slice(0, 100) : [];
        
        displayEntries.forEach((entry, index) => {
            // Debug: Log first entry structure to console
            if (index === 0) {
                console.log('First log entry structure:', entry);
                console.log('Available keys:', Object.keys(entry));
            }
            
            // Handle multiple possible field name formats
            const timestamp = entry.timestamp || entry.time || entry.date || entry['@timestamp'] || 'N/A';
            const hostname = entry.hostname || entry.host || entry.server || entry.node || 'N/A';
            const service = entry.service || entry.program || entry.tag || entry.facility || entry.ident || 'N/A';
            const pid = entry.pid || entry.process_id || entry.proc_id || 'N/A';
            const logLevel = entry.log_level || entry.level || entry.severity || entry.priority || 'info';
            const message = entry.message || entry.msg || entry.text || entry.content || 'N/A';
            
            // Convert timestamp to readable format if it's a number
            const formattedTimestamp = (typeof timestamp === 'number') ? 
                new Date(timestamp * 1000).toLocaleString() : 
                (timestamp !== 'N/A' ? timestamp : 'N/A');
            
            // If all fields are N/A, show raw entry for debugging
            if (index < 3 && timestamp === 'N/A' && hostname === 'N/A' && service === 'N/A' && message === 'N/A') {
                console.warn(`Entry ${index} has all N/A values. Raw entry:`, JSON.stringify(entry, null, 2));
            }
            
            // Color code log levels
            let levelBadge = '';
            switch(logLevel.toLowerCase()) {
                case 'error':
                    levelBadge = '<span class="badge bg-danger">ERROR</span>';
                    break;
                case 'warning':
                case 'warn':
                    levelBadge = '<span class="badge bg-warning text-dark">WARN</span>';
                    break;
                case 'info':
                    levelBadge = '<span class="badge bg-info">INFO</span>';
                    break;
                case 'debug':
                    levelBadge = '<span class="badge bg-secondary">DEBUG</span>';
                    break;
                default:
                    levelBadge = `<span class="badge bg-light text-dark">${logLevel.toUpperCase()}</span>`;
            }
            
            html += `
                <tr>
                    <td><small>${formattedTimestamp}</small></td>
                    <td><small>${hostname}</small></td>
                    <td><small>${service}</small></td>
                    <td><small>${pid}</small></td>
                    <td>${levelBadge}</td>
                    <td><small class="text-break">${message}</small></td>
                </tr>
            `;
        });
        
        html += `
                        </tbody>
                    </table>
                </div>
        `;
        
        // Show truncation notice if there are more entries
        if (Array.isArray(entries) && entries.length > 100) {
            html += `
                <div class="alert alert-info mt-2">
                    <i class="fas fa-info-circle me-2"></i>
                    Showing first 100 entries out of ${entries.length} total entries for performance reasons.
                </div>
            `;
        }
        
        // Service statistics display removed per user request
        
        html += '</div>';
    });
    
    html += '</div>';
    contentArea.innerHTML = html;
}

function calculateSystemAnalysisMetrics(data) {
    let totalEntries = 0;
    let criticalEvents = 0;
    let securityEvents = 0;
    
    Object.keys(data).forEach(filename => {
        const logData = data[filename];
        if (!logData) return;
        
        const entries = logData.entries || logData;
        if (!Array.isArray(entries)) return;
        
        totalEntries += entries.length;
        
        entries.forEach(entry => {
            const level = (entry.level || entry.priority || entry.severity || '').toLowerCase();
            const message = (entry.message || entry.msg || '').toLowerCase();
            
            // Count critical events (error, critical, emergency levels)
            if (['error', 'err', 'crit', 'critical', 'emerg', 'emergency', 'alert'].includes(level)) {
                criticalEvents++;
            }
            
            // Count security-related events
            const securityKeywords = ['authentication', 'login', 'failed', 'denied', 'unauthorized', 'security', 'breach', 'attack', 'intrusion', 'firewall', 'blocked'];
            if (securityKeywords.some(keyword => message.includes(keyword))) {
                securityEvents++;
            }
        });
    });
    
    // Calculate system health percentage (100% - error rate)
    const errorRate = totalEntries > 0 ? (criticalEvents / totalEntries) * 100 : 0;
    const systemHealth = Math.max(0, 100 - errorRate);
    
    return {
        totalEntries,
        criticalEvents,
        securityEvents,
        systemHealth: Math.round(systemHealth)
    };
}

function generateServiceOptions(data) {
    const services = new Set();
    
    Object.keys(data).forEach(filename => {
        const logData = data[filename];
        if (!logData) return;
        
        const entries = logData.entries || logData;
        if (!Array.isArray(entries)) return;
        
        entries.forEach(entry => {
            const service = entry.service || entry.program || entry.tag || entry.ident;
            if (service && typeof service === 'string') {
                services.add(service.trim());
            }
        });
    });
    
    return Array.from(services).sort().map(service => 
        `<option value="${service}">${service}</option>`
    ).join('');
}

function renderSystemLogsTable(data, searchTerm = '', logLevel = '', service = '', limit = 100) {
    let html = '';
    let totalDisplayed = 0;
    const maxLimit = limit === 'all' ? Infinity : parseInt(limit);
    
    Object.keys(data).forEach(filename => {
        const logData = data[filename];
        if (!logData || totalDisplayed >= maxLimit) return;
        
        const entries = logData.entries || logData;
        if (!Array.isArray(entries)) return;
        
        // Filter entries
        let filteredEntries = entries.filter(entry => {
            const message = (entry.message || entry.msg || '').toLowerCase();
            const level = (entry.level || entry.priority || entry.severity || '').toLowerCase();
            const entryService = (entry.service || entry.program || entry.tag || entry.ident || '').toLowerCase();
            
            // Apply filters
            if (searchTerm && !message.includes(searchTerm.toLowerCase())) return false;
            if (logLevel && !level.includes(logLevel.toLowerCase())) return false;
            if (service && !entryService.includes(service.toLowerCase())) return false;
            
            return true;
        });
        
        // Limit entries
        const remainingLimit = maxLimit - totalDisplayed;
        if (remainingLimit < filteredEntries.length) {
            filteredEntries = filteredEntries.slice(0, remainingLimit);
        }
        
        if (filteredEntries.length === 0) return;
        
        html += `
            <div class="log-file-section mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="log-stats d-flex align-items-center">
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="showAllSystemLogs('${filename}')" title="Show all log entries">
                            <i class="fas fa-expand-arrows-alt me-1"></i>Show All
                        </button>
                        <span class="badge bg-primary me-1">Showing: ${filteredEntries.length}</span>
                        <span class="badge bg-warning text-dark me-1">Total: ${entries.length}</span>
                    </div>
                    <h5 class="mb-0">
                        <i class="fas fa-file-alt text-primary me-2"></i>${filename}
                    </h5>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Timestamp</th>
                                <th>Level</th>
                                <th>Service</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        filteredEntries.forEach(entry => {
            const timestamp = entry.timestamp || entry.time || entry.date || 'N/A';
            const level = entry.level || entry.priority || entry.severity || 'info';
            const entryService = entry.service || entry.program || entry.tag || entry.ident || 'system';
            const message = entry.message || entry.msg || 'No message';
            
            // Color code log levels
            let levelClass = 'secondary';
            const levelLower = level.toLowerCase();
            if (['error', 'err', 'crit', 'critical', 'emerg', 'emergency'].includes(levelLower)) {
                levelClass = 'danger';
            } else if (['warn', 'warning'].includes(levelLower)) {
                levelClass = 'warning';
            } else if (['info', 'notice'].includes(levelLower)) {
                levelClass = 'info';
            } else if (['debug'].includes(levelLower)) {
                levelClass = 'secondary';
            }
            
            html += `
                <tr>
                    <td><small class="text-muted">${timestamp}</small></td>
                    <td><span class="badge bg-${levelClass}">${level}</span></td>
                    <td><small>${entryService}</small></td>
                    <td>${message}</td>
                </tr>
            `;
        });
        
        html += `
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        
        totalDisplayed += filteredEntries.length;
    });
    
    if (html === '') {
        html = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No log entries match the current filters.</div>';
    }
    
    return html;
}

function applySystemFilters() {
    const searchTerm = document.getElementById('systemLogSearch').value;
    const logLevel = document.getElementById('systemLogLevel').value;
    const service = document.getElementById('systemService').value;
    const limit = document.getElementById('systemEntryLimit').value;
    
    // Get the current data from the global scope or re-fetch
    const currentSection = document.querySelector('.nav-link.active').getAttribute('data-section');
    if (currentSection === 'logs-system') {
        // Re-render with filters
        const tableContainer = document.getElementById('systemLogsTable');
        if (window.currentSystemLogsData) {
            tableContainer.innerHTML = renderSystemLogsTable(window.currentSystemLogsData, searchTerm, logLevel, service, limit);
        }
    }
}

function clearSystemFilters() {
    document.getElementById('systemLogSearch').value = '';
    document.getElementById('systemLogLevel').value = '';
    document.getElementById('systemService').value = '';
    document.getElementById('systemEntryLimit').value = '100';
    applySystemFilters();
}

function exportFilteredSystemLogs() {
    const searchTerm = document.getElementById('systemLogSearch').value;
    const logLevel = document.getElementById('systemLogLevel').value;
    const service = document.getElementById('systemService').value;
    
    if (!window.currentSystemLogsData) {
        alert('No system log data available for export.');
        return;
    }
    
    let exportData = [];
    
    Object.keys(window.currentSystemLogsData).forEach(filename => {
        const logData = window.currentSystemLogsData[filename];
        if (!logData) return;
        
        const entries = logData.entries || logData;
        if (!Array.isArray(entries)) return;
        
        entries.forEach(entry => {
            const message = (entry.message || entry.msg || '').toLowerCase();
            const entryLevel = (entry.level || entry.priority || entry.severity || '').toLowerCase();
            const entryService = (entry.service || entry.program || entry.tag || entry.ident || '').toLowerCase();
            
            // Apply filters
            if (searchTerm && !message.includes(searchTerm.toLowerCase())) return;
            if (logLevel && !entryLevel.includes(logLevel.toLowerCase())) return;
            if (service && !entryService.includes(service.toLowerCase())) return;
            
            exportData.push({
                'File': filename,
                'Timestamp': entry.timestamp || entry.time || entry.date || 'N/A',
                'Level': entry.level || entry.priority || entry.severity || 'info',
                'Service': entry.service || entry.program || entry.tag || entry.ident || 'system',
                'Message': entry.message || entry.msg || 'No message'
            });
        });
    });
    
    if (exportData.length === 0) {
        alert('No data matches the current filters.');
        return;
    }
    
    const csv = convertToCSV(exportData);
    downloadCSV(csv, 'system_logs_filtered.csv');
}

function showAllSystemLogs(filename) {
    // Get current filter values but remove the entry limit
    const logLevel = document.getElementById('systemLogLevel').value;
    const service = document.getElementById('systemService').value;
    const search = document.getElementById('systemLogSearch').value;
    
    const filters = {
        logLevel: logLevel,
        service: service,
        search: search,
        limit: 'all' // Show all entries
    };
    
    // Re-render the table with all entries
    const tableContainer = document.getElementById('systemLogsTable');
    tableContainer.innerHTML = renderSystemLogsTable(window.currentSystemLogsData, search, logLevel, service, 'all');
    
    // Update the entry limit dropdown to reflect "All"
    document.getElementById('systemEntryLimit').value = 'all';
}

function renderKernelLogs(data) {
    const contentArea = document.getElementById('content-area');
    
    let html = `
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="h4 mb-3">
                    <i class="fas fa-cog me-2"></i>Kernel Logs
                </h2>
            </div>
        </div>
        
        <!-- Kernel Logs Analysis Guide -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white py-2">
                        <h6 class="m-0">
                            <i class="fas fa-info-circle me-2"></i>Kernel Logs Analysis Guide
                            <button class="btn btn-sm btn-outline-light float-end" type="button" data-bs-toggle="collapse" data-bs-target="#kernelGuide" aria-expanded="false">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </h6>
                    </div>
                    <div class="collapse" id="kernelGuide">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-info"><i class="fas fa-search me-2"></i>What to Look For</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><strong>Hardware Errors:</strong> Look for messages about disk failures, memory errors, or CPU issues</li>
                                        <li class="mb-2"><strong>Security Events:</strong> Check for firewall blocks, failed authentication attempts, or suspicious network activity</li>
                                        <li class="mb-2"><strong>System Crashes:</strong> Search for kernel panics, segmentation faults, or unexpected reboots</li>
                                        <li class="mb-2"><strong>Performance Issues:</strong> Monitor for high load warnings, memory pressure, or I/O errors</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-info"><i class="fas fa-shield-alt me-2"></i>Security Indicators</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><strong>Rootkit Detection:</strong> Unusual kernel module loading or system call modifications</li>
                                        <li class="mb-2"><strong>Buffer Overflows:</strong> Segmentation faults in system processes</li>
                                        <li class="mb-2"><strong>Privilege Escalation:</strong> Unexpected changes in process privileges</li>
                                        <li class="mb-2"><strong>Network Anomalies:</strong> Unusual network interface behavior or firewall events</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <small class="text-muted">
                                        <i class="fas fa-lightbulb me-1"></i>
                                        <strong>Investigation Tips:</strong> Focus on error and warning level messages, look for patterns in timestamps, 
                                        check for hardware-related issues, and monitor for security-related kernel events like firewall blocks or authentication failures.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    if (!data || Object.keys(data).length === 0) {
        html += '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No kernel logs data available</div>';
        contentArea.innerHTML = html;
        return;
    }
    
    // Store original data for filtering
    window.kernelLogsData = data;
    
    // Calculate analysis metrics
    const analysisMetrics = calculateKernelAnalysisMetrics(data);
    
    // Analytics Cards Section
    html += `
        <!-- Kernel Logs Statistics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card border-success h-100">
                    <div class="card-body text-center">
                        <div class="d-flex align-items-center justify-content-center mb-2">
                            <i class="fas fa-list-alt fa-2x text-success me-2"></i>
                            <div>
                                <h4 class="mb-0 text-success">${analysisMetrics.totalEntries}</h4>
                                <small class="text-muted">Total Entries</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-danger h-100">
                    <div class="card-body text-center">
                        <div class="d-flex align-items-center justify-content-center mb-2">
                            <i class="fas fa-exclamation-triangle fa-2x text-danger me-2"></i>
                            <div>
                                <h4 class="mb-0 text-danger">${analysisMetrics.criticalEvents}</h4>
                                <small class="text-muted">Critical Events</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-warning h-100">
                    <div class="card-body text-center">
                        <div class="d-flex align-items-center justify-content-center mb-2">
                            <i class="fas fa-shield-alt fa-2x text-warning me-2"></i>
                            <div>
                                <h4 class="mb-0 text-warning">${analysisMetrics.securityEvents}</h4>
                                <small class="text-muted">Security Events</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-info h-100">
                    <div class="card-body text-center">
                        <div class="d-flex align-items-center justify-content-center mb-2">
                            <i class="fas fa-heartbeat fa-2x text-info me-2"></i>
                            <div>
                                <h4 class="mb-0 text-info">${analysisMetrics.systemHealth}%</h4>
                                <small class="text-muted">System Health</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Kernel Logs Filters -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white py-2">
                        <h6 class="m-0">
                            <i class="fas fa-filter me-2"></i>Kernel Logs Filters
                            <button class="btn btn-sm btn-outline-light float-end" type="button" data-bs-toggle="collapse" data-bs-target="#kernelFilters" aria-expanded="true">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </h6>
                    </div>
                    <div class="collapse show" id="kernelFilters">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <label for="kernelSearch" class="form-label">Search Logs</label>
                                    <input type="text" class="form-control" id="kernelSearch" placeholder="Search by message, facility..." onkeyup="applyKernelFilters()">
                                </div>
                                <div class="col-md-2">
                                    <label for="logLevelFilter" class="form-label">Log Level</label>
                                    <select class="form-select" id="logLevelFilter" onchange="applyKernelFilters()">
                                        <option value="">All Levels</option>
                                        <option value="emerg">Emergency</option>
                                        <option value="alert">Alert</option>
                                        <option value="crit">Critical</option>
                                        <option value="err">Error</option>
                                        <option value="warning">Warning</option>
                                        <option value="notice">Notice</option>
                                        <option value="info">Info</option>
                                        <option value="debug">Debug</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="facilityFilter" class="form-label">Facility</label>
                                    <select class="form-select" id="facilityFilter" onchange="applyKernelFilters()">
                                        <option value="">All Facilities</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="entryLimit" class="form-label">Show Entries</label>
                                    <select class="form-select" id="entryLimit" onchange="applyKernelFilters()">
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                        <option value="150" selected>150</option>
                                        <option value="500">500</option>
                                        <option value="all">All</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-secondary" onclick="clearKernelFilters()">
                                            <i class="fas fa-times me-1"></i>Clear
                                        </button>
                                        <button class="btn btn-outline-success" onclick="exportFilteredKernelLogs()">
                                            <i class="fas fa-download me-1"></i>Export CSV
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Logs Display Section
    html += '<div id="kernel-logs-display">';
    html += renderKernelLogsTable(data, {});
    html += '</div>';
    
    html += '</div>';
    contentArea.innerHTML = html;
}

function calculateKernelAnalysisMetrics(data) {
    let totalEntries = 0;
    let criticalEvents = 0;
    let securityEvents = 0;
    let facilities = new Set();
    
    Object.keys(data).forEach(filename => {
        const logData = data[filename];
        const entries = logData.entries || logData;
        
        if (Array.isArray(entries)) {
            totalEntries += entries.length;
            
            entries.forEach(entry => {
                const logLevel = (entry.log_level || entry.priority || 'info').toLowerCase();
                const message = (entry.message || '').toLowerCase();
                const facility = entry.facility || entry.service || 'kernel';
                
                facilities.add(facility);
                
                // Count critical events
                if (['emerg', 'alert', 'crit', 'err'].includes(logLevel)) {
                    criticalEvents++;
                }
                
                // Count security events
                if (message.includes('firewall') || message.includes('iptables') || 
                    message.includes('denied') || message.includes('blocked') ||
                    message.includes('segfault') || message.includes('oops') ||
                    message.includes('protection') || message.includes('violation')) {
                    securityEvents++;
                }
            });
        }
    });
    
    // Calculate system health (simple heuristic)
    const errorRate = totalEntries > 0 ? (criticalEvents / totalEntries) * 100 : 0;
    const systemHealth = Math.max(0, Math.min(100, 100 - (errorRate * 10)));
    
    return {
        totalEntries,
        criticalEvents,
        securityEvents,
        systemHealth: Math.round(systemHealth),
        facilities: Array.from(facilities)
    };
}

function generateFacilityOptions(facilities) {
    return facilities.map(facility => 
        `<option value="${facility}">${facility}</option>`
    ).join('');
}

function renderKernelLogsTable(data, filters = {}) {
    let html = '';
    
    Object.keys(data).forEach(filename => {
        const logData = data[filename];
        
        if (!logData || (!logData.entries && !Array.isArray(logData))) {
            return;
        }
        
        let entries = logData.entries || logData;
        const statistics = logData.statistics || {};
        
        // Apply filters
        if (filters.logLevel) {
            entries = entries.filter(entry => 
                (entry.log_level || entry.priority || 'info').toLowerCase().includes(filters.logLevel.toLowerCase())
            );
        }
        
        if (filters.facility) {
            entries = entries.filter(entry => 
                (entry.facility || entry.service || 'kernel').toLowerCase().includes(filters.facility.toLowerCase())
            );
        }
        
        if (filters.search) {
            entries = entries.filter(entry => 
                (entry.message || '').toLowerCase().includes(filters.search.toLowerCase())
            );
        }
        
        const limit = filters.limit === null || filters.limit === 'all' ? entries.length : (filters.limit || 150);
        const displayEntries = entries.slice(0, limit);
        
        html += `
            <div class="log-file-section mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="log-stats d-flex align-items-center">
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="showAllKernelLogs('${filename}')" title="Show all log entries">
                            <i class="fas fa-expand-arrows-alt me-1"></i>Show All
                        </button>
                        <span class="badge bg-primary me-1">Showing: ${displayEntries.length}</span>
                        <span class="badge bg-warning text-dark me-1">Total: ${entries.length}</span>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 150px;">Timestamp</th>
                                <th style="width: 100px;">Host</th>
                                <th style="width: 120px;">Facility</th>
                                <th style="width: 80px;">Level</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        displayEntries.forEach(entry => {
            const timestamp = entry.timestamp ? new Date(entry.timestamp * 1000).toLocaleString() : 'N/A';
            const hostname = entry.hostname || 'N/A';
            const facility = entry.facility || entry.service || 'kernel';
            const logLevel = entry.log_level || entry.priority || 'info';
            const message = entry.message || 'N/A';
            
            // Color code log levels for kernel logs
            let levelBadge = '';
            let rowClass = '';
            switch(logLevel.toLowerCase()) {
                case 'emerg':
                case 'emergency':
                    levelBadge = '<span class="badge bg-danger">EMERG</span>';
                    rowClass = 'table-danger';
                    break;
                case 'alert':
                    levelBadge = '<span class="badge bg-danger">ALERT</span>';
                    rowClass = 'table-danger';
                    break;
                case 'crit':
                case 'critical':
                    levelBadge = '<span class="badge bg-danger">CRIT</span>';
                    rowClass = 'table-danger';
                    break;
                case 'err':
                case 'error':
                    levelBadge = '<span class="badge bg-danger">ERROR</span>';
                    rowClass = 'table-danger';
                    break;
                case 'warning':
                case 'warn':
                    levelBadge = '<span class="badge bg-warning text-dark">WARN</span>';
                    rowClass = 'table-warning';
                    break;
                case 'notice':
                    levelBadge = '<span class="badge bg-info">NOTICE</span>';
                    break;
                case 'info':
                    levelBadge = '<span class="badge bg-info">INFO</span>';
                    break;
                case 'debug':
                    levelBadge = '<span class="badge bg-secondary">DEBUG</span>';
                    break;
                default:
                    levelBadge = `<span class="badge bg-light text-dark">${logLevel.toUpperCase()}</span>`;
            }
            
            html += `
                <tr class="${rowClass}">
                    <td><small>${timestamp}</small></td>
                    <td><small>${hostname}</small></td>
                    <td><small>${facility}</small></td>
                    <td>${levelBadge}</td>
                    <td><small class="text-break">${message}</small></td>
                </tr>
            `;
        });
        
        html += `
                        </tbody>
                    </table>
                </div>
        `;
        
        // Show filter results info
        if (entries.length !== (logData.entries || logData).length) {
            html += `
                <div class="alert alert-info mt-2">
                    <i class="fas fa-filter me-2"></i>
                    Filtered results: ${entries.length} entries (from ${(logData.entries || logData).length} total)
                </div>
            `;
        } else if (entries.length > limit) {
            html += `
                <div class="alert alert-info mt-2">
                    <i class="fas fa-info-circle me-2"></i>
                    Showing first ${limit} entries out of ${entries.length} total entries.
                </div>
            `;
        }
        
        html += '</div>';
    });
    
    return html;
}

function applyKernelFilters() {
    const logLevel = document.getElementById('logLevelFilter').value;
    const facility = document.getElementById('facilityFilter').value;
    const search = document.getElementById('kernelSearch').value;
    const limitValue = document.getElementById('entryLimit').value;
    const limit = limitValue === 'all' ? 'all' : parseInt(limitValue);
    
    const filters = {
        logLevel: logLevel,
        facility: facility,
        search: search,
        limit: limit
    };
    
    const displayArea = document.getElementById('kernel-logs-display');
    displayArea.innerHTML = renderKernelLogsTable(window.kernelLogsData, filters);
}

function clearKernelFilters() {
    document.getElementById('logLevelFilter').value = '';
    document.getElementById('facilityFilter').value = '';
    document.getElementById('kernelSearch').value = '';
    document.getElementById('entryLimit').value = '150';
    applyKernelFilters();
}

function exportFilteredKernelLogs() {
    const logLevel = document.getElementById('logLevelFilter').value;
    const facility = document.getElementById('facilityFilter').value;
    const search = document.getElementById('kernelSearch').value;
    
    let exportData = [];
    
    Object.keys(window.kernelLogsData).forEach(filename => {
        const logData = window.kernelLogsData[filename];
        let entries = logData.entries || logData;
        
        // Apply same filters as display
        if (logLevel) {
            entries = entries.filter(entry => 
                (entry.log_level || entry.priority || 'info').toLowerCase().includes(logLevel.toLowerCase())
            );
        }
        
        if (facility) {
            entries = entries.filter(entry => 
                (entry.facility || entry.service || 'kernel').toLowerCase().includes(facility.toLowerCase())
            );
        }
        
        if (search) {
            entries = entries.filter(entry => 
                (entry.message || '').toLowerCase().includes(search.toLowerCase())
            );
        }
        
        entries.forEach(entry => {
            exportData.push({
                file: filename,
                timestamp: entry.timestamp ? new Date(entry.timestamp * 1000).toISOString() : 'N/A',
                hostname: entry.hostname || 'N/A',
                facility: entry.facility || entry.service || 'kernel',
                level: entry.log_level || entry.priority || 'info',
                message: entry.message || 'N/A'
            });
        });
    });
    
    // Convert to CSV and download
    const csv = convertToCSV(exportData);
    downloadCSV(csv, 'kernel_logs_filtered.csv');
}

function showAllKernelLogs(filename) {
    // Get current filter values but remove the entry limit
    const logLevel = document.getElementById('logLevelFilter').value;
    const facility = document.getElementById('facilityFilter').value;
    const search = document.getElementById('kernelSearch').value;
    
    const filters = {
        logLevel: logLevel,
        facility: facility,
        search: search,
        limit: 'all' // Show all entries
    };
    
    // Re-render the table with all entries
    const displayArea = document.getElementById('kernel-logs-display');
    displayArea.innerHTML = renderKernelLogsTable(window.kernelLogsData, filters);
    
    // Update the entry limit dropdown to reflect "All"
    document.getElementById('entryLimit').value = 'all';
}

function convertToCSV(data) {
    if (!data.length) return '';
    
    const headers = Object.keys(data[0]);
    const csvContent = [
        headers.join(','),
        ...data.map(row => 
            headers.map(header => 
                `"${(row[header] || '').toString().replace(/"/g, '""')}"`
            ).join(',')
        )
    ].join('\n');
    
    return csvContent;
}

function downloadCSV(csv, filename) {
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('hidden', '');
    a.setAttribute('href', url);
    a.setAttribute('download', filename);
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        // Show success message
        const toast = document.createElement('div');
        toast.className = 'toast align-items-center text-white bg-success border-0 position-fixed';
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-check me-2"></i>Copied to clipboard!
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        document.body.appendChild(toast);
        
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        // Remove toast after it's hidden
        toast.addEventListener('hidden.bs.toast', function() {
            this.remove();
        });
    }).catch(function(err) {
        console.error('Failed to copy text: ', err);
    });
}

// Network Connections Functions
function filterConnections() {
    const searchTerm = document.getElementById('connectionSearch').value.toLowerCase();
    const protocolFilter = document.getElementById('protocolFilter').value.toLowerCase();
    const stateFilter = document.getElementById('stateFilter').value.toLowerCase();
    const portFilter = document.getElementById('portFilter').value;
    
    const rows = document.querySelectorAll('.connection-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const protocol = row.dataset.protocol;
        const state = row.dataset.state;
        const localPort = parseInt(row.dataset.localPort);
        const remotePort = parseInt(row.dataset.remotePort);
        const localIP = row.dataset.localIp;
        const remoteIP = row.dataset.remoteIp;
        
        let showRow = true;
        
        // Search filter
        if (searchTerm) {
            const searchableText = `${protocol} ${state} ${localIP} ${remoteIP} ${localPort} ${remotePort}`.toLowerCase();
            if (!searchableText.includes(searchTerm)) {
                showRow = false;
            }
        }
        
        // Protocol filter
        if (protocolFilter && protocol !== protocolFilter) {
            showRow = false;
        }
        
        // State filter
        if (stateFilter && state !== stateFilter) {
            showRow = false;
        }
        
        // Port range filter
        if (portFilter) {
            const port = Math.max(localPort, remotePort);
            if (portFilter === 'well-known' && port > 1023) {
                showRow = false;
            } else if (portFilter === 'registered' && (port <= 1023 || port > 49151)) {
                showRow = false;
            } else if (portFilter === 'dynamic' && port <= 49151) {
                showRow = false;
            }
        }
        
        row.style.display = showRow ? '' : 'none';
        if (showRow) visibleCount++;
    });
    
    // Update count badge
    const countBadge = document.getElementById('connectionCount');
    if (countBadge) {
        countBadge.textContent = visibleCount;
    }
}

function clearConnectionFilters() {
    document.getElementById('connectionSearch').value = '';
    document.getElementById('protocolFilter').value = '';
    document.getElementById('stateFilter').value = '';
    document.getElementById('portFilter').value = '';
    filterConnections();
}

let connectionSortOrder = {};

function sortConnections(column) {
    const table = document.getElementById('connectionsTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Toggle sort order
    connectionSortOrder[column] = connectionSortOrder[column] === 'asc' ? 'desc' : 'asc';
    const isAscending = connectionSortOrder[column] === 'asc';
    
    rows.sort((a, b) => {
        let aVal, bVal;
        
        switch (column) {
            case 'protocol':
                aVal = a.dataset.protocol;
                bVal = b.dataset.protocol;
                break;
            case 'localAddress':
                aVal = a.dataset.localIp;
                bVal = b.dataset.localIp;
                break;
            case 'remoteAddress':
                aVal = a.dataset.remoteIp;
                bVal = b.dataset.remoteIp;
                break;
            case 'state':
                aVal = a.dataset.state;
                bVal = b.dataset.state;
                break;
            case 'localPort':
                aVal = parseInt(a.dataset.localPort) || 0;
                bVal = parseInt(b.dataset.localPort) || 0;
                break;
            case 'remotePort':
                aVal = parseInt(a.dataset.remotePort) || 0;
                bVal = parseInt(b.dataset.remotePort) || 0;
                break;
            default:
                return 0;
        }
        
        if (typeof aVal === 'string') {
            return isAscending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        } else {
            return isAscending ? aVal - bVal : bVal - aVal;
        }
    });
    
    // Clear tbody and append sorted rows
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
    
    // Update sort indicators
    const headers = table.querySelectorAll('th[onclick]');
    headers.forEach(header => {
        const icon = header.querySelector('i');
        if (header.getAttribute('onclick').includes(column)) {
            icon.className = `fas fa-sort-${isAscending ? 'up' : 'down'} ms-1`;
        } else {
            icon.className = 'fas fa-sort ms-1';
        }
    });
}

function exportConnections() {
    const table = document.getElementById('connectionsTable');
    if (!table) return;
    
    const rows = table.querySelectorAll('tr');
    let csv = '';
    
    // Add headers
    const headers = Array.from(rows[0].querySelectorAll('th')).map(th => th.textContent.trim().replace(/\s+/g, ' '));
    csv += headers.join(',') + '\n';
    
    // Add data rows (only visible ones)
    const dataRows = Array.from(rows).slice(1).filter(row => row.style.display !== 'none');
    dataRows.forEach(row => {
        const cells = Array.from(row.querySelectorAll('td')).map(td => {
            // Extract text content, handling badges and code elements
            let text = td.textContent.trim().replace(/\s+/g, ' ');
            // Remove "IP: " prefix from address cells
            text = text.replace(/IP: /g, '');
            return `"${text}"`;
        });
        csv += cells.join(',') + '\n';
    });
    
    // Download CSV
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `network_connections_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Network Interfaces Functions
function filterInterfaces() {
    const searchTerm = document.getElementById('interfaceSearch').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value.toLowerCase();
    const typeFilter = document.getElementById('typeFilter').value.toLowerCase();
    const ipFilter = document.getElementById('ipFilter').value;
    
    const rows = document.querySelectorAll('.interface-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const name = row.dataset.name.toLowerCase();
        const status = row.dataset.status.toLowerCase();
        const type = row.dataset.type.toLowerCase();
        const ipv4 = row.dataset.ipv4.toLowerCase();
        const ipv6 = row.dataset.ipv6.toLowerCase();
        const mac = row.dataset.mac.toLowerCase();
        
        let showRow = true;
        
        // Search filter
        if (searchTerm) {
            const searchableText = `${name} ${ipv4} ${ipv6} ${mac}`.toLowerCase();
            if (!searchableText.includes(searchTerm)) {
                showRow = false;
            }
        }
        
        // Status filter
        if (statusFilter && status !== statusFilter) {
            showRow = false;
        }
        
        // Type filter
        if (typeFilter && type !== typeFilter) {
            showRow = false;
        }
        
        // IP version filter
        if (ipFilter) {
            const hasIPv4 = ipv4 && ipv4 !== 'n/a' && ipv4.trim() !== '';
            const hasIPv6 = ipv6 && ipv6 !== 'n/a' && ipv6.trim() !== '';
            
            if (ipFilter === 'ipv4' && !hasIPv4) {
                showRow = false;
            } else if (ipFilter === 'ipv6' && !hasIPv6) {
                showRow = false;
            } else if (ipFilter === 'both' && (!hasIPv4 || !hasIPv6)) {
                showRow = false;
            }
        }
        
        row.style.display = showRow ? '' : 'none';
        if (showRow) visibleCount++;
    });
    
    // Update count badge
    const countBadge = document.getElementById('interfaceCount');
    if (countBadge) {
        countBadge.textContent = visibleCount;
    }
}

function clearInterfaceFilters() {
    document.getElementById('interfaceSearch').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('typeFilter').value = '';
    document.getElementById('ipFilter').value = '';
    filterInterfaces();
}

let interfaceSortOrder = {};

function sortInterfaces(column) {
    const table = document.getElementById('interfacesTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Toggle sort order
    interfaceSortOrder[column] = interfaceSortOrder[column] === 'asc' ? 'desc' : 'asc';
    const isAscending = interfaceSortOrder[column] === 'asc';
    
    rows.sort((a, b) => {
        let aVal, bVal;
        
        switch (column) {
            case 'name':
                aVal = a.dataset.name;
                bVal = b.dataset.name;
                break;
            case 'status':
                aVal = a.dataset.status;
                bVal = b.dataset.status;
                break;
            case 'ipv4Address':
                aVal = a.dataset.ipv4;
                bVal = b.dataset.ipv4;
                break;
            case 'ipv6Address':
                aVal = a.dataset.ipv6;
                bVal = b.dataset.ipv6;
                break;
            case 'macAddress':
                aVal = a.dataset.mac;
                bVal = b.dataset.mac;
                break;
            case 'mtu':
                aVal = parseInt(a.dataset.mtu) || 0;
                bVal = parseInt(b.dataset.mtu) || 0;
                return isAscending ? aVal - bVal : bVal - aVal;
            default:
                return 0;
        }
        
        if (aVal < bVal) return isAscending ? -1 : 1;
        if (aVal > bVal) return isAscending ? 1 : -1;
        return 0;
    });
    
    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
    
    // Update sort indicators
    const headers = table.querySelectorAll('th[onclick]');
    headers.forEach(header => {
        const icon = header.querySelector('i');
        if (icon) {
            icon.className = 'fas fa-sort ms-1';
        }
    });
    
    const currentHeader = table.querySelector(`th[onclick="sortInterfaces('${column}')"]`);
    if (currentHeader) {
        const icon = currentHeader.querySelector('i');
        if (icon) {
            icon.className = `fas fa-sort-${isAscending ? 'up' : 'down'} ms-1`;
        }
    }
}

function exportInterfaces() {
    const table = document.getElementById('interfacesTable');
    if (!table) return;
    
    const rows = table.querySelectorAll('tr');
    let csv = '';
    
    // Add headers
    const headers = Array.from(rows[0].querySelectorAll('th')).map(th => th.textContent.trim().replace(/\s+/g, ' '));
    csv += headers.join(',') + '\n';
    
    // Add data rows (only visible ones)
    const dataRows = Array.from(rows).slice(1).filter(row => row.style.display !== 'none');
    dataRows.forEach(row => {
        const cells = Array.from(row.querySelectorAll('td')).map(td => {
            // Extract text content, handling badges and code elements
            let text = td.textContent.trim().replace(/\s+/g, ' ');
            return `"${text}"`;
        });
        csv += cells.join(',') + '\n';
    });
    
    // Download CSV
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `network_interfaces_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function renderNetworkRouting(data) {
    const contentArea = document.getElementById('content-area');
    
    let html = `
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="h4 mb-3">
                    <i class="fas fa-route me-2"></i>Routing Table
                </h2>
            </div>
        </div>
    `;
    
    if (!data || !data.routing_table || data.routing_table.length === 0) {
        html += `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>No routing table data available.
            </div>
        `;
    } else {
        html += `
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">System Routing Table</h6>
                    <button class="btn btn-sm btn-outline-primary" onclick="exportRoutingTableCSV()"><i class="fas fa-download me-1"></i>Export CSV</button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="routingTable" width="100%" cellspacing="0">
                            <thead class="table-light">
                                <tr>
                                    <th>Destination</th>
                                    <th>Gateway</th>
                                    <th>Genmask</th>
                                    <th>Flags</th>
                                    <th>Metric</th>
                                    <th>Ref</th>
                                    <th>Use</th>
                                    <th>Interface</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.routing_table.map(route => `
                                    <tr>
                                        <td>${route.destination || 'N/A'}</td>
                                        <td>${route.gateway || 'N/A'}</td>
                                        <td>${route.genmask || 'N/A'}</td>
                                        <td>${route.flags || 'N/A'}</td>
                                        <td>${route.metric || 'N/A'}</td>
                                        <td>${route.ref || 'N/A'}</td>
                                        <td>${route.use || 'N/A'}</td>
                                        <td>${route.iface || 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }
    
    contentArea.innerHTML = html;
    
    // Initialize DataTable if data exists
    if (data && data.routing_table && data.routing_table.length > 0) {
        $('#routingTable').DataTable({
            order: [[0, 'asc']],
            pageLength: 25
        });
    }
}

function exportRoutingTableCSV() {
    const table = document.getElementById('routingTable');
    if (!table) return;
    
    const rows = Array.from(table.querySelectorAll('tr'));
    const csvContent = rows.map(row => {
        const cells = Array.from(row.querySelectorAll('th, td'));
        return cells.map(cell => `"${cell.textContent.replace(/"/g, '""')}"`).join(',');
    }).join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `routing_table_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Authentication Events filtering functions
let authOriginalData = [];
let authSortOrder = {};

function filterAuthEvents() {
    const searchTerm = document.getElementById('authSearch').value.toLowerCase();
    const eventTypeFilter = document.getElementById('eventTypeFilter').value;
    const resultFilter = document.getElementById('resultFilter').value;
    const usernameFilter = document.getElementById('usernameFilter').value;
    
    const rows = document.querySelectorAll('.auth-event-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const eventType = cells[1] ? cells[1].textContent.trim() : '';
        const username = cells[2] ? cells[2].textContent.trim() : '';
        const result = cells[3] ? cells[3].textContent.trim() : '';
        const rowText = row.textContent.toLowerCase();
        
        let show = true;
        
        // Search filter
        if (searchTerm && !rowText.includes(searchTerm)) {
            show = false;
        }
        
        // Event type filter
        if (eventTypeFilter && !eventType.includes(eventTypeFilter)) {
            show = false;
        }
        
        // Result filter
        if (resultFilter && !result.includes(resultFilter)) {
            show = false;
        }
        
        // Username filter
        if (usernameFilter && !username.includes(usernameFilter)) {
            show = false;
        }
        
        row.style.display = show ? '' : 'none';
        if (show) visibleCount++;
    });
    
    // Update count
    const countElement = document.getElementById('authEventsCount');
    if (countElement) {
        countElement.textContent = visibleCount + ' events';
    }
}

function clearAuthFilters() {
    document.getElementById('authSearch').value = '';
    document.getElementById('eventTypeFilter').value = '';
    document.getElementById('resultFilter').value = '';
    document.getElementById('usernameFilter').value = '';
    filterAuthEvents();
}

function exportAuthEvents() {
    if (!window.originalAuthData || window.originalAuthData.length === 0) {
        alert('No authentication data available to export.');
        return;
    }
    
    // Create CSV content
    const headers = ['Timestamp', 'Event Type', 'Username', 'Result', 'Source', 'Details'];
    let csvContent = headers.join(',') + '\n';
    
    window.originalAuthData.forEach(entry => {
        const row = [
            entry.timestamp || '',
            entry.event_type || '',
            entry.username || '',
            entry.result || '',
            entry.source || '',
            (entry.details || entry.message || '').replace(/"/g, '""')
        ];
        csvContent += row.map(field => `"${field}"`).join(',') + '\n';
    });
    
    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `authentication_events_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function renderSoftwareInstalled(data) {
    const contentArea = document.getElementById('content-area');
    
    let html = `
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="h4 mb-3">
                    <i class="fas fa-box me-2"></i>Installed Packages
                </h2>
            </div>
        </div>
        
        <!-- Software Analysis Guide -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white py-2">
                        <h6 class="m-0">
                            <i class="fas fa-info-circle me-2"></i>Software Analysis Guide
                            <button class="btn btn-sm btn-outline-light float-end" type="button" data-bs-toggle="collapse" data-bs-target="#softwareGuide" aria-expanded="false">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </h6>
                    </div>
                    <div class="collapse" id="softwareGuide">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-info"><i class="fas fa-search me-2"></i>What to Look For</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><strong>Suspicious Packages:</strong> Look for unknown or recently installed packages that could be malicious</li>
                                        <li class="mb-2"><strong>Development Tools:</strong> Check for compilers, debuggers, or hacking tools that shouldn't be present</li>
                                        <li class="mb-2"><strong>Network Tools:</strong> Monitor for network scanning tools, proxies, or tunneling software</li>
                                        <li class="mb-2"><strong>System Utilities:</strong> Review system administration tools that could be used for privilege escalation</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-info"><i class="fas fa-shield-alt me-2"></i>Security Indicators</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><strong>Backdoor Software:</strong> Remote access tools, keyloggers, or rootkit components</li>
                                        <li class="mb-2"><strong>Cryptominers:</strong> Mining software or cryptocurrency-related packages</li>
                                        <li class="mb-2"><strong>Persistence Tools:</strong> Software designed to maintain access or hide presence</li>
                                        <li class="mb-2"><strong>Data Exfiltration:</strong> File transfer utilities or cloud storage sync tools</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <small class="text-muted">
                                        <i class="fas fa-lightbulb me-1"></i>
                                        <strong>Investigation Tips:</strong> Focus on recently installed packages, check package sources and repositories, 
                                        look for packages with suspicious names or descriptions, and verify the legitimacy of development tools and system utilities.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    if (!data || !data.packages || data.packages.length === 0) {
        html += '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No installed packages data available</div>';
        contentArea.innerHTML = html;
        return;
    }

    const packages = data.packages;
    const totalPackages = packages.length;
    const installedCount = packages.filter(pkg => pkg.status === 'installed').length;
    const configFilesCount = packages.filter(pkg => pkg.status === 'config-files').length;
    const notInstalledCount = packages.filter(pkg => pkg.status === 'not-installed').length;
    
    // Analytics Cards Section
    html += `
        <!-- Software Statistics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card border-primary h-100">
                    <div class="card-body text-center">
                        <div class="d-flex align-items-center justify-content-center mb-2">
                            <i class="fas fa-box fa-2x text-primary me-2"></i>
                            <div>
                                <h4 class="mb-0 text-primary">${totalPackages}</h4>
                                <small class="text-muted">Total Packages</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-success h-100">
                    <div class="card-body text-center">
                        <div class="d-flex align-items-center justify-content-center mb-2">
                            <i class="fas fa-check-circle fa-2x text-success me-2"></i>
                            <div>
                                <h4 class="mb-0 text-success">${installedCount}</h4>
                                <small class="text-muted">Installed</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-warning h-100">
                    <div class="card-body text-center">
                        <div class="d-flex align-items-center justify-content-center mb-2">
                            <i class="fas fa-cog fa-2x text-warning me-2"></i>
                            <div>
                                <h4 class="mb-0 text-warning">${configFilesCount}</h4>
                                <small class="text-muted">Config Files</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-info h-100">
                    <div class="card-body text-center">
                        <div class="d-flex align-items-center justify-content-center mb-2">
                            <i class="fas fa-times-circle fa-2x text-info me-2"></i>
                            <div>
                                <h4 class="mb-0 text-info">${notInstalledCount}</h4>
                                <small class="text-muted">Not Installed</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Software Filters -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white py-2">
                        <h6 class="m-0">
                            <i class="fas fa-filter me-2"></i>Software Filters
                            <button class="btn btn-sm btn-outline-light float-end" type="button" data-bs-toggle="collapse" data-bs-target="#softwareFilters" aria-expanded="true">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </h6>
                    </div>
                    <div class="collapse show" id="softwareFilters">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <label for="packageSearch" class="form-label">Search Packages</label>
                                    <input type="text" class="form-control" id="packageSearch" placeholder="Search by name, description..." onkeyup="filterPackages()">
                                </div>
                                <div class="col-md-2">
                                    <label for="statusFilter" class="form-label">Status</label>
                                    <select class="form-select" id="statusFilter" onchange="filterPackages()">
                                        <option value="">All Status</option>
                                        <option value="installed">Installed</option>
                                        <option value="config-files">Config Files</option>
                                        <option value="not-installed">Not Installed</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="priorityFilter" class="form-label">Priority</label>
                                    <select class="form-select" id="priorityFilter" onchange="filterPackages()">
                                        <option value="">All Priorities</option>
                                        <option value="required">Required</option>
                                        <option value="important">Important</option>
                                        <option value="standard">Standard</option>
                                        <option value="optional">Optional</option>
                                        <option value="extra">Extra</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="entryLimit" class="form-label">Show Entries</label>
                                    <select class="form-select" id="entryLimit" onchange="filterPackages()">
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                        <option value="150" selected>150</option>
                                        <option value="500">500</option>
                                        <option value="all">All</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-secondary" onclick="clearPackageFilters()">
                                            <i class="fas fa-times me-1"></i>Clear
                                        </button>
                                        <button class="btn btn-outline-success" onclick="exportPackages()">
                                            <i class="fas fa-download me-1"></i>Export CSV
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Packages Display Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="packagesTable" style="table-layout: auto; width: 100%;">
                        <thead class="table-dark">
                            <tr>
                                <th onclick="sortPackagesTable(0)" style="cursor: pointer; white-space: nowrap; min-width: 120px;">Name <i class="fas fa-sort"></i></th>
                                <th onclick="sortPackagesTable(1)" style="cursor: pointer; white-space: nowrap; min-width: 140px;">Version <i class="fas fa-sort"></i></th>
                                <th onclick="sortPackagesTable(2)" style="cursor: pointer; white-space: nowrap; min-width: 100px;">Architecture <i class="fas fa-sort"></i></th>
                                <th onclick="sortPackagesTable(3)" style="cursor: pointer; white-space: nowrap; min-width: 90px;">Status <i class="fas fa-sort"></i></th>
                                <th onclick="sortPackagesTable(4)" style="cursor: pointer; white-space: nowrap; min-width: 80px;">Priority <i class="fas fa-sort"></i></th>
                                <th style="word-wrap: break-word; max-width: 300px;">Description</th>
                            </tr>
                        </thead>
                        <tbody id="packagesTableBody">
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-3 d-flex justify-content-between align-items-center">
                    <small class="text-muted" id="packagesCount">Showing ${totalPackages} packages</small>
                    <small class="text-muted">Source: ${data.file || 'N/A'}</small>
                </div>
            </div>
        </div>
    `;
    
    contentArea.innerHTML = html;
    
    // Store original data for filtering and export
    window.originalPackagesData = packages;
    
    // Initial render
    filterPackages();
}

function getStatusBadgeClass(status) {
    switch(status.toLowerCase()) {
        case 'installed': return 'badge-success';
        case 'config-files': return 'badge-warning';
        case 'not-installed': return 'badge-secondary';
        default: return 'badge-info';
    }
}

function getPriorityBadgeClass(priority) {
    switch(priority.toLowerCase()) {
        case 'required': return 'badge-danger';
        case 'important': return 'badge-warning';
        case 'standard': return 'badge-primary';
        case 'optional': return 'badge-info';
        case 'extra': return 'badge-secondary';
        default: return 'badge-light';
    }
}

function filterPackages() {
    if (!window.originalPackagesData) return;
    
    const searchTerm = document.getElementById('packageSearch').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const priorityFilter = document.getElementById('priorityFilter').value;
    const entryLimit = document.getElementById('entryLimit').value;
    
    let filteredPackages = window.originalPackagesData.filter(pkg => {
        const matchesSearch = !searchTerm || 
            pkg.name.toLowerCase().includes(searchTerm) ||
            pkg.description.toLowerCase().includes(searchTerm);
        const matchesStatus = !statusFilter || pkg.status === statusFilter;
        const matchesPriority = !priorityFilter || pkg.priority === priorityFilter;
        
        return matchesSearch && matchesStatus && matchesPriority;
    });
    
    // Apply entry limit
    const totalFiltered = filteredPackages.length;
    if (entryLimit !== 'all') {
        const limit = parseInt(entryLimit);
        filteredPackages = filteredPackages.slice(0, limit);
    }
    
    const tbody = document.getElementById('packagesTableBody');
    tbody.innerHTML = '';
    
    filteredPackages.forEach(pkg => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px;" title="${pkg.name}"><strong>${pkg.name}</strong></td>
            <td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px;" title="${pkg.version}">${pkg.version}</td>
            <td style="white-space: nowrap; text-align: center;">${pkg.architecture}</td>
            <td style="text-align: center;"><span class="badge ${getStatusBadgeClass(pkg.status)}">${pkg.status}</span></td>
            <td style="text-align: center;"><span class="badge ${getPriorityBadgeClass(pkg.priority)}">${pkg.priority}</span></td>
            <td style="word-wrap: break-word; max-width: 300px; white-space: normal; overflow-wrap: break-word;" title="${pkg.description}">${pkg.description}</td>
        `;
    });
    
    // Update count
    const countElement = document.getElementById('packagesCount');
    if (countElement) {
        if (entryLimit !== 'all' && totalFiltered > parseInt(entryLimit)) {
            countElement.textContent = `Showing ${filteredPackages.length} of ${totalFiltered} filtered packages (${window.originalPackagesData.length} total)`;
        } else {
            countElement.textContent = `Showing ${filteredPackages.length} of ${window.originalPackagesData.length} packages`;
        }
    }
}

function clearPackageFilters() {
    document.getElementById('packageSearch').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('priorityFilter').value = '';
    document.getElementById('entryLimit').value = '150';
    filterPackages();
}

function exportPackages() {
    if (!window.originalPackagesData || window.originalPackagesData.length === 0) {
        alert('No packages data available to export.');
        return;
    }
    
    // Create CSV content
    const headers = ['Name', 'Version', 'Architecture', 'Status', 'Priority', 'Description'];
    let csvContent = headers.join(',') + '\n';
    
    window.originalPackagesData.forEach(pkg => {
        const row = [
            pkg.name || '',
            pkg.version || '',
            pkg.architecture || '',
            pkg.status || '',
            pkg.priority || '',
            (pkg.description || '').replace(/"/g, '""')
        ];
        csvContent += row.map(field => `"${field}"`).join(',') + '\n';
    });
    
    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `installed_packages_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function renderSoftwareInstallations(data) {
    const contentArea = document.getElementById('content-area');
    
    let html = `
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="h4 mb-3">
                    <i class="fas fa-download me-2"></i>Installation Records
                </h2>
            </div>
        </div>
        
        <!-- Installation Analysis Guide -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white py-2">
                        <h6 class="m-0">
                            <i class="fas fa-info-circle me-2"></i>Installation Analysis Guide
                            <button class="btn btn-sm btn-outline-light float-end" type="button" data-bs-toggle="collapse" data-bs-target="#installationGuide" aria-expanded="false">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </h6>
                    </div>
                    <div class="collapse" id="installationGuide">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-info"><i class="fas fa-search me-2"></i>What to Look For</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><strong>Recent Installations:</strong> Check for packages installed around the time of suspicious activity</li>
                                        <li class="mb-2"><strong>Unusual Packages:</strong> Look for packages that don't belong in the environment</li>
                                        <li class="mb-2"><strong>Installation Patterns:</strong> Multiple packages installed in quick succession</li>
                                        <li class="mb-2"><strong>Source Files:</strong> Verify the legitimacy of installation sources</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-info"><i class="fas fa-shield-alt me-2"></i>Security Indicators</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><strong>Malicious Tools:</strong> Hacking tools, backdoors, or rootkits</li>
                                        <li class="mb-2"><strong>Persistence Mechanisms:</strong> Software designed to maintain access</li>
                                        <li class="mb-2"><strong>Data Theft Tools:</strong> File transfer or data exfiltration utilities</li>
                                        <li class="mb-2"><strong>System Modifications:</strong> Packages that alter system behavior</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <small class="text-muted">
                                        <i class="fas fa-lightbulb me-1"></i>
                                        <strong>Investigation Tips:</strong> Focus on installation timestamps, correlate with system events, 
                                        verify package authenticity, and check for unusual installation sources or methods.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    if (!data || !data.installations || data.installations.length === 0) {
        html += '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No installation records data available</div>';
        contentArea.innerHTML = html;
        return;
    }

    const installations = data.installations;
    const totalInstallations = installations.length;
    const installActions = installations.filter(inst => inst.action === 'install').length;
    const upgradeActions = installations.filter(inst => inst.action === 'upgrade').length;
    const removeActions = installations.filter(inst => inst.action === 'remove').length;
    
    // Analytics Cards Section
    html += `
        <!-- Installation Statistics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card border-primary h-100">
                    <div class="card-body text-center">
                        <div class="d-flex align-items-center justify-content-center mb-2">
                            <i class="fas fa-download fa-2x text-primary me-2"></i>
                            <div>
                                <h4 class="mb-0 text-primary">${totalInstallations}</h4>
                                <small class="text-muted">Total Records</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-success h-100">
                    <div class="card-body text-center">
                        <div class="d-flex align-items-center justify-content-center mb-2">
                            <i class="fas fa-plus-circle fa-2x text-success me-2"></i>
                            <div>
                                <h4 class="mb-0 text-success">${installActions}</h4>
                                <small class="text-muted">Installs</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-warning h-100">
                    <div class="card-body text-center">
                        <div class="d-flex align-items-center justify-content-center mb-2">
                            <i class="fas fa-arrow-up fa-2x text-warning me-2"></i>
                            <div>
                                <h4 class="mb-0 text-warning">${upgradeActions}</h4>
                                <small class="text-muted">Upgrades</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-danger h-100">
                    <div class="card-body text-center">
                        <div class="d-flex align-items-center justify-content-center mb-2">
                            <i class="fas fa-minus-circle fa-2x text-danger me-2"></i>
                            <div>
                                <h4 class="mb-0 text-danger">${removeActions}</h4>
                                <small class="text-muted">Removals</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Installation Filters -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white py-2">
                        <h6 class="m-0">
                            <i class="fas fa-filter me-2"></i>Installation Filters
                            <button class="btn btn-sm btn-outline-light float-end" type="button" data-bs-toggle="collapse" data-bs-target="#installationFilters" aria-expanded="true">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </h6>
                    </div>
                    <div class="collapse show" id="installationFilters">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <label for="installationSearch" class="form-label">Search Records</label>
                                    <input type="text" class="form-control" id="installationSearch" placeholder="Search by package name..." onkeyup="filterInstallations()">
                                </div>
                                <div class="col-md-2">
                                    <label for="actionFilter" class="form-label">Action</label>
                                    <select class="form-select" id="actionFilter" onchange="filterInstallations()">
                                        <option value="">All Actions</option>
                                        <option value="install">Install</option>
                                        <option value="upgrade">Upgrade</option>
                                        <option value="remove">Remove</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="architectureFilter" class="form-label">Architecture</label>
                                    <select class="form-select" id="architectureFilter" onchange="filterInstallations()">
                                        <option value="">All Architectures</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="installationEntryLimit" class="form-label">Show Entries</label>
                                    <select class="form-select" id="installationEntryLimit" onchange="filterInstallations()">
                                        <option value="100">100</option>
                                        <option value="250">250</option>
                                        <option value="500">500</option>
                                        <option value="1000">1000</option>
                                        <option value="all">All</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-secondary" onclick="clearInstallationFilters()">
                                            <i class="fas fa-times me-1"></i>Clear
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="exportFilteredInstallations()">
                                            <i class="fas fa-download me-1"></i>Export
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Installation Records Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-light py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="m-0">
                                <i class="fas fa-table me-2"></i>Installation Records
                            </h6>
                            <div class="d-flex align-items-center gap-3">
                                <span class="badge bg-primary">Showing: <span id="installationShowingCount">${Math.min(100, totalInstallations)}</span></span>
                                <span class="badge bg-info">Total: <span id="installationTotalCount">${totalInstallations}</span></span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <div id="installationsTable"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    contentArea.innerHTML = html;
    
    // Store original data for filtering
    window.originalInstallationsData = installations;
    
    // Populate architecture filter
    const architectures = [...new Set(installations.map(inst => inst.architecture).filter(arch => arch && arch !== 'unknown'))];
    const archFilter = document.getElementById('architectureFilter');
    architectures.forEach(arch => {
        const option = document.createElement('option');
        option.value = arch;
        option.textContent = arch;
        archFilter.appendChild(option);
    });
    
    // Render initial table
    renderInstallationsTable(installations);
}

function renderInstallationsTable(installations, searchTerm = '', action = '', architecture = '', limit = 100) {
    const container = document.getElementById('installationsTable');
    
    if (!installations || installations.length === 0) {
        container.innerHTML = '<div class="text-center p-4"><i class="fas fa-info-circle me-2"></i>No installation records found</div>';
        return;
    }
    
    // Apply filters
    let filteredInstallations = installations;
    
    if (searchTerm) {
        filteredInstallations = filteredInstallations.filter(inst => 
            (inst.package_name && inst.package_name.toLowerCase().includes(searchTerm.toLowerCase())) ||
            (inst.package && inst.package.toLowerCase().includes(searchTerm.toLowerCase()))
        );
    }
    
    if (action) {
        filteredInstallations = filteredInstallations.filter(inst => inst.action === action);
    }
    
    if (architecture) {
        filteredInstallations = filteredInstallations.filter(inst => inst.architecture === architecture);
    }
    
    // Apply limit
    const displayedInstallations = limit === 'all' ? filteredInstallations : filteredInstallations.slice(0, parseInt(limit));
    
    // Update counters
    document.getElementById('installationShowingCount').textContent = displayedInstallations.length;
    document.getElementById('installationTotalCount').textContent = filteredInstallations.length;
    
    let html = `
        <table class="table table-striped table-hover mb-0" id="installationsTableData">
            <thead class="table-dark sticky-top">
                <tr>
                    <th onclick="sortInstallationsTable(0)" style="cursor: pointer;">
                        Timestamp <i class="fas fa-sort ms-1"></i>
                    </th>
                    <th onclick="sortInstallationsTable(1)" style="cursor: pointer;">
                        Action <i class="fas fa-sort ms-1"></i>
                    </th>
                    <th onclick="sortInstallationsTable(2)" style="cursor: pointer;">
                        Package <i class="fas fa-sort ms-1"></i>
                    </th>
                    <th onclick="sortInstallationsTable(3)" style="cursor: pointer;">
                        Version <i class="fas fa-sort ms-1"></i>
                    </th>
                    <th onclick="sortInstallationsTable(4)" style="cursor: pointer;">
                        Architecture <i class="fas fa-sort ms-1"></i>
                    </th>
                    <th onclick="sortInstallationsTable(5)" style="cursor: pointer;">
                        Source File <i class="fas fa-sort ms-1"></i>
                    </th>
                </tr>
            </thead>
            <tbody>
    `;
    
    displayedInstallations.forEach(inst => {
        const timestamp = inst.timestamp ? new Date(inst.timestamp * 1000).toLocaleString() : 'Unknown';
        const actionBadge = getActionBadge(inst.action);
        
        html += `
            <tr>
                <td><small class="text-muted">${timestamp}</small></td>
                <td>${actionBadge}</td>
                <td>
                    <strong>${inst.package_name || inst.package || 'Unknown'}</strong>
                </td>
                <td><code class="small">${inst.version || 'Unknown'}</code></td>
                <td><span class="badge bg-secondary">${inst.architecture || 'Unknown'}</span></td>
                <td><small class="text-muted">${inst.source_file || 'Unknown'}</small></td>
            </tr>
        `;
    });
    
    html += `
            </tbody>
        </table>
    `;
    
    container.innerHTML = html;
}

function getActionBadge(action) {
    switch(action) {
        case 'install':
            return '<span class="badge bg-success"><i class="fas fa-plus me-1"></i>Install</span>';
        case 'upgrade':
            return '<span class="badge bg-warning"><i class="fas fa-arrow-up me-1"></i>Upgrade</span>';
        case 'remove':
            return '<span class="badge bg-danger"><i class="fas fa-minus me-1"></i>Remove</span>';
        default:
            return '<span class="badge bg-secondary"><i class="fas fa-question me-1"></i>' + (action || 'Unknown') + '</span>';
    }
}

function filterInstallations() {
    const searchTerm = document.getElementById('installationSearch').value;
    const action = document.getElementById('actionFilter').value;
    const architecture = document.getElementById('architectureFilter').value;
    const limit = document.getElementById('installationEntryLimit').value;
    
    renderInstallationsTable(window.originalInstallationsData, searchTerm, action, architecture, limit);
}

function clearInstallationFilters() {
    document.getElementById('installationSearch').value = '';
    document.getElementById('actionFilter').value = '';
    document.getElementById('architectureFilter').value = '';
    document.getElementById('installationEntryLimit').value = '100';
    
    filterInstallations();
}

function exportFilteredInstallations() {
    const searchTerm = document.getElementById('installationSearch').value;
    const action = document.getElementById('actionFilter').value;
    const architecture = document.getElementById('architectureFilter').value;
    
    let filteredInstallations = window.originalInstallationsData;
    
    if (searchTerm) {
        filteredInstallations = filteredInstallations.filter(inst => 
            (inst.package_name && inst.package_name.toLowerCase().includes(searchTerm.toLowerCase())) ||
            (inst.package && inst.package.toLowerCase().includes(searchTerm.toLowerCase()))
        );
    }
    
    if (action) {
        filteredInstallations = filteredInstallations.filter(inst => inst.action === action);
    }
    
    if (architecture) {
        filteredInstallations = filteredInstallations.filter(inst => inst.architecture === architecture);
    }
    
    // Create CSV content
    const headers = ['Timestamp', 'Action', 'Package', 'Version', 'Architecture', 'Source File'];
    let csvContent = headers.join(',') + '\n';
    
    filteredInstallations.forEach(inst => {
        const timestamp = inst.timestamp ? new Date(inst.timestamp * 1000).toISOString() : 'Unknown';
        const row = [
            timestamp,
            inst.action || 'Unknown',
            inst.package_name || inst.package || 'Unknown',
            inst.version || 'Unknown',
            inst.architecture || 'Unknown',
            inst.source_file || 'Unknown'
        ];
        csvContent += row.map(field => `"${field}"`).join(',') + '\n';
    });
    
    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `installation_records_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function sortInstallationsTable(columnIndex) {
    if (!window.originalInstallationsData) return;
    
    const table = document.getElementById('installationsTableData');
    const tbody = table.getElementsByTagName('tbody')[0];
    const rows = Array.from(tbody.getElementsByTagName('tr'));
    
    // Determine sort direction
    const currentSort = table.getAttribute('data-sort-column');
    const currentDirection = table.getAttribute('data-sort-direction') || 'asc';
    const newDirection = (currentSort == columnIndex && currentDirection === 'asc') ? 'desc' : 'asc';
    
    // Sort rows
    rows.sort((a, b) => {
        const aText = a.cells[columnIndex].textContent.trim();
        const bText = b.cells[columnIndex].textContent.trim();
        
        let comparison = 0;
        if (aText < bText) comparison = -1;
        else if (aText > bText) comparison = 1;
        
        return newDirection === 'asc' ? comparison : -comparison;
    });
    
    // Clear tbody and append sorted rows
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
    
    // Update sort indicators
    table.setAttribute('data-sort-column', columnIndex);
    table.setAttribute('data-sort-direction', newDirection);
    
    // Update header icons
    const headers = table.getElementsByTagName('th');
    for (let i = 0; i < headers.length; i++) {
        const icon = headers[i].querySelector('i');
        if (icon) {
            if (i == columnIndex) {
                icon.className = newDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
            } else {
                icon.className = 'fas fa-sort';
            }
        }
    }
}

function renderSoftwareUpgradations(data) {
    const contentArea = document.getElementById('content-area');
    
    if (!data || !data.upgradations) {
        contentArea.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i>
                Error loading upgrade records: No upgrade data available
            </div>
        `;
        return;
    }

    const upgradations = data.upgradations || [];
    window.originalUpgradationsData = upgradations;

    // Calculate statistics
    const totalUpgrades = upgradations.length;
    const upgradeActions = upgradations.filter(up => up.action === 'upgrade').length;
    const configureActions = upgradations.filter(up => up.action === 'configure').length;
    const otherActions = totalUpgrades - upgradeActions - configureActions;

    // Get unique architectures for filter
    const architectures = [...new Set(upgradations.map(up => up.architecture).filter(arch => arch && arch !== 'unknown'))];

    contentArea.innerHTML = `
        <div class="analysis-section">
            <div class="section-header">
                <h3><i class="fas fa-arrow-up"></i> Upgrade Records Analysis</h3>
                <p class="text-muted">Analysis of package upgrades from ${data.file || 'upgrade records'}</p>
            </div>

            <!-- Upgradations Analysis Guide -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-info">
                        <div class="card-header bg-info text-white py-2">
                            <h6 class="m-0">
                                <i class="fas fa-info-circle me-2"></i>Upgradations Analysis Guide
                                <button class="btn btn-sm btn-outline-light float-end" type="button" data-bs-toggle="collapse" data-bs-target="#upgradationsGuide" aria-expanded="false">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </h6>
                        </div>
                        <div class="collapse" id="upgradationsGuide">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-info"><i class="fas fa-search me-2"></i>What to Look For</h6>
                                        <ul class="list-unstyled">
                                            <li class="mb-2"><strong>Recent Upgrades:</strong> Check for packages upgraded around the time of suspicious activity</li>
                                            <li class="mb-2"><strong>Critical Packages:</strong> Focus on system-critical packages (kernel, security libraries, system services)</li>
                                            <li class="mb-2"><strong>Version Jumps:</strong> Look for major version changes that might introduce vulnerabilities</li>
                                            <li class="mb-2"><strong>Timing Patterns:</strong> Analyze upgrade timing to understand maintenance windows or incident response</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-info"><i class="fas fa-shield-alt me-2"></i>Security Indicators</h6>
                                        <ul class="list-unstyled">
                                            <li class="mb-2"><strong>Security Patches:</strong> Upgrades that address known vulnerabilities or security issues</li>
                                            <li class="mb-2"><strong>Unusual Upgrades:</strong> Packages upgraded outside normal maintenance windows</li>
                                            <li class="mb-2"><strong>Downgrade Attempts:</strong> Any attempts to downgrade packages to vulnerable versions</li>
                                            <li class="mb-2"><strong>System Modifications:</strong> Upgrades that significantly alter system behavior or security posture</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <small class="text-muted">
                                            <i class="fas fa-lightbulb me-1"></i>
                                            <strong>Investigation Tips:</strong> Correlate upgrade timestamps with system events, verify upgrade sources and authenticity, 
                                            check for failed or incomplete upgrades, and review configuration changes that occurred during upgrades.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0">${totalUpgrades}</h4>
                                    <small>Total Records</small>
                                </div>
                                <i class="fas fa-list fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0">${upgradeActions}</h4>
                                    <small>Upgrades</small>
                                </div>
                                <i class="fas fa-arrow-up fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0">${configureActions}</h4>
                                    <small>Configurations</small>
                                </div>
                                <i class="fas fa-cog fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0">${otherActions}</h4>
                                    <small>Other Actions</small>
                                </div>
                                <i class="fas fa-question fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-filter"></i> Filters</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="upgradationSearch" class="form-label">Search Package:</label>
                            <input type="text" id="upgradationSearch" class="form-control" placeholder="Search by package name..." oninput="filterUpgradations()">
                        </div>
                        <div class="col-md-2">
                            <label for="upgradationAction" class="form-label">Action:</label>
                            <select id="upgradationAction" class="form-select" onchange="filterUpgradations()">
                                <option value="">All Actions</option>
                                <option value="upgrade">Upgrade</option>
                                <option value="configure">Configure</option>
                                <option value="install">Install</option>
                                <option value="remove">Remove</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="upgradationArchitecture" class="form-label">Architecture:</label>
                            <select id="upgradationArchitecture" class="form-select" onchange="filterUpgradations()">
                                <option value="">All Architectures</option>
                                ${architectures.map(arch => `<option value="${arch}">${arch}</option>`).join('')}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="upgradationLimit" class="form-label">Show Entries:</label>
                            <select id="upgradationLimit" class="form-select" onchange="filterUpgradations()">
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="250">250</option>
                                <option value="500">500</option>
                                <option value="all">All</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-secondary" onclick="clearUpgradationFilters()">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                                <button class="btn btn-outline-primary" onclick="exportFilteredUpgradations()">
                                    <i class="fas fa-download"></i> Export CSV
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upgradations Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-table"></i> Upgrade Records</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="upgradationsTableData">
                            <thead class="table-dark">
                                <tr>
                                    <th onclick="sortUpgradationsTable(0)" style="cursor: pointer;">
                                        Timestamp <i class="fas fa-sort"></i>
                                    </th>
                                    <th onclick="sortUpgradationsTable(1)" style="cursor: pointer;">
                                        Action <i class="fas fa-sort"></i>
                                    </th>
                                    <th onclick="sortUpgradationsTable(2)" style="cursor: pointer;">
                                        Package <i class="fas fa-sort"></i>
                                    </th>
                                    <th onclick="sortUpgradationsTable(3)" style="cursor: pointer;">
                                        Old Version <i class="fas fa-sort"></i>
                                    </th>
                                    <th onclick="sortUpgradationsTable(4)" style="cursor: pointer;">
                                        New Version <i class="fas fa-sort"></i>
                                    </th>
                                    <th onclick="sortUpgradationsTable(5)" style="cursor: pointer;">
                                        Architecture <i class="fas fa-sort"></i>
                                    </th>
                                    <th onclick="sortUpgradationsTable(6)" style="cursor: pointer;">
                                        Source File <i class="fas fa-sort"></i>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                ${renderUpgradationsTable(upgradations)}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function renderUpgradationsTable(upgradations) {
    if (!upgradations || upgradations.length === 0) {
        return '<tr><td colspan="7" class="text-center text-muted">No upgrade records found</td></tr>';
    }

    return upgradations.map(upgrade => {
        const timestamp = upgrade.timestamp ? new Date(upgrade.timestamp * 1000).toLocaleString() : 'Unknown';
        const actionBadge = getUpgradeActionBadge(upgrade.action);
        
        return `
            <tr>
                <td>${timestamp}</td>
                <td>${actionBadge}</td>
                <td><code>${upgrade.package_name || upgrade.package || 'Unknown'}</code></td>
                <td><span class="badge bg-secondary">${upgrade.old_version || 'Unknown'}</span></td>
                <td><span class="badge bg-primary">${upgrade.new_version || 'Unknown'}</span></td>
                <td>${upgrade.architecture || 'Unknown'}</td>
                <td><small class="text-muted">${upgrade.source_file || 'Unknown'}</small></td>
            </tr>
        `;
    }).join('');
}

function getUpgradeActionBadge(action) {
    const badges = {
        'upgrade': '<span class="badge bg-success"><i class="fas fa-arrow-up"></i> Upgrade</span>',
        'configure': '<span class="badge bg-info"><i class="fas fa-cog"></i> Configure</span>',
        'install': '<span class="badge bg-primary"><i class="fas fa-plus"></i> Install</span>',
        'remove': '<span class="badge bg-danger"><i class="fas fa-minus"></i> Remove</span>'
    };
    return badges[action] || `<span class="badge bg-secondary">${action || 'Unknown'}</span>`;
}

function filterUpgradations() {
    if (!window.originalUpgradationsData) return;
    
    const searchTerm = document.getElementById('upgradationSearch').value;
    const action = document.getElementById('upgradationAction').value;
    const architecture = document.getElementById('upgradationArchitecture').value;
    const limit = document.getElementById('upgradationLimit').value;
    
    let filteredUpgradations = window.originalUpgradationsData;
    
    // Apply filters
    if (searchTerm) {
        filteredUpgradations = filteredUpgradations.filter(upgrade => 
            (upgrade.package_name && upgrade.package_name.toLowerCase().includes(searchTerm.toLowerCase())) ||
            (upgrade.package && upgrade.package.toLowerCase().includes(searchTerm.toLowerCase()))
        );
    }
    
    if (action) {
        filteredUpgradations = filteredUpgradations.filter(upgrade => upgrade.action === action);
    }
    
    if (architecture) {
        filteredUpgradations = filteredUpgradations.filter(upgrade => upgrade.architecture === architecture);
    }
    
    // Apply limit
    if (limit !== 'all') {
        filteredUpgradations = filteredUpgradations.slice(0, parseInt(limit));
    }
    
    // Update table
    const tbody = document.querySelector('#upgradationsTableData tbody');
    tbody.innerHTML = renderUpgradationsTable(filteredUpgradations);
}

function clearUpgradationFilters() {
    document.getElementById('upgradationSearch').value = '';
    document.getElementById('upgradationAction').value = '';
    document.getElementById('upgradationArchitecture').value = '';
    document.getElementById('upgradationLimit').value = '50';
    filterUpgradations();
}

function exportFilteredUpgradations() {
    if (!window.originalUpgradationsData) return;
    
    const searchTerm = document.getElementById('upgradationSearch').value;
    const action = document.getElementById('upgradationAction').value;
    const architecture = document.getElementById('upgradationArchitecture').value;
    
    let filteredUpgradations = window.originalUpgradationsData;
    
    // Apply same filters as display
    if (searchTerm) {
        filteredUpgradations = filteredUpgradations.filter(upgrade => 
            (upgrade.package_name && upgrade.package_name.toLowerCase().includes(searchTerm.toLowerCase())) ||
            (upgrade.package && upgrade.package.toLowerCase().includes(searchTerm.toLowerCase()))
        );
    }
    
    if (action) {
        filteredUpgradations = filteredUpgradations.filter(upgrade => upgrade.action === action);
    }
    
    if (architecture) {
        filteredUpgradations = filteredUpgradations.filter(upgrade => upgrade.architecture === architecture);
    }
    
    // Create CSV content
    const headers = ['Timestamp', 'Action', 'Package', 'Old Version', 'New Version', 'Architecture', 'Source File'];
    let csvContent = headers.join(',') + '\n';
    
    filteredUpgradations.forEach(upgrade => {
        const timestamp = upgrade.timestamp ? new Date(upgrade.timestamp * 1000).toISOString() : 'Unknown';
        const row = [
            timestamp,
            upgrade.action || 'Unknown',
            upgrade.package_name || upgrade.package || 'Unknown',
            upgrade.old_version || 'Unknown',
            upgrade.new_version || 'Unknown',
            upgrade.architecture || 'Unknown',
            upgrade.source_file || 'Unknown'
        ];
        csvContent += row.map(field => `"${field}"`).join(',') + '\n';
    });
    
    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `upgrade_records_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function sortUpgradationsTable(columnIndex) {
    if (!window.originalUpgradationsData) return;
    
    const table = document.getElementById('upgradationsTableData');
    const tbody = table.getElementsByTagName('tbody')[0];
    const rows = Array.from(tbody.getElementsByTagName('tr'));
    
    // Determine sort direction
    const currentSort = table.getAttribute('data-sort-column');
    const currentDirection = table.getAttribute('data-sort-direction') || 'asc';
    const newDirection = (currentSort == columnIndex && currentDirection === 'asc') ? 'desc' : 'asc';
    
    // Sort rows
    rows.sort((a, b) => {
        const aText = a.cells[columnIndex].textContent.trim();
        const bText = b.cells[columnIndex].textContent.trim();
        
        let comparison = 0;
        if (aText < bText) comparison = -1;
        else if (aText > bText) comparison = 1;
        
        return newDirection === 'asc' ? comparison : -comparison;
    });
    
    // Clear tbody and append sorted rows
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
    
    // Update sort indicators
    table.setAttribute('data-sort-column', columnIndex);
    table.setAttribute('data-sort-direction', newDirection);
    
    // Update header icons
    const headers = table.getElementsByTagName('th');
    for (let i = 0; i < headers.length; i++) {
        const icon = headers[i].querySelector('i');
        if (icon) {
            if (i == columnIndex) {
                icon.className = newDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
            } else {
                icon.className = 'fas fa-sort';
            }
        }
    }
}

function renderSoftwareRemoval(data) {
    const contentArea = document.getElementById('content-area');
    
    if (!data || !data.removals) {
        contentArea.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i>
                Error loading removal records: No removal data available
            </div>
        `;
        return;
    }

    const removals = data.removals || [];
    const totalRemovals = data.total_removals || removals.length;
    const filename = data.filename || 'Unknown';
    
    // Store original data for filtering and sorting
    window.originalRemovalData = removals;
    window.filteredRemovalData = [...removals];
    
    // Calculate statistics
    const actionStats = {};
    removals.forEach(removal => {
        const action = removal.action || 'Unknown';
        actionStats[action] = (actionStats[action] || 0) + 1;
    });
    
    // Generate analysis guide content
    const analysisGuide = `
        <div class="analysis-guide">
            <h5><i class="fas fa-lightbulb text-warning"></i> Software Removal Analysis Guide</h5>
            <div class="guide-content">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-search"></i> What to Look For:</h6>
                        <ul class="guide-list">
                            <li><strong>Suspicious Removals:</strong> Critical system packages or security tools being removed</li>
                            <li><strong>Timing Patterns:</strong> Multiple removals in short time periods</li>
                            <li><strong>Package Types:</strong> Focus on security, monitoring, or system packages</li>
                            <li><strong>User Context:</strong> Removals by non-administrative users</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-exclamation-triangle"></i> Red Flags:</h6>
                        <ul class="guide-list">
                            <li><strong>Security Tools:</strong> Antivirus, firewalls, or monitoring software</li>
                            <li><strong>System Libraries:</strong> Core system components being removed</li>
                            <li><strong>Logging Tools:</strong> Audit or logging packages being uninstalled</li>
                            <li><strong>Bulk Removals:</strong> Many packages removed simultaneously</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    contentArea.innerHTML = `
        <div class="section-header">
            <h2><i class="fas fa-trash-alt"></i> Software Removal Analysis</h2>
            <p class="text-muted">Analysis of software package removals from system logs</p>
        </div>
        
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-icon bg-danger">
                        <i class="fas fa-trash-alt"></i>
                    </div>
                    <div class="stat-content">
                        <h3>${totalRemovals.toLocaleString()}</h3>
                        <p>Total Removals</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-icon bg-warning">
                        <i class="fas fa-list"></i>
                    </div>
                    <div class="stat-content">
                        <h3>${Object.keys(actionStats).length}</h3>
                        <p>Action Types</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-icon bg-info">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="stat-content">
                        <h3>1</h3>
                        <p>Source Files</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-icon bg-secondary">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-content">
                        <h3>${removals.length > 0 ? new Date(removals[0].timestamp).toLocaleDateString() : 'N/A'}</h3>
                        <p>Latest Activity</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Analysis Guide -->
        <div class="card mb-4">
            <div class="card-header" data-bs-toggle="collapse" data-bs-target="#analysisGuideRemoval" style="cursor: pointer;">
                <h5 class="mb-0">
                    <i class="fas fa-chevron-down"></i>
                    Analysis Guide
                </h5>
            </div>
            <div id="analysisGuideRemoval" class="collapse">
                <div class="card-body">
                    ${analysisGuide}
                </div>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-filter"></i> Filters</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label for="actionFilterRemoval" class="form-label">Action:</label>
                        <select id="actionFilterRemoval" class="form-select" onchange="filterRemovals()">
                            <option value="">All Actions</option>
                            ${Object.keys(actionStats).map(action => 
                                `<option value="${action}">${action} (${actionStats[action]})</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="architectureFilterRemoval" class="form-label">Architecture:</label>
                        <select id="architectureFilterRemoval" class="form-select" onchange="filterRemovals()">
                            <option value="">All Architectures</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="entriesPerPageRemoval" class="form-label">Show entries:</label>
                        <select id="entriesPerPageRemoval" class="form-select" onchange="filterRemovals()">
                            <option value="10">10</option>
                            <option value="25" selected>25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="-1">All</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-secondary me-2" onclick="clearRemovalFilters()">Clear Filters</button>
                        <button class="btn btn-primary" onclick="exportFilteredRemovals()">Export CSV</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Removal Records Table -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-table"></i> Removal Records</h5>
                <small class="text-muted">Source: ${filename}</small>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="removalsTable">
                        <thead class="table-dark">
                            <tr>
                                <th onclick="sortRemovalsTable(0)" style="cursor: pointer;">
                                    Timestamp <i class="fas fa-sort"></i>
                                </th>
                                <th onclick="sortRemovalsTable(1)" style="cursor: pointer;">
                                    Action <i class="fas fa-sort"></i>
                                </th>
                                <th onclick="sortRemovalsTable(2)" style="cursor: pointer;">
                                    Package <i class="fas fa-sort"></i>
                                </th>
                                <th onclick="sortRemovalsTable(3)" style="cursor: pointer;">
                                    Old Version <i class="fas fa-sort"></i>
                                </th>
                                <th onclick="sortRemovalsTable(4)" style="cursor: pointer;">
                                    New Version <i class="fas fa-sort"></i>
                                </th>
                                <th onclick="sortRemovalsTable(5)" style="cursor: pointer;">
                                    Architecture <i class="fas fa-sort"></i>
                                </th>
                                <th onclick="sortRemovalsTable(6)" style="cursor: pointer;">
                                    Source File <i class="fas fa-sort"></i>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="removalsTableBody">
                        </tbody>
                    </table>
                </div>
                <div id="removalsPagination" class="d-flex justify-content-between align-items-center mt-3">
                    <div id="removalsInfo"></div>
                    <div id="removalsPaginationControls"></div>
                </div>
            </div>
        </div>
    `;
    
    // Populate architecture filter
    const architectures = [...new Set(removals.map(r => r.architecture).filter(a => a))];
    const archFilter = document.getElementById('architectureFilterRemoval');
    architectures.forEach(arch => {
        const option = document.createElement('option');
        option.value = arch;
        option.textContent = arch;
        archFilter.appendChild(option);
    });
    
    // Initial render
    filterRemovals();
}

function renderRemovalsTable(removals, page = 1, entriesPerPage = 25) {
    const tableBody = document.getElementById('removalsTableBody');
    const startIndex = entriesPerPage === -1 ? 0 : (page - 1) * entriesPerPage;
    const endIndex = entriesPerPage === -1 ? removals.length : startIndex + entriesPerPage;
    const pageRemovals = removals.slice(startIndex, endIndex);
    
    tableBody.innerHTML = pageRemovals.map(removal => `
        <tr>
            <td>${new Date(removal.timestamp).toLocaleString()}</td>
            <td>${getRemovalActionBadge(removal.action)}</td>
            <td><code>${removal.package || 'N/A'}</code></td>
            <td><span class="badge bg-secondary">${removal.old_version || 'N/A'}</span></td>
            <td><span class="badge bg-primary">${removal.new_version || 'N/A'}</span></td>
            <td>${removal.architecture || 'N/A'}</td>
            <td><small class="text-muted">${removal.source_file || 'N/A'}</small></td>
        </tr>
    `).join('');
    
    // Update pagination info
    const totalEntries = removals.length;
    const showingStart = entriesPerPage === -1 ? 1 : startIndex + 1;
    const showingEnd = entriesPerPage === -1 ? totalEntries : Math.min(endIndex, totalEntries);
    
    document.getElementById('removalsInfo').innerHTML = 
        `Showing ${showingStart} to ${showingEnd} of ${totalEntries} entries`;
}

function getRemovalActionBadge(action) {
    const badgeMap = {
        'remove': 'bg-danger',
        'purge': 'bg-warning',
        'autoremove': 'bg-info',
        'uninstall': 'bg-secondary'
    };
    const badgeClass = badgeMap[action?.toLowerCase()] || 'bg-secondary';
    return `<span class="badge ${badgeClass}">${action || 'Unknown'}</span>`;
}

function filterRemovals() {
    if (!window.originalRemovalData) return;
    
    const actionFilter = document.getElementById('actionFilterRemoval').value;
    const archFilter = document.getElementById('architectureFilterRemoval').value;
    const entriesPerPage = parseInt(document.getElementById('entriesPerPageRemoval').value);
    
    let filtered = window.originalRemovalData.filter(removal => {
        const actionMatch = !actionFilter || removal.action === actionFilter;
        const archMatch = !archFilter || removal.architecture === archFilter;
        return actionMatch && archMatch;
    });
    
    window.filteredRemovalData = filtered;
    renderRemovalsTable(filtered, 1, entriesPerPage);
}

function clearRemovalFilters() {
    document.getElementById('actionFilterRemoval').value = '';
    document.getElementById('architectureFilterRemoval').value = '';
    document.getElementById('entriesPerPageRemoval').value = '25';
    filterRemovals();
}

function exportFilteredRemovals() {
    if (!window.filteredRemovalData || window.filteredRemovalData.length === 0) {
        alert('No data to export');
        return;
    }
    
    const headers = ['Timestamp', 'Action', 'Package', 'Old Version', 'New Version', 'Architecture', 'Source File'];
    const csvContent = [
        headers.join(','),
        ...window.filteredRemovalData.map(removal => [
            `"${new Date(removal.timestamp).toLocaleString()}",`,
            `"${removal.action || ''}",`,
            `"${removal.package || ''}",`,
            `"${removal.old_version || ''}",`,
            `"${removal.new_version || ''}",`,
            `"${removal.architecture || ''}",`,
            `"${removal.source_file || ''}"`
        ].join(''))
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'software_removals.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function sortRemovalsTable(columnIndex) {
    if (!window.filteredRemovalData) return;
    
    const table = document.getElementById('removalsTable');
    const currentSort = table.getAttribute('data-sort-column');
    const currentDirection = table.getAttribute('data-sort-direction') || 'asc';
    const newDirection = (currentSort == columnIndex && currentDirection === 'asc') ? 'desc' : 'asc';
    
    const columnMap = {
        0: 'timestamp',
        1: 'action', 
        2: 'package',
        3: 'old_version',
        4: 'new_version',
        5: 'architecture',
        6: 'source_file'
    };
    
    const sortKey = columnMap[columnIndex];
    
    window.filteredRemovalData.sort((a, b) => {
        let aVal = a[sortKey] || '';
        let bVal = b[sortKey] || '';
        
        if (sortKey === 'timestamp') {
            aVal = new Date(aVal).getTime();
            bVal = new Date(bVal).getTime();
        }
        
        let comparison = 0;
        if (aVal < bVal) comparison = -1;
        else if (aVal > bVal) comparison = 1;
        
        return newDirection === 'asc' ? comparison : -comparison;
    });
    
    table.setAttribute('data-sort-column', columnIndex);
    table.setAttribute('data-sort-direction', newDirection);
    
    const entriesPerPage = parseInt(document.getElementById('entriesPerPageRemoval').value);
    renderRemovalsTable(window.filteredRemovalData, 1, entriesPerPage);
    
    // Update header icons
    const headers = table.getElementsByTagName('th');
    for (let i = 0; i < headers.length; i++) {
        const icon = headers[i].querySelector('i');
        if (icon) {
            if (i == columnIndex) {
                icon.className = newDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
            } else {
                icon.className = 'fas fa-sort';
            }
        }
    }
}

function sortPackagesTable(columnIndex) {
    if (!window.originalPackagesData) return;
    
    const table = document.getElementById('packagesTable');
    const tbody = table.getElementsByTagName('tbody')[0];
    const rows = Array.from(tbody.getElementsByTagName('tr'));
    
    // Determine sort direction
    const currentSort = table.getAttribute('data-sort-column');
    const currentDirection = table.getAttribute('data-sort-direction') || 'asc';
    const newDirection = (currentSort == columnIndex && currentDirection === 'asc') ? 'desc' : 'asc';
    
    // Sort rows
    rows.sort((a, b) => {
        const aText = a.cells[columnIndex].textContent.trim();
        const bText = b.cells[columnIndex].textContent.trim();
        
        let comparison = 0;
        if (aText < bText) comparison = -1;
        else if (aText > bText) comparison = 1;
        
        return newDirection === 'asc' ? comparison : -comparison;
    });
    
    // Clear tbody and append sorted rows
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
    
    // Update sort indicators
    table.setAttribute('data-sort-column', columnIndex);
    table.setAttribute('data-sort-direction', newDirection);
    
    // Update header icons
    const headers = table.getElementsByTagName('th');
    for (let i = 0; i < headers.length; i++) {
        const icon = headers[i].querySelector('i');
        if (icon) {
            if (i == columnIndex) {
                icon.className = newDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
            } else {
                icon.className = 'fas fa-sort';
            }
        }
    }
}
</script>
{% endblock %}